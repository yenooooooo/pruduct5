<!DOCTYPE html>
<html lang="ko">
<head>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  <meta charset="UTF-8" />
  <title>HabitFlow</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pretendard @latest/dist/web/static/pretendard.css">
    <link href="https://fonts.googleapis.com/css2?family=Nanum+Myeongjo:wght@400;700;800&display=swap" rel="stylesheet">
    


</head>
<body>

  <header>
    <div class="container header-inner">
      <div class="logo">
        <div class="logo-badge"></div>
        HabitFlow
      </div>
      <nav>
        <a href="#features" class="pc-only">ê¸°ëŠ¥</a>
        <a href="#pricing" class="pc-only">ê°€ê²©</a>
        <button class="btn btn-primary" onclick="scrollToAuth()" style="padding: 8px 16px; font-size: 14px;">ì‹œì‘í•˜ê¸°</button>
        <button id="darkModeToggle" class="btn btn-ghost" style="padding: 8px;">ğŸŒ“</button>
      </nav>
    </div>
  </header>  

  <section class="hero">
    <div class="container hero-grid">
      <div class="hero-left">
        <span class="hero-pill">âœ¨ í•˜ë£¨ í•˜ë‚˜ë¡œ ì¶©ë¶„í•´ìš”</span>
        <h1 class="hero-title">í•˜ë£¨ í•˜ë‚˜,<br />ì¸ìƒì„ ë°”ê¾¸ëŠ” ìŠµê´€</h1>
        <p class="hero-desc">
          ì‘ì‹¬ì‚¼ì¼ì„ ëë‚´ëŠ” ê°€ì¥ ë‹¨ìˆœí•œ ë°©ì‹.<br />
          ë²„íŠ¼ í•œ ë²ˆìœ¼ë¡œ ê¸°ë¡í•˜ê³ , ì—°ì† ê¸°ë¡ìœ¼ë¡œ ë™ê¸°ë¶€ì—¬ë¥¼ ìœ ì§€í•˜ì„¸ìš”.
        </p>
        <div class="hero-actions">
          <button class="btn btn-primary" onclick="scrollToAuth()">ì§€ê¸ˆ ì‹œì‘í•˜ê¸°</button>
          <a href="#pricing" class="btn btn-ghost">ê°€ê²© ë³´ê¸°</a>
        </div>
        <div class="hero-metrics">
          <div class="metric-card"><b>1 Habit</b><span>í•˜ë£¨ ë”± í•˜ë‚˜</span></div>
          <div class="metric-card"><b>Streak</b><span>ì—°ì† ê¸°ë¡</span></div>
          <div class="metric-card"><b>Report</b><span>ì£¼ê°„ ë¦¬í¬íŠ¸</span></div>
        </div>
      </div>

      <div class="hero-right glass">
        <h3>ì˜¤ëŠ˜ì˜ ì¶”ì²œ ë£¨í‹´</h3>
        <p>ë¡œê·¸ì¸ í›„ í…Œë§ˆë¥¼ ì„ íƒí•˜ë©´ ì˜¤ëŠ˜ ìŠµê´€ì´ ìë™ìœ¼ë¡œ ì¶”ì²œë¼ìš”.</p>
        <div class="recommend-card">
          <div>ğŸš‘ <b>ìƒì¡´ ì²´ë ¥ íŒ©</b></div>
          <span style="font-size:12px; color:#555">ì§ì¥ì¸ì„ ìœ„í•œ â€œì£½ì§€ ì•Šìœ¼ë ¤ê³  í•˜ëŠ” ìš´ë™â€</span>
        </div>
        <div class="recommend-card">
          <div>âœ¨ <b>ê°“ìƒ ì…ë¬¸ íŒ©</b></div>
          <span style="font-size:12px; color:#555">ì„±ê³µ ë£¨í‹´ì„ 2ë¶„ì§œë¦¬ë¡œ ìª¼ê°œê¸°</span>
        </div>
      </div>
    </div>
  </section>

  <section class="problem">
    <div class="container">
      <div class="section-head">
        <span class="kicker">WHY</span>
        <h2>ì™œ ìŠµê´€ì€ í•­ìƒ ì‹¤íŒ¨í• ê¹Œ?</h2>
        <p>HabitFlowëŠ” â€œë”± 1ê°œë§Œ, ë²„íŠ¼ 1ë²ˆâ€ìœ¼ë¡œ ì‹¤í–‰ ì¥ë²½ì„ ìµœì†Œí™”í•©ë‹ˆë‹¤.</p>
      </div>
      <div class="problem-grid">
        <div class="problem-card glass">
          <h3>ğŸ¯ ëª©í‘œê°€ ë„ˆë¬´ ë§ë‹¤</h3>
          <p>ìš•ì‹¬ì´ ì»¤ì§ˆìˆ˜ë¡ ì‹œì‘ì´ ì–´ë ¤ì›Œì ¸ìš”. í•˜ë£¨ 1ê°œë§Œ ë‚¨ê¹ë‹ˆë‹¤.</p>
        </div>
        <div class="problem-card glass">
          <h3>ğŸ“ ê¸°ë¡ì´ ê·€ì°®ë‹¤</h3>
          <p>ê¸°ë¡ì´ ë²ˆê±°ë¡œìš°ë©´ í¬ê¸° í™•ë¥ ì´ ì˜¬ë¼ê°€ìš”. ë²„íŠ¼ í•œ ë²ˆì´ë©´ ë.</p>
        </div>
        <div class="problem-card glass">
          <h3>ğŸ“‰ ì„±ì·¨ê°€ ëˆˆì— ì•ˆ ë³´ì¸ë‹¤</h3>
          <p>ìŒ“ì´ëŠ” ëŠë‚Œì´ ì—†ìœ¼ë©´ ì§€ì†ì´ ì–´ë µì£ . ì—°ì† ê¸°ë¡ì„ ì¦‰ì‹œ ë³´ì—¬ì¤ë‹ˆë‹¤.</p>
        </div>
      </div>
    </div>
  </section>

  <section id="authSection" style="padding-top: 40px; min-height: 80vh;">
    <div class="container" style="display:flex; justify-content:center;">
      
      <div id="auth" class="auth-card glass">
        <h2>HabitFlow ì‹œì‘í•˜ê¸°</h2>
        <p style="color:var(--muted); margin-bottom:24px;">ì´ë©”ì¼ë¡œ ê°„í¸í•˜ê²Œ ì‹œì‘í•˜ì„¸ìš”</p>
        
        <input id="email" placeholder="ì´ë©”ì¼ ì£¼ì†Œ">
        <input id="password" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸ (6ì ì´ìƒ)">
        
        <div class="auth-actions">
           <button id="signupBtn" class="btn btn-primary" type="button">íšŒì›ê°€ì…</button>
           <button id="signinBtn" class="btn btn-ghost" type="button">ë¡œê·¸ì¸</button>
        </div>
        
        <div style="margin-top:16px;">
          <button id="resetPwBtn" class="link-btn" type="button">ë¹„ë°€ë²ˆí˜¸ ì°¾ê¸°</button>
        </div>
        
        <p id="authHint" style="margin-top:20px; font-size:13px; color:var(--muted);">
          ì²˜ìŒì´ë©´ <b>íšŒì›ê°€ì…</b> â†’ ë©”ì¼ ì¸ì¦ í›„ ë¡œê·¸ì¸í•˜ì„¸ìš”.
        </p>
      </div>

      <div id="app" class="glass" style="width:100%; max-width:480px; padding:30px; display:none; text-align:center;">
        <div style="display:flex; justify-content:space-between; align-items:center;">
          <h2 id="welcome" style="margin:0; font-size: 1.2rem;"></h2>
          <button id="logoutBtn" style="background:none; border:none; color:var(--muted); font-size:0.8rem; text-decoration:underline; cursor:pointer;">ë¡œê·¸ì•„ì›ƒ</button>
        </div>

        <div id="tierBadge" style="display:none; margin: 20px 0;">
          <span id="tierText" class="badge"></span>
          <p id="streakCount" style="font-size: 0.9rem; margin-top: 8px; font-weight:700;"></p>
        </div>

        <div id="themeSection" style="margin-top:24px;">
           <p style="font-size: 0.9rem; font-weight: 700; margin-bottom:10px;">ğŸ ì˜¤ëŠ˜ì˜ ë£¨í‹´ íŒ© ì„ íƒ</p>
           <div class="tag-container">
              <button class="theme-tag" onclick="selectTheme(this, 'survival')">ğŸš‘ ìƒì¡´</button>
              <button class="theme-tag" onclick="selectTheme(this, 'godsaeng')">âœ¨ ê°“ìƒ</button>
              <button class="theme-tag" onclick="selectTheme(this, 'detox')">ğŸ“± ë””í†¡ìŠ¤</button>
              <button class="theme-tag" onclick="selectTheme(this, 'custom')">â• ì»¤ìŠ¤í…€</button>
           </div>
        </div>
        
        <div id="todaySuggestion" style="margin-top:16px; font-size:0.9rem; padding:12px; background:rgba(99,102,241,0.1); border-radius:12px; color:var(--text-main);">
          í…Œë§ˆë¥¼ ì„ íƒí•˜ë©´ ì˜¤ëŠ˜ í•  ì¼ì´ ì¶”ì²œë©ë‹ˆë‹¤.
        </div>
        
        <input id="habitName" readonly value="í…Œë§ˆë¥¼ ì„ íƒí•˜ì„¸ìš”" style="margin-top: 20px; text-align: center; font-weight:700;">
        <button id="habitBtn" class="habit">ì˜¤ëŠ˜ ìŠµê´€ ì™„ë£Œ âœ…</button>
        <p id="status" style="margin-top:12px; font-size:14px; color:var(--primary); font-weight:700; min-height:20px;"></p>
        
        <div id="stats" style="display:none; margin-top:20px; padding:16px; background:rgba(255,255,255,0.5); border-radius:12px;">
          <h3 style="margin:0 0 10px; font-size:16px;">ğŸ“Š ë‚˜ì˜ ìŠµê´€ í†µê³„</h3>
          <p id="totalDays" style="margin:0; font-weight:700;"></p>
        </div>

        <button id="restoreStreakBtn" style="margin-top:10px; width:100%; padding:12px; border-radius:12px; background:#f59e0b; color:white; border:none; font-weight:800; display:none; cursor:pointer;">
          ğŸ”¥ ì—°ì† ê¸°ë¡ ë³µêµ¬ (PRO)
        </button>

        <div id="weeklyReport" style="display:none; width: 100%; margin-top: 30px; text-align: left;">
          <div id="weeklyReportBody"></div>
          <div id="weeklyReportLocked" style="display:none; padding: 24px; border: 2px dashed var(--card-border); border-radius: 16px; text-align: center;">
             <span style="font-size: 2rem; display:block; margin-bottom:10px;">ğŸ”’</span>
             <div>
                <b>-ì¼ ì—°ì† ì„±ê³µ</b> ì¤‘ì…ë‹ˆë‹¤!<br>
                AIê°€ ë¶„ì„í•œ <b>'ì‹¤íŒ¨ íŒ¨í„´ ë¦¬í¬íŠ¸'</b>ê°€ ë„ì°©í–ˆìŠµë‹ˆë‹¤.<br>
                PRO íšŒì›ì´ ë˜ì–´ í™•ì¸í•´ë³´ì„¸ìš”.
             </div>
             <button id="weeklyGoProBtn" class="btn btn-primary" style="margin-top: 15px; font-size:13px;">ë¦¬í¬íŠ¸ ì ê¸ˆ í•´ì œí•˜ê¸°</button>
          </div>
        </div>

        <div id="calendarSection" style="display:none; margin-top:30px; text-align:left;">
          <h3 style="font-size:16px; margin-bottom:10px;">ğŸ“… ì´ë²ˆ ë‹¬ ê¸°ë¡</h3>
          <div id="calendarGrid" style="display:grid; grid-template-columns: repeat(7, 1fr); gap:6px;"></div>
        </div>

      </div>

      <div id="adminPanel" class="glass" style="display:none; position:fixed; bottom:20px; right:20px; width:300px; padding:20px; z-index:9999; border:2px solid red;">
        <h3 style="margin-top:0;">ğŸ‘‘ ê´€ë¦¬ì íŒ¨ë„</h3>
        <button id="adminTestBtn" style="margin-bottom:5px;">ê´€ë¦¬ì í…ŒìŠ¤íŠ¸</button>
        <button id="cheatStreakBtn" style="margin-bottom:5px;">5ì¼ ì—°ì† ì„±ê³µ ì¹˜íŠ¸</button>
        <div id="userList" style="margin-top:10px; max-height: 200px; overflow-y:auto; background:#eee; padding:5px; border-radius:8px;"></div>
        <button onclick="document.getElementById('adminPanel').style.display='none'" style="margin-top:10px;">ë‹«ê¸°</button>
      </div>

    </div>
  </section>

  <section id="pricing">
    <div class="container">
      <div class="section-head">
        <span class="kicker">PRICING</span>
        <h2>ê°€ê²©</h2>
        <p>ë¬´ë£Œë¡œ ì‹œì‘í•˜ê³ , íŒ¨í„´ ë¶„ì„ì´ í•„ìš”í•  ë•Œ PROë¡œ ì—…ê·¸ë ˆì´ë“œí•˜ì„¸ìš”.</p>
      </div>
      <div class="pricing-grid">
        <div class="price-card glass">
          <div class="plan">ë¬´ë£Œ</div>
          <div class="amount">â‚©0</div>
          <div class="desc">ê°€ë³ê²Œ ë£¨í‹´ì„ ë§Œë“¤ê³  ì‹¶ì€ ë¶„ì—ê²Œ</div>
          <ul>
            <li>âœ… í•˜ë£¨ 1ìŠµê´€</li>
            <li>âœ… ê¸°ë³¸ í…Œë§ˆ ì¶”ì²œ</li>
            <li>âœ… ê¸°ë³¸ ìŠ¤íŠ¸ë¦­ í™•ì¸</li>
          </ul>
        </div>
        <div class="price-card glass pro" id="proCard">
          <div class="plan">PRO</div>
          <div class="amount">â‚©3,900</div>
          <div class="desc">ìŠµê´€ì´ ë¬´ë„ˆì§€ëŠ” â€œíŒ¨í„´â€ì„ ì¡ê³  ì‹¶ì€ ë¶„ì—ê²Œ</div>
          <ul>
            <li>âœ¨ ìŠµê´€ ë¬´ì œí•œ + ì»¤ìŠ¤í…€</li>
            <li>âœ¨ ì£¼ê°„ ë¦¬í¬íŠ¸/AI ë¶„ì„</li>
            <li>âœ¨ ìº˜ë¦°ë”/í†µê³„/ë³µêµ¬ê¶Œ</li>
          </ul>
          <button id="goProBtn" class="btn btn-primary" style="width:100%; margin-top:14px;">PROë¡œ ì—…ê·¸ë ˆì´ë“œ</button>
        </div>
      </div>
    </div>
  </section>

  <footer>
    <div class="container" style="text-align:center; padding-bottom:40px; color:var(--muted); font-size:14px;">
      <p>Â© 2026 HabitFlow. All rights reserved.</p>
      <p>support@habitflow.app</p>
    </div>
  </footer>

  <div id="bgm" class="glass" style="position:fixed; bottom:20px; left:20px; padding:12px; width:200px; z-index:100;">
    <div style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
      <div style="font-weight:700; font-size:14px;">ğŸµ BGM</div>
      <button id="bgmToggle" style="padding: 4px 10px; border-radius: 8px; border:none; cursor:pointer; background:var(--primary); color:#fff; font-size:11px;">ì¬ìƒ</button>
    </div>
    <div style="margin-top:10px;">
      <input id="bgmVol" type="range" min="0" max="1" step="0.01" value="0.25" style="width:100%;">
      <div style="display:flex; justify-content:space-between; font-size:11px; opacity:0.7;">
        <span>ë³¼ë¥¨</span><span id="bgmVolText">25%</span>
      </div>
    </div>
    <audio id="bgmAudio" src="ê·¸ë–„ ê·¸ë‚  ìš°ë¦¬ëŠ” ë§ì•¼(1).mp3" preload="auto" loop></audio>
  </div>

  <div id="proModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6); align-items:center; justify-content:center; z-index:9999; backdrop-filter:blur(5px);">
    <div class="glass" style="padding:40px; max-width:360px; width:90%; text-align:center; background:#fff;">
      <h2 style="margin-top:0;">ğŸ‘‘ PROë¡œ ì„±ì¥ ê°€ì†</h2>
      <p style="color:var(--muted); line-height:1.6; margin-bottom:20px;">
        ì—°ì† ê¸°ë¡ ë³´í˜¸ê¶Œ<br>
        ì›”ê°„ ìº˜ë¦°ë” ë·°<br>
        AI ì£¼ê°„ íŒ¨í„´ ë¶„ì„
      </p>
      <button id="proModalBtn" class="btn btn-primary" style="width:100%;">PRO ì‹œì‘í•˜ê¸°</button>
      <p style="margin-top:16px; font-size:13px; cursor:pointer; color:var(--muted);" onclick="document.getElementById('proModal').style.display='none'">ë‚˜ì¤‘ì— í• ê²Œìš”</p>
    </div>
  </div>

<script>
  function scrollToAuth() {
    document.getElementById("authSection").scrollIntoView({ behavior: "smooth" });
  }
  function safeText(id, value) {
    const el = document.getElementById(id);
    if (el) el.textContent = value;
  }
</script>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import {
    getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword,
    onAuthStateChanged, signOut, getIdTokenResult, sendPasswordResetEmail, sendEmailVerification
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
  import { getFirestore, doc, setDoc, getDoc, collection, getDocs, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
  // ê½ƒê°€ë£¨ íš¨ê³¼ ë¼ì´ë¸ŒëŸ¬ë¦¬ (CDNì´ í—¤ë”ì— ì—†ì–´ë„ ë™ì‘í•˜ë„ë¡ import ë°©ì‹ ë³€ê²½ ì‹œë„, 
  // ë§Œì•½ í—¤ë”ì— ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì•ˆ ë„£ì—ˆë‹¤ë©´ ì•„ë˜ confetti í•¨ìˆ˜ëŠ” ì—ëŸ¬ê°€ ë‚  ìˆ˜ ìˆìœ¼ë‹ˆ í—¤ë” í™•ì¸ í•„ìš”. 
  // ì•ˆì „í•˜ê²Œ window.confetti ì²´í¬)

  const firebaseConfig = {
    apiKey: "AIzaSyAIaroNs2VsMamnnNJV1cP9LdXqIDhl3Ig",
    authDomain: "giiiddd-36340523-3f595.firebaseapp.com",
    projectId: "giiiddd-36340523-3f595",
    storageBucket: "giiiddd-36340523-3f595.firebasestorage.app",
    messagingSenderId: "698901018936",
    appId: "1:698901018936:web:2fb12a7a03cbd844c1e9cd"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // --- Theme Data ---
  const themeData = {
    survival: ["ğŸ›Œ ë°¤ 11ì‹œ í° ë„ê¸°", "ğŸ’§ ê³µë³µ ë¬¼ í•œ ì”", "ğŸ’Š ì˜ì–‘ì œ ì±™ê²¨ë¨¹ê¸°", "ğŸ¢ ê±°ë¶ëª© ìŠ¤íŠ¸ë ˆì¹­", "ğŸ‘ï¸ ë¨¼ ì‚° ë³´ê¸°", "ğŸ§¹ ì±…ìƒ ìœ„ ë¦¬ì…‹", "ğŸš¶ 30ë¶„ ì‚°ì±…"],
    godsaeng: ["ğŸ“… ë‹¤ìŒ ì£¼ ê³„íš ì§œê¸°", "ğŸ›ï¸ ì´ë¶ˆ ì •ë¦¬í•˜ê¸°", "ğŸ’° ê°€ê³„ë¶€ ì ê¸°", "ğŸ“š ì±… 2í˜ì´ì§€ ì½ê¸°", "ğŸ—£ï¸ ì˜ë‹¨ì–´ 1ê°œ ì™¸ìš°ê¸°", "ğŸ“ ê°ì‚¬ ì¼ê¸° 3ì¤„", "ğŸ§¹ ë°© ì²­ì†Œí•˜ê¸°"],
    detox: ["ğŸ“ ë‚´ì¼ í•  ì¼ ì†ê¸°ë¡", "ğŸ“µ ê¸°ìƒ í›„ 10ë¶„ ë…¸í°", "ğŸ½ï¸ ì‹ì‚¬ ì¤‘ ì˜ìƒ ê¸ˆì§€", "ğŸ§ ì´ì–´í° ì—†ì´ ê±·ê¸°", "ğŸ“± ìŠ¤í¬ë¦° íƒ€ì„ í™•ì¸", "ğŸ§˜ 5ë¶„ ëª…ìƒ", "ğŸ“µ ë””ì§€í„¸ í”„ë¦¬ 1ì‹œê°„"]
  };

  // --- Helper Functions ---
  function dateKeyFromOffset(daysAgo) {
    const d = new Date();
    d.setDate(d.getDate() - daysAgo);
    return d.toISOString().slice(0, 10);
  }

  async function getConsecutiveStreak(uid) {
    let count = 0;
    let date = new Date();
    while (true) {
      const key = date.toISOString().slice(0, 10);
      const snap = await getDoc(doc(db, "users", uid, "habits", key));
      if (!snap.exists()) break;
      count++;
      date.setDate(date.getDate() - 1);
    }
    return count;
  }

  function requireEmailPass() {
    const emailEl = document.getElementById("email");
    const passEl = document.getElementById("password");
    if (!emailEl?.value || !passEl?.value) {
      alert("ì´ë©”ì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.");
      return false;
    }
    if (passEl.value.length < 6) {
      alert("ë¹„ë°€ë²ˆí˜¸ëŠ” 6ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.");
      return false;
    }
    return true;
  }

  // --- Window Global Functions ---
  window.selectTheme = async (el, themeType) => {
    const user = auth.currentUser;
    if (!user) return alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");

    const tokenResult = await getIdTokenResult(user);
    const isPro = tokenResult.claims.pro === true;
    const habitInput = document.getElementById("habitName");
    const dayIdx = new Date().getDay();

    document.querySelectorAll('.theme-tag').forEach(tag => tag.classList.remove('active'));

    if (themeType === 'custom') {
      if (!isPro) {
        alert("ğŸ”’ ì»¤ìŠ¤í…€ ìŠµê´€ì€ PRO ì „ìš©ì…ë‹ˆë‹¤.");
        return;
      }
      habitInput.readOnly = false;
      habitInput.value = "";
      habitInput.placeholder = "ì›í•˜ëŠ” ìŠµê´€ì„ ì…ë ¥í•˜ì„¸ìš”";
      habitInput.style.background = "#fff";
      habitInput.focus();
    } else {
      habitInput.readOnly = true;
      habitInput.style.background = "var(--bg-color)";
      habitInput.value = themeData[themeType][dayIdx];
    }
    if (el) el.classList.add('active');
  };

  // --- DOM Elements ---
  const authDiv = document.getElementById('auth');
  const appDiv = document.getElementById('app');
  const emailInput = document.getElementById("email");
  const passInput = document.getElementById("password");
  const signupBtn = document.getElementById("signupBtn");
  const signinBtn = document.getElementById("signinBtn");
  const resetPwBtn = document.getElementById("resetPwBtn");
  const logoutBtn = document.getElementById("logoutBtn");
  const habitBtn = document.getElementById('habitBtn');
  
  // PRO & Admin UI
  const proCard = document.getElementById("proCard");
  const statsDiv = document.getElementById("stats");
  // const adminPanel = document.getElementById("adminPanel"); // ë™ì  ì œì–´ë¡œ ë³€ê²½ë¨
  const restoreBtn = document.getElementById("restoreStreakBtn");
  const weeklyReport = document.getElementById("weeklyReport");

  // --- Auth Event Listeners ---
  signupBtn.onclick = async () => {
    if (!requireEmailPass()) return;
    try {
      const cred = await createUserWithEmailAndPassword(auth, emailInput.value, passInput.value);
      await sendEmailVerification(cred.user);
      alert("âœ… íšŒì›ê°€ì… ì™„ë£Œ! ì¸ì¦ ë©”ì¼ì„ í™•ì¸í•´ì£¼ì„¸ìš”.");
      await signOut(auth);
    } catch (e) {
      alert("ê°€ì… ì‹¤íŒ¨: " + e.message);
    }
  };

  signinBtn.onclick = async () => {
    if (!requireEmailPass()) return;
    try {
      const cred = await signInWithEmailAndPassword(auth, emailInput.value, passInput.value);
      // ë¡œê·¸ì¸ ì²´í¬ëŠ” onAuthStateChangedì—ì„œ ìˆ˜í–‰
    } catch (e) {
      alert("ë¡œê·¸ì¸ ì‹¤íŒ¨: " + e.message);
    }
  };

  resetPwBtn.onclick = async () => {
    if (!emailInput.value) return alert("ì´ë©”ì¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
    try {
      await sendPasswordResetEmail(auth, emailInput.value);
      alert("ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì • ë©”ì¼ì„ ë³´ëƒˆìŠµë‹ˆë‹¤.");
    } catch(e) { alert("ì˜¤ë¥˜: " + e.message); }
  };

  logoutBtn.onclick = () => signOut(auth);

  // --- Core Logic (Auth Monitor) ---
  onAuthStateChanged(auth, async user => {
    // 1. ë¡œê·¸ì•„ì›ƒ ìƒíƒœ
    if (!user) {
      authDiv.style.display = 'block';
      appDiv.style.display = 'none';
      if(document.getElementById("adminPanel")) document.getElementById("adminPanel").style.display = 'none';
      if(document.getElementById("adminOpenBtn")) document.getElementById("adminOpenBtn").style.display = 'none';
      return;
    }

    // 2. ê´€ë¦¬ì ì˜ˆì™¸ ì´ë©”ì¼ ì„¤ì •
    const adminEmail = "test@gmail.com"; 

    // 3. ì´ë©”ì¼ ì¸ì¦ ì²´í¬
    if (!user.emailVerified && user.email !== adminEmail) {
      alert("ğŸ“© ì´ë©”ì¼ ì¸ì¦ í›„ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.");
      await signOut(auth);
      authDiv.style.display = 'block';
      appDiv.style.display = 'none';
      return;
    }

    // 4. ë¡œê·¸ì¸ ì„±ê³µ UI
    authDiv.style.display = 'none';
    appDiv.style.display = 'block';
    
    const dayIdx = new Date().getDay();
    const suggestionEl = document.getElementById("todaySuggestion");
    if(suggestionEl) suggestionEl.innerHTML = `ğŸ‘‰ ì˜¤ëŠ˜ ì¶”ì²œ: <b>${themeData.survival[dayIdx]}</b> (ê¸°ë³¸)`;

    try {
      const tokenResult = await getIdTokenResult(user, true);
      const isAdmin = tokenResult.claims.admin === true;
      const isPro = tokenResult.claims.pro === true;

      document.getElementById("welcome").textContent = `ğŸ‘‹ ${user.email.split('@')[0]}ë‹˜`;

      // --- [ê´€ë¦¬ì íŒ¨ë„ ë¡œì§] ---
      const openBtn = document.getElementById("adminOpenBtn");
      const panel = document.getElementById("adminPanel");
      
      // ê´€ë¦¬ì ê¶Œí•œ í™•ì¸
      if (isAdmin || user.email === adminEmail) {
        if(openBtn) {
            openBtn.style.display = 'block'; // ì™•ê´€ ë²„íŠ¼ ë³´ì´ê¸°
            openBtn.onclick = () => {
                // íŒ¨ë„ í† ê¸€
                if (panel.style.display === 'none' || panel.style.display === '') {
                    panel.style.display = 'block';
                    loadAllUsers(); // ë°ì´í„° ë¡œë“œ
                } else {
                    panel.style.display = 'none';
                }
            };
        }
      } else {
        if(openBtn) openBtn.style.display = 'none';
        if(panel) panel.style.display = 'none';
      }
      // -------------------------

      // PRO UI
      if (isPro) {
        if(proCard) proCard.style.display = "none";
        if(statsDiv) statsDiv.style.display = "block";
        safeText("status", "ğŸŒŸ PRO ë©¤ë²„ì‹­ ì´ìš© ì¤‘");
        loadStats(user.uid);
      } else {
        if(proCard) proCard.style.display = "block";
        if(statsDiv) statsDiv.style.display = "none";
        safeText("status", "ğŸŒ± ë¬´ë£Œ íšŒì› (í•˜ë£¨ 1ìŠµê´€)");
      }

      // Load Data
      const streak = await getConsecutiveStreak(user.uid);
      updateTierUI(streak);
      await updateWeeklyReport(user.uid, isPro);
      await renderCalendar(user.uid, isPro);
      await updateStreakProtectionUI(user.uid, isPro);
      
      if (!isPro && streak >= 7) showProModal();

    } catch (e) {
      console.error("Auth init error:", e);
    }
  });

  // --- Habit Actions (ê½ƒê°€ë£¨ íš¨ê³¼ ì ìš©) ---
  habitBtn.onclick = async () => {
    const user = auth.currentUser;
    if (!user) return;
    
    const habitName = document.getElementById("habitName").value;
    if (habitName === "í…Œë§ˆë¥¼ ì„ íƒí•˜ì„¸ìš”" || !habitName.trim()) {
      alert("í…Œë§ˆë¥¼ ì„ íƒí•˜ê±°ë‚˜ ìŠµê´€ì„ ì…ë ¥í•˜ì„¸ìš”!");
      return;
    }
    
    const todayStr = new Date().toISOString().slice(0, 10);
    const ref = doc(db, "users", user.uid, "habits", todayStr);
    
    await setDoc(ref, {
      done: true,
      name: habitName,
      timestamp: new Date()
    });

    celebrate(); // ê½ƒê°€ë£¨ í•¨ìˆ˜ í˜¸ì¶œ
    
    const streak = await getConsecutiveStreak(user.uid);
    updateTierUI(streak);
  };

  // ê½ƒê°€ë£¨ íš¨ê³¼ í•¨ìˆ˜
  function celebrate() {
    const btn = document.getElementById("habitBtn");
    
    // ë²„íŠ¼ ì• ë‹ˆë©”ì´ì…˜
    btn.style.transform = "scale(0.95)";
    setTimeout(() => { btn.style.transform = "scale(1)"; }, 150);
    
    safeText("status", "ğŸ‰ ì˜¤ëŠ˜ì˜ ë¯¸ì…˜ í´ë¦¬ì–´! í›Œë¥­í•©ë‹ˆë‹¤.");
    btn.innerHTML = "ì™„ë£Œí•¨ âœ¨";
    btn.style.background = "#ddd";
    btn.style.color = "#888";
    btn.style.cursor = "default";
    btn.disabled = true;

    // ê½ƒê°€ë£¨ ë°œì‚¬ (window.confettiê°€ ë¡œë“œë˜ì–´ ìˆì–´ì•¼ í•¨)
    if (typeof confetti === 'function') {
        const count = 200;
        const defaults = { origin: { y: 0.7 } };
        function fire(particleRatio, opts) {
          confetti(Object.assign({}, defaults, opts, {
            particleCount: Math.floor(count * particleRatio)
          }));
        }
        fire(0.25, { spread: 26, startVelocity: 55 });
        fire(0.2, { spread: 60 });
        fire(0.35, { spread: 100, decay: 0.91, scalar: 0.8 });
        fire(0.1, { spread: 120, startVelocity: 25, decay: 0.92, scalar: 1.2 });
        fire(0.1, { spread: 120, startVelocity: 45 });
    } else {
        console.log("Confetti script not loaded");
    }
  }

  // --- UI Update Functions ---
  function updateTierUI(streak) {
    const tierBadge = document.getElementById("tierBadge");
    const tierText = document.getElementById("tierText");
    const streakCount = document.getElementById("streakCount");

    tierBadge.style.display = "block";
    streakCount.textContent = `ğŸ”¥ í˜„ì¬ ${streak}ì¼ ì—°ì† ì„±ê³µ ì¤‘!`;

    let label = "ğŸ¥‰ BRONZE";
    let cls = "tier-bronze";
    if (streak >= 30) { label = "ğŸ† GRANDMASTER"; cls = "tier-master"; }
    else if (streak >= 20) { label = "ğŸ’ DIAMOND"; cls = "tier-diamond"; }
    else if (streak >= 14) { label = "âœ¨ PLATINUM"; cls = "tier-platinum"; }
    else if (streak >= 7) { label = "ğŸ¥‡ GOLD"; cls = "tier-gold"; }
    else if (streak >= 3) { label = "ğŸ¥ˆ SILVER"; cls = "tier-silver"; }

    tierText.textContent = label;
    tierText.className = "badge " + cls;
  }

  async function updateWeeklyReport(uid, isPro) {
    const reportBody = document.getElementById("weeklyReportBody");
    const lockedDiv = document.getElementById("weeklyReportLocked");
    const reportDiv = document.getElementById("weeklyReport");
    
    let successCount = 0;
    const days = [];
    const dayNames = ["ì¼", "ì›”", "í™”", "ìˆ˜", "ëª©", "ê¸ˆ", "í† "];
    
    for (let i = 0; i < 7; i++) {
       const key = dateKeyFromOffset(i);
       const snap = await getDoc(doc(db, "users", uid, "habits", key));
       const done = snap.exists();
       const d = new Date(key);
       if (done) successCount++;
       days.push({ key, done, dayName: dayNames[d.getDay()] });
    }

    const streak = await getConsecutiveStreak(uid);
    if (streak < 3) {
      reportDiv.style.display = "none";
      return;
    }
    reportDiv.style.display = "block";

    if (!isPro) {
      reportBody.innerHTML = "";
      lockedDiv.style.display = "block";
      document.querySelector("#weeklyReportLocked b").textContent = `${streak}ì¼ ì—°ì† ì„±ê³µ`;
      return;
    }

    lockedDiv.style.display = "none";
    const rate = Math.round((successCount/7)*100);
    const listHTML = days.reverse().map(d => `
       <div style="display:flex; justify-content:space-between; margin-bottom:6px; font-size:13px;">
         <span>${d.dayName} (${d.key.slice(5)})</span>
         <span>${d.done ? "âœ…" : "âŒ"}</span>
       </div>
    `).join('');

    reportBody.innerHTML = `
      <div style="background:rgba(99,102,241,0.1); padding:16px; border-radius:12px; margin-bottom:12px;">
         <div style="font-weight:700; margin-bottom:8px;">ğŸ¤– AI Habit Coach</div>
         <div style="font-size:13px; line-height:1.5;">
            ì´ë²ˆ ì£¼ ì„±ê³µë¥ ì€ <b>${rate}%</b>ì…ë‹ˆë‹¤.<br>
            ${rate === 100 ? "ì™„ë²½í•©ë‹ˆë‹¤! ê°“ìƒ ê·¸ ìì²´ì‹œë„¤ìš”." : "ì£¼ë§ì— ì¡°ê¸ˆ ë” ì‹ ê²½ì¨ë³´ë©´ ì–´ë–¨ê¹Œìš”?"}
         </div>
      </div>
      <div style="padding:10px; background:#fff; border-radius:12px; border:1px solid #eee;">
         ${listHTML}
      </div>
    `;
  }

  async function renderCalendar(uid, isPro) {
    const section = document.getElementById("calendarSection");
    const grid = document.getElementById("calendarGrid");
    
    if (!isPro) {
      section.style.display = "none";
      return;
    }
    section.style.display = "block";
    grid.innerHTML = "";

    const now = new Date();
    const year = now.getFullYear();
    const month = now.getMonth();
    const lastDay = new Date(year, month + 1, 0).getDate();

    for (let d = 1; d <= lastDay; d++) {
      const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
      const snap = await getDoc(doc(db, "users", uid, "habits", dateStr));
      
      const cell = document.createElement("div");
      cell.textContent = d;
      cell.style.padding = "6px";
      cell.style.borderRadius = "6px";
      cell.style.fontSize = "12px";
      cell.style.textAlign = "center";
      
      if (snap.exists()) {
        cell.style.background = "#22c55e";
        cell.style.color = "white";
      } else {
        cell.style.background = "rgba(0,0,0,0.05)";
        cell.style.color = "var(--muted)";
      }
      grid.appendChild(cell);
    }
  }

  async function updateStreakProtectionUI(uid, isPro) {
    if (!isPro) return;
    const snap = await getDoc(doc(db, "users", uid));
    const left = snap.data()?.streakProtectionLeft ?? 2;
    
    if (left > 0) {
      restoreBtn.style.display = "block";
      restoreBtn.textContent = `ğŸ”¥ ì—°ì† ê¸°ë¡ ë³µêµ¬ (${left}íšŒ ë‚¨ìŒ)`;
      restoreBtn.onclick = async () => {
         const yesterday = dateKeyFromOffset(1);
         await setDoc(doc(db, "users", uid, "habits", yesterday), { done: true, restored: true });
         await updateDoc(doc(db, "users", uid), { streakProtectionLeft: left - 1 });
         alert("ğŸ”¥ ì–´ì œ ê¸°ë¡ì´ ë³µêµ¬ë˜ì—ˆìŠµë‹ˆë‹¤!");
         location.reload();
      };
    } else {
      restoreBtn.style.display = "none";
    }
  }

  async function loadStats(uid) {
    let count = 0;
    const snap = await getDocs(collection(db, "users", uid, "habits"));
    safeText("totalDays", `ì´ ëˆ„ì  ì„±ê³µ: ${snap.size}ì¼`);
  }

  // --- Admin Functions (ëª¨ë‹¬ì°½ ì ìš© ì™„ë£Œ) ---
  async function loadAllUsers() {
    const listDiv = document.getElementById("userList");
    if (!listDiv) return;

    listDiv.innerHTML = "<div style='text-align:center; padding:20px;'>ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>";
    
    try {
      const snap = await getDocs(collection(db, "users"));
      listDiv.innerHTML = "";
      
      if (snap.empty) {
          listDiv.innerHTML = "ê°€ì…ëœ ìœ ì €ê°€ ì—†ìŠµë‹ˆë‹¤.";
          return;
      }

      snap.forEach(docSnap => {
        const data = docSnap.data();
        const uid = docSnap.id;
        
        const item = document.createElement("div");
        item.style.cssText = "background:white; padding:10px; margin-bottom:8px; border-radius:6px; border:1px solid #e2e8f0; display:flex; flex-direction:column; gap:6px;";
        
        item.innerHTML = `
          <div style="display:flex; justify-content:space-between; align-items:center;">
             <span style="font-weight:bold; color:#334155; font-size:11px;">UID: ${uid.slice(0,6)}...</span>
             <span class="badge" style="background:${data.isPro ? '#6366f1' : '#94a3b8'}">${data.isPro ? 'PRO' : 'FREE'}</span>
          </div>
          <div style="display:flex; gap:5px; margin-top:4px;">
             <button class="info-btn" style="flex:1; border:1px solid #cbd5e1; background:#f8fafc; cursor:pointer; border-radius:4px; font-size:11px; padding:4px;">ğŸ” ìƒì„¸ ì •ë³´</button>
             <button class="pro-btn" style="flex:1; border:none; background:${data.isPro ? '#fb7185' : '#6366f1'}; color:white; cursor:pointer; border-radius:4px; font-size:11px; padding:4px;">
                ${data.isPro ? 'PRO í•´ì œ' : 'PRO ë¶€ì—¬'}
             </button>
          </div>
        `;

        item.querySelector(".pro-btn").onclick = async () => {
           if(confirm(`[${uid}] ë‹˜ì˜ ë“±ê¸‰ì„ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
               await updateDoc(doc(db, "users", uid), { isPro: !data.isPro });
               loadAllUsers(); 
           }
        };

        // ìƒì„¸ ì •ë³´ ëª¨ë‹¬ ì—´ê¸°
        item.querySelector(".info-btn").onclick = async () => {
            const modal = document.getElementById("adminUserDetailModal");
            const content = document.getElementById("detailContent");
            
            modal.style.display = "flex";
            content.innerHTML = "ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...";

            const habitsSnap = await getDocs(collection(db, "users", uid, "habits"));
            const totalHabits = habitsSnap.size;
            
            let recentHabitsHTML = "";
            let habitsArr = [];
            habitsSnap.forEach(h => habitsArr.push({date: h.id, ...h.data()}));
            habitsArr.sort((a,b) => new Date(b.date) - new Date(a.date));
            
            habitsArr.slice(0, 5).forEach(h => {
                recentHabitsHTML += `<li style="margin-bottom:4px;">${h.date}: ${h.name} ${h.done?'âœ…':'âŒ'}</li>`;
            });

            content.innerHTML = `
                <p><strong>ğŸ†” UID:</strong> ${uid}</p>
                <p><strong>ğŸ’ ë©¤ë²„ì‹­:</strong> ${data.isPro ? '<span style="color:blue">PRO ìœ ì €</span>' : 'ë¬´ë£Œ ìœ ì €'}</p>
                <p><strong>ğŸ›¡ï¸ ê¸°ë¡ ë³µêµ¬ê¶Œ:</strong> ${data.streakProtectionLeft ?? 0}íšŒ ë‚¨ìŒ</p>
                <hr style="border:0; border-top:1px dashed #ccc; margin:15px 0;">
                <p><strong>ğŸ“Š ì´ ì„±ê³µ ì¼ìˆ˜:</strong> ${totalHabits}ì¼</p>
                <p><strong>ğŸ—“ï¸ ìµœê·¼ í™œë™:</strong></p>
                <ul style="padding-left:20px; background:#f8fafc; padding:10px 10px 10px 30px; border-radius:8px;">
                    ${recentHabitsHTML || "<li style='color:#999'>ê¸°ë¡ ì—†ìŒ</li>"}
                </ul>
            `;
        };

        listDiv.appendChild(item);
      });
    } catch (error) {
      console.error(error);
      listDiv.innerHTML = "ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.";
    }
  }

  const cheatBtn = document.getElementById("cheatStreakBtn");
  if(cheatBtn) {
    cheatBtn.onclick = async () => {
       const user = auth.currentUser;
       if (!user) return alert("ë¡œê·¸ì¸ í•„ìš”");
       if (!confirm("ì§€ë‚œ 5ì¼ ë°ì´í„°ë¥¼ ê°•ì œ ì„±ê³µ ì²˜ë¦¬í• ê¹Œìš”?")) return;
       for(let i=0; i<5; i++) {
          const k = dateKeyFromOffset(i);
          await setDoc(doc(db, "users", user.uid, "habits", k), { done: true, cheat: true });
       }
       alert("ì¹˜íŠ¸ ì ìš© ì™„ë£Œ! ìƒˆë¡œê³ ì¹¨í•˜ì„¸ìš”.");
       location.reload();
    };
  }

  // --- Modal Helpers ---
  window.showProModal = () => document.getElementById("proModal").style.display = "flex";
  
  // --- Dark Mode ---
  const toggle = document.getElementById("darkModeToggle");
  toggle.onclick = () => {
    document.body.classList.toggle("dark-mode");
    localStorage.setItem("darkMode", document.body.classList.contains("dark-mode") ? "on" : "off");
  };
  if (localStorage.getItem("darkMode") === "on") document.body.classList.add("dark-mode");

</script>

<script>
  // BGM Logic (Vanilla JS)
  const audio = document.getElementById("bgmAudio");
  const bgmBtn = document.getElementById("bgmToggle");
  const vol = document.getElementById("bgmVol");
  const volText = document.getElementById("bgmVolText");

  if (audio && bgmBtn) {
    audio.volume = 0.25;
    bgmBtn.onclick = () => {
      if (audio.paused) {
        audio.play().then(() => bgmBtn.textContent = "ì¼ì‹œì •ì§€").catch(() => alert("ìë™ ì¬ìƒ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤."));
      } else {
        audio.pause();
        bgmBtn.textContent = "ì¬ìƒ";
      }
    };
    vol.oninput = () => {
      audio.volume = vol.value;
      volText.textContent = Math.round(vol.value * 100) + "%";
    };
  }
</script>
<button id="adminOpenBtn" style="
    display:none; position:fixed; bottom:20px; right:20px; z-index:9990;
    width:50px; height:50px; border-radius:50%; border:none;
    background:#ef4444; color:white; font-size:24px; cursor:pointer;
    box-shadow:0 4px 12px rgba(0,0,0,0.3); transition: transform 0.2s;
">ğŸ‘‘</button>

<div id="adminPanel" class="glass" style="
    display:none; position:fixed; bottom:80px; right:20px; width:340px; 
    padding:20px; z-index:9999; border:2px solid #ef4444; background:rgba(255,255,255,0.95);
">
  <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
    <h3 style="margin:0; color:#ef4444;">ğŸ‘‘ ê´€ë¦¬ì ëª¨ë“œ</h3>
    <button onclick="document.getElementById('adminPanel').style.display='none'" 
            style="border:none; background:none; font-size:18px; cursor:pointer;">âœ–</button>
  </div>
  
  <div style="display:flex; gap:5px; margin-bottom:15px;">
    <button id="adminTestBtn" style="flex:1; padding:8px; font-size:11px; cursor:pointer;">ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸</button>
    <button id="cheatStreakBtn" style="flex:1; padding:8px; font-size:11px; cursor:pointer;">ì¹˜íŠ¸í‚¤(5ì¼)</button>
  </div>

  <div style="font-size:12px; font-weight:bold; margin-bottom:5px;">ğŸ‘¤ ìœ ì € ëª©ë¡ (ìµœê·¼ ê°€ì…ìˆœ)</div>
  <div id="userList" style="
      height: 250px; overflow-y:auto; background:#f1f5f9; 
      padding:10px; border-radius:8px; border:1px solid #cbd5e1;
  "></div>
</div>

<div id="adminUserDetailModal" style="
    display:none; position:fixed; inset:0; z-index:10000;
    background:rgba(0,0,0,0.5); align-items:center; justify-content:center;
">
  <div style="
      background:white; width:90%; max-width:500px; height:80vh; 
      border-radius:16px; display:flex; flex-direction:column; overflow:hidden;
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
  ">
    <div style="padding:20px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center;">
      <h3 style="margin:0;">ğŸ‘¤ ê³ ê° ìƒì„¸ ì •ë³´</h3>
      <button onclick="document.getElementById('adminUserDetailModal').style.display='none'" 
              style="border:none; background:none; font-size:20px; cursor:pointer;">âœ–</button>
    </div>
    <div id="detailContent" style="padding:20px; overflow-y:auto; flex:1; font-family:monospace; font-size:13px; line-height:1.6;">
      </div>
    <div style="padding:15px; border-top:1px solid #eee; text-align:right;">
        <button onclick="document.getElementById('adminUserDetailModal').style.display='none'"
                style="padding:10px 20px; background:#333; color:white; border:none; border-radius:8px; cursor:pointer;">ë‹«ê¸°</button>
    </div>
  </div>
</div>

</body>
</html>