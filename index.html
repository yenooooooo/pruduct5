<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>HabitFlow</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@400;600;700&amp;display=swap" rel="stylesheet">

  <style>
:root {
  --bg-color: #f0f2f5;
  --text-color: #1a202c;
  --primary-color: #6366f1; /* ì„¸ë ¨ëœ ì¸ë””ê³  ë¸”ë£¨ */
  --accent-color: #f59e0b; /* ë”°ëœ»í•œ ê³¨ë“œ(PROìš©) */
  --card-bg: rgba(255, 255, 255, 0.8);
  --glass-border: rgba(255, 255, 255, 0.3);
}

.dark-mode {
  --bg-color: #0f172a; /* ê¹Šì€ ë„¤ì´ë¹„ */
  --text-color: #f1f5f9;
  --card-bg: rgba(30, 41, 59, 0.7);
  --glass-border: rgba(255, 255, 255, 0.1);
}

body {
  margin: 0;
  font-family: 'Pretendard', sans-serif;
  background-color: var(--bg-color);
  color: var(--text-color);
  transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='40' height='40' viewBox='0 0 40 40'%3E%3Cg fill-rule='evenodd'%3E%3Cg fill='%239C92AC' fill-opacity='0.1'%3E%3Cpath d='M0 38.59l2.83-2.83 1.41 1.41L1.41 40H0v-1.41zM0 1.4l2.83 2.83 1.41-1.41L1.41 0H0v1.41zM38.59 40l-2.83-2.83 1.41-1.41L40 38.59V40h-1.41zM40 1.41l-2.83 2.83-1.41-1.41L38.59 0H40v1.41z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
}

/* ê¸€ë˜ìŠ¤ëª¨í”¼ì¦˜ ì¹´ë“œ ìŠ¤íƒ€ì¼ */
.glass-card {
  background: var(--card-bg);
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
  border: 1px solid var(--glass-border);
  border-radius: 24px;
  box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.1);
  padding: 30px;
  transition: transform 0.3s ease;
}

.glass-card:hover {
  transform: translateY(-5px);
}

/* ë²„íŠ¼ ë””ìì¸ ê°œì„  */
button {
  transition: all 0.2s ease;
  border-radius: 12px !important;
  font-weight: 600 !important;
  letter-spacing: -0.5px;
}

button:active {
  transform: scale(0.96);
}

#loginBtn, .btn-start {
  background: linear-gradient(135deg, #6366f1 0%, #a855f7 100%) !important;
  color: white;
  border: none;
  box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
}

/* ìŠµê´€ ë²„íŠ¼ - ë” í¬ê²Œ, ë” ì§ê´€ì ìœ¼ë¡œ */
#habitBtn {
  height: 60px;
  font-size: 18px !important;
  background: white;
  border: 2px solid var(--primary-color);
  color: var(--primary-color);
  margin-top: 20px;
}

#habitBtn.done {
  background: #22c55e !important;
  border-color: #22c55e !important;
  color: white !important;
  box-shadow: 0 4px 15px rgba(34, 197, 94, 0.4);
}

.hero-button {
  background: white;
  color: var(--primary-color);
  padding: 16px 32px;
  font-size: 18px;
  border-radius: 16px;
  border: none;
  font-weight: 700;
  cursor: pointer;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
  transition: all 0.3s ease;
}

.hero-button:hover {
  transform: translateY(-3px);
  box-shadow: 0 6px 25px rgba(0, 0, 0, 0.3);
}

/* í…Œë§ˆ íƒœê·¸ ìŠ¤íƒ€ì¼ ê°œì„  */
.theme-tag {
  background: transparent;
  border: 1.5px solid #e2e8f0;
  color: #64748b;
  padding: 10px 18px;
  font-size: 14px;
  transition: all 0.3s ease;
}

.theme-tag.active {
  background: var(--primary-color);
  color: white;
  border-color: var(--primary-color);
  box-shadow: 0 4px 10px rgba(99, 102, 241, 0.2);
}

/* í—¤ë” - ê³ ì •í˜• ë©”ë‰´ */
header {
  background: rgba(255, 255, 255, 0.7);
  backdrop-filter: blur(10px);
  border-bottom: 1px solid rgba(0,0,0,0.05);
}

/* Hero ì„¹ì…˜ - ë¶€ë“œëŸ¬ìš´ ê·¸ë¼ë°ì´ì…˜ */
.hero {
  background: radial-gradient(circle at top right, #6366f1, #4f46e5);
  border-radius: 0 0 50px 50px;
}

/* ì…ë ¥ì°½ */
input {
  border: 1.5px solid #e2e8f0;
  background: #f8fafc;
  padding: 14px !important;
  font-size: 15px;
}

input:focus {
  border-color: var(--primary-color);
  outline: none;
  background: white;
}

/* Global Centering and Layout */
section {
  padding: 80px 20px;
  width: 100%;
  max-width: 1200px;
  margin: 0 auto; /* Center sections themselves */
  text-align: center; /* Center content within sections by default */
}

ul, ol {
  max-width: 600px; /* Limit width for readability */
  margin: 20px auto; /* Center lists */
  padding-left: 0; /* Remove default padding for lists */
  list-style-position: inside; /* Adjust list item marker position */
  text-align: left; /* Keep list text left-aligned within the list block */
}

#mainContainer {
  width: 100%;
  max-width: 900px; /* Keep max-width */
  margin: 40px auto; /* Adjust margin for spacing */
  display: flex;
  gap: 24px; /* Increase gap slightly */
  align-items: flex-start; /* Align items to the start of the cross axis */
  justify-content: center; /* Center items along the main axis */
  flex-wrap: wrap;
}

.auth-card, #adminPanel { /* adminPanelì—ë„ ì ìš© */
  flex: 1; /* Allow cards to grow and shrink */
  min-width: 300px; /* Minimum width for responsiveness */
  max-width: 420px; /* Max width for single column layout */
  text-align: center; /* Center text within cards */
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

.fade-in {
  animation: fadeIn 0.5s ease-out forwards;
}
.icon {
  font-size: 2em;
  margin-bottom: 10px;
  display: block;
}

/* AI ì½”ì¹˜ ë¦¬í¬íŠ¸ ìŠ¤íƒ€ì¼ */
.ai-coach-card {
  </style>
</head>
<body>

<header>
  <div class="logo">HabitFlow</div>
  <nav>
    <a href="#features">ê¸°ëŠ¥</a>
    <a href="#pro">PRO</a>
    <a href="#pricing">ê°€ê²©</a>
    <button class="btn-start" onclick="scrollToAuth()">ì‹œì‘í•˜ê¸°</button>
    <button id="darkModeToggle" style="background: #333; color: white; padding: 8px 12px; border-radius: 5px; cursor: pointer; font-size: 12px;">
      ğŸŒ“
    </button>
  </nav>
</header>

<section class="hero">
  <h1>í•˜ë£¨ í•˜ë‚˜,<br>ì¸ìƒì„ ë°”ê¾¸ëŠ” ìŠµê´€</h1>
  <p>ì‘ì‹¬ì‚¼ì¼ì„ ëë‚´ëŠ” ê°€ì¥ ë‹¨ìˆœí•œ ë°©ë²•</p>
  <button class="hero-button" onclick="scrollToAuth()">ì§€ê¸ˆ ì‹œì‘í•˜ê¸°</button>
</section>

<section class="problem">
  <h2 style="text-align:center;">ì™œ ìŠµê´€ì€ í•­ìƒ ì‹¤íŒ¨í• ê¹Œ?</h2>
  <ul>
    <li>âŒ ëª©í‘œê°€ ë„ˆë¬´ ë§ë‹¤</li>
    <li>âŒ ê¸°ë¡ì´ ê·€ì°®ë‹¤</li>
    <li>âŒ ì„±ì·¨ê°€ ëˆˆì— ì•ˆ ë³´ì¸ë‹¤</li>
  </ul>
  <h3 style="text-align:center;">HabitFlowëŠ” ë‹¤ë¦…ë‹ˆë‹¤</h3>
  <ul>
    <li>âœ… í•˜ë£¨ ë”± í•˜ë‚˜</li>
    <li>âœ… ë²„íŠ¼ í•œ ë²ˆ</li>
    <li>âœ… ì—°ì† ê¸°ë¡ ì‹œê°í™”</li>
  </ul>
</section>

<section id="features">
  <h2 style="text-align:center;">í•µì‹¬ ê¸°ëŠ¥</h2>
  <div class="features">
    <div><h3><span class="icon">ğŸ“…</span> í•˜ë£¨ 1ìŠµê´€</h3><p>ì˜¤ëŠ˜ í•  ë‹¨ í•˜ë‚˜ë§Œ</p></div>
    <div><h3><span class="icon">ğŸ”¥</span> ì—°ì† ê¸°ë¡</h3><p>ì„±ì·¨ê°€ ìŒ“ì¸ë‹¤</p></div>
    <div><h3><span class="icon">â˜ï¸</span> ìë™ ì €ì¥</h3><p>ì–´ë””ì„œë“  ì´ì–´ì„œ</p></div>
  </div>
</section>

<section id="pro" class="pro" style="background: var(--accent-color); color: white;">
  <h2>ğŸš€ HabitFlow PRO</h2>
  <ul>
    <li>âœ” ìŠµê´€ ë¬´ì œí•œ</li>
    <li>âœ” ì—°ì† ê¸°ë¡ í†µê³„</li>
    <li>âœ” íˆìŠ¤í† ë¦¬ ê´€ë¦¬</li>
  </ul>
</section>

<section class="flow">
  <h2 style="text-align:center;">ì‚¬ìš© ë°©ë²•</h2>
  <ol>
    <li>1ï¸âƒ£ ë¡œê·¸ì¸</li>
    <li>2ï¸âƒ£ ì˜¤ëŠ˜ì˜ ìŠµê´€</li>
    <li>3ï¸âƒ£ ë²„íŠ¼ í´ë¦­</li>
    <li>4ï¸âƒ£ ì—°ì† ê¸°ë¡ í™•ì¸</li>
  </ol>
</section>

<section id="pricing">
  <h2 style="text-align:center;">ê°€ê²©</h2>
  <div class="pricing">
    <div class="card">
      <h3>ë¬´ë£Œ</h3>
      <p>â‚©0</p>
      <p>í•˜ë£¨ 1ìŠµê´€</p>
    </div>
    <div class="card highlight">
      <h3>PRO</h3>
      <p>â‚©3,900 / ì›”</p>
      <p>ìŠµê´€ ë¬´ì œí•œ + í†µê³„</p>
    </div>
  </div>
</section>

<section id="authSection">
  <div id="mainContainer">
    <div class="auth-card glass-card">
      <div id="auth">
        <h1>HabitFlow</h1>
        <input id="email" placeholder="ì´ë©”ì¼">
        <input id="password" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸ (6ì ì´ìƒ)">
        <button id="loginBtn">ì‹œì‘í•˜ê¸°</button>
      </div>

      <div id="app" style="display:none">
        <h2 id="welcome"></h2>
        <p id="today"></p>
<div id="themeSection" style="margin-bottom: 20px;">
  <p style="font-size: 14px; font-weight: 600; margin-bottom: 8px;">ğŸ ì˜¤ëŠ˜ ì¶”ì²œ ìŠµê´€ (ë¬´ë£Œ í…Œë§ˆ)</p>
  <div style="display: flex; gap: 8px; overflow-x: auto; padding-bottom: 8px;">
    <button class="theme-tag" onclick="selectTheme('survival')">ğŸ¥ ìƒì¡´ ì²´ë ¥</button>
    <button class="theme-tag" onclick="selectTheme('godsaeng')">âœ¨ ê°“ìƒ ì…ë¬¸</button>
    <button class="theme-tag" onclick="selectTheme('detox')">ğŸ“± ë””í†¡ìŠ¤</button>
    <button class="theme-tag" onclick="selectTheme('custom')" style="background: #f3f4f6; color: #666; border: 1px dashed #ccc;">â• ì§ì ‘ ì…ë ¥ (PRO)</button>
  </div>
  
  <div id="habitInputArea" style="margin-top: 10px;">
    <input id="habitName" type="text" readonly value="í…Œë§ˆë¥¼ ì„ íƒí•˜ì„¸ìš”" 
           style="background: #eee; cursor: not-allowed; text-align: center; font-weight: bold;">
  </div>
</div>

        <button class="habit" id="habitBtn">ì˜¤ëŠ˜ ìŠµê´€ ì™„ë£Œ</button>
        <p id="status"></p>

        <div id="stats" style="display:none; margin-top:16px; background:var(--bg-color); padding:14px; border-radius:14px;">
          <h3>ğŸ“Š ë‚˜ì˜ ìŠµê´€ í†µê³„</h3>
          <p id="totalDays"></p>
        </div>

        <div id="proCard" style="display:none; margin-top:16px; padding:16px; border-radius:14px; background:var(--pro-card-bg);">
          <h3>ğŸš€ HabitFlow PRO</h3>
          <ul>
            <li>í•˜ë£¨ ìŠµê´€ ë¬´ì œí•œ</li>
            <li>ì—°ì† ê¸°ë¡ í†µê³„</li>
          </ul>
          <p><b>â‚©3,900 / ì›”</b></p>
          <button id="goProBtn" style="background:#ff9800; color:white;">PRO ì—…ê·¸ë ˆì´ë“œ</button>
        </div>

<!-- âœ… ì£¼ê°„ ë¦¬í¬íŠ¸ (7ì¼ ì—°ì† ë‹¬ì„± ì‹œ ìƒì„± / ë¬´ë£ŒëŠ” ì ê¸ˆ) -->
<div id="weeklyReport" style="display:none; margin-top:16px; padding:16px; border-radius:14px; background:#eef2ff;">
  <h3 style="margin:0 0 8px;">ğŸ§¾ ì£¼ê°„ ë¦¬í¬íŠ¸</h3>

  <!-- PROë©´ ì—¬ê¸° ë‚´ìš© í‘œì‹œ -->
  <div id="weeklyReportBody" style="font-size:14px; line-height:1.6;"></div>

  <!-- ë¬´ë£Œë©´ ì ê¸ˆ í‘œì‹œ -->
  <div id="weeklyReportLocked" style="display:none;">
    <div style="
      margin-top:10px; padding:14px; border-radius:12px;
      background:rgba(255,255,255,0.7);
      border:1px solid rgba(0,0,0,0.08);
    ">
      <div style="font-weight:800;">ğŸ”’ ë¦¬í¬íŠ¸ê°€ ì ê²¨ ìˆì–´ìš”</div>
      <div style="margin-top:6px; color:#444;">
        <b>7ì¼ ì—°ì† ì„±ê³µ</b>ì„ ë‹¬ì„±í–ˆì–´ìš”!<br>
        PROë¡œ ì—…ê·¸ë ˆì´ë“œí•˜ë©´ <b>ì£¼ê°„ ë³€í™” ë¦¬í¬íŠ¸</b>ë¥¼ ë³¼ ìˆ˜ ìˆì–´ìš”.
      </div>

      <div style="margin-top:10px; padding:10px; border-radius:10px; background:#fff; border:1px dashed rgba(0,0,0,0.15);">
        <div style="font-size:12px; color:#666; margin-bottom:6px;">ë¯¸ë¦¬ë³´ê¸°(ë¸”ëŸ¬)</div>
        <div style="filter: blur(4px); user-select:none;">
          ì´ë²ˆ ì£¼ ì„±ê³µë¥  86% â€¢ ê°€ì¥ ì˜ ëœ ì‹œê°„ëŒ€ 07~09ì‹œ â€¢ ìµœê³  ì—°ì† 7ì¼
        </div>
      </div>

      <button id="weeklyGoProBtn" style="margin-top:12px; background:#ff9800; font-weight:900;">
        PROë¡œ ë¦¬í¬íŠ¸ ì—´ê¸°
      </button>
    </div>
  </div>
</div>

        <button class="logout" id="logoutBtn">ë¡œê·¸ì•„ì›ƒ</button>
      </div>
    </div>

    <div id="adminPanel" class="glass-card" style="display:none; border: 2px solid #6366f1;">
      <h3>ğŸ‘‘ ê´€ë¦¬ì íŒ¨ë„</h3>
      <button id="adminTestBtn" style="width:100%; padding:10px; margin-bottom:12px; cursor:pointer;">
        ê´€ë¦¬ì ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸
      </button>

      <button id="cheatStreakBtn" style="
        width:100%; padding:10px; margin-top:10px; 
        background:#10b981; color:white; border:none; 
        border-radius:10px; cursor:pointer; font-weight:bold;">
        ğŸ§ª (í…ŒìŠ¤íŠ¸ìš©) 5ì¼ ì—°ì† ì„±ê³µ ë§Œë“¤ê¸°
      </button>
      <div id="userList">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
    </div>
  </div>
</section>

<footer>
  <p>Â© 2026 HabitFlow</p>
  <p>support @habitflow.app</p>
</footer>

<div id="bgm">
  <div style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
    <div style="font-weight:700; font-size:14px;">ğŸµ BGM</div>
    <button id="bgmToggle" style="
      padding: 8px 10px; border-radius: 10px; border: none; cursor:pointer;
      background:#667eea; color:#fff; font-weight:700; font-size:12px;
    ">ì¬ìƒ</button>
  </div>

  <div style="margin-top:10px;">
    <input id="bgmVol" type="range" min="0" max="1" step="0.01" value="0.25" style="width:100%;">
    <div style="display:flex; justify-content:space-between; font-size:12px; opacity:0.7;">
      <span>ë³¼ë¥¨</span><span id="bgmVolText">25%</span>
    </div>
  </div>
  <audio id="bgmAudio" src="https://cdn.pixabay.com/download/audio/2022/05/27/audio_1808fbf07a.mp3?filename=lo-fi-116528.mp3" preload="auto" loop></audio>
</div>

<script>
function scrollToAuth() {
  document.getElementById("authSection")
    .scrollIntoView({ behavior: "smooth" });
}
</script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut, getIdTokenResult } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getFirestore, doc, setDoc, getDoc, collection, getDocs, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAIaroNs2VsMamnnNJV1cP9LdXqIDhl3Ig",
  authDomain: "giiiddd-36340523-3f595.firebaseapp.com",
  projectId: "giiiddd-36340523-3f595",
  storageBucket: "giiiddd-36340523-3f595.firebasestorage.app",
  messagingSenderId: "698901018936",
  appId: "1:698901018936:web:2fb12a7a03cbd844c1e9cd"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth();
const db = getFirestore();

// 1. í…Œë§ˆë³„ ìš”ì¼ ìŠµê´€ ë°ì´í„° (0:ì¼ ~ 6:í† )
const themeData = {
  survival: [
    "ğŸ›Œ ë°¤ 11ì‹œ í° ë„ê¸°", "ğŸ’§ ê³µë³µ ë¬¼ í•œ ì”", "ğŸ’Š ì˜ì–‘ì œ ì±™ê²¨ë¨¹ê¸°", 
    "ğŸ¢ ê±°ë¶ëª© ìŠ¤íŠ¸ë ˆì¹­", "ğŸ‘ï¸ ë¨¼ ì‚° ë³´ê¸°", "ğŸ§¹ ì±…ìƒ ìœ„ ë¦¬ì…‹", "ğŸš¶ 30ë¶„ ì‚°ì±…"
  ],
  godsaeng: [
    "ğŸ“… ë‹¤ìŒ ì£¼ ê³„íš ì§œê¸°", "ğŸ›ï¸ ì´ë¶ˆ ì •ë¦¬í•˜ê¸°", "ğŸ’° ê°€ê³„ë¶€ ì ê¸°", 
    "ğŸ“š ì±… 2í˜ì´ì§€ ì½ê¸°", "ğŸ—£ï¸ ì˜ë‹¨ì–´ 1ê°œ ì™¸ìš°ê¸°", "ğŸ“ ê°ì‚¬ ì¼ê¸° 3ì¤„", "ğŸ§¹ ë°© ì²­ì†Œí•˜ê¸°"
  ],
  detox: [
    "ğŸ“ ë‚´ì¼ í•  ì¼ ì†ê¸°ë¡", "ğŸ“µ ê¸°ìƒ í›„ 10ë¶„ ë…¸í°", "ğŸ½ï¸ ì‹ì‚¬ ì¤‘ ì˜ìƒ ê¸ˆì§€", 
    "ğŸ§ ì´ì–´í° ì—†ì´ ê±·ê¸°", "ğŸ“± ìŠ¤í¬ë¦° íƒ€ì„ í™•ì¸", "ğŸ§˜ 5ë¶„ ëª…ìƒ", "ğŸ“µ ë””ì§€í„¸ í”„ë¦¬ 1ì‹œê°„"
  ]
};

// 2. í…Œë§ˆ ì„ íƒ í•¨ìˆ˜ (ì „ì—­ ë²”ìœ„ í˜¸ì¶œì„ ìœ„í•´ windowì— í• ë‹¹)
window.selectTheme = async (themeType) => {
  const user = auth.currentUser;
  const tokenResult = await user.getIdTokenResult();
  const isPro = tokenResult.claims.pro === true;
  const habitInput = document.getElementById("habitName");
  const dayIdx = new Date().getDay();

  // ëª¨ë“  íƒœê·¸ í™œì„±í™” í•´ì œ
  document.querySelectorAll('.theme-tag').forEach(tag => tag.classList.remove('active'));

  if (themeType === 'custom') {
    if (!isPro) {
      alert("ğŸ”’ 'ì§ì ‘ ì…ë ¥'ì€ PRO ì „ìš© ê¸°ëŠ¥ì…ë‹ˆë‹¤.\nê¸°ë³¸ ì œê³µ í…Œë§ˆë¥¼ ì´ìš©í•˜ê±°ë‚˜ PROë¡œ ì—…ê·¸ë ˆì´ë“œí•˜ì„¸ìš”!");
      return;
    }
    // PROì¸ ê²½ìš° ì§ì ‘ ì…ë ¥ ê°€ëŠ¥í•˜ê²Œ ë³€ê²½
    habitInput.readOnly = false;
    habitInput.value = "";
    habitInput.placeholder = "ì›í•˜ëŠ” ìŠµê´€ì„ ì…ë ¥í•˜ì„¸ìš”";
    habitInput.style.background = "#fff";
    habitInput.style.cursor = "text";
    habitInput.focus();
  } else {
    // ë¬´ë£Œ í…Œë§ˆ ì„ íƒ ì‹œ
    habitInput.readOnly = true;
    habitInput.style.background = "#eee";
    habitInput.style.cursor = "not-allowed";
    habitInput.value = themeData[themeType][dayIdx];
    
    // ì„ íƒëœ íƒœê·¸ ê°•ì¡°
    event.target.classList.add('active');
  }
};

// DOM Elements
const email = document.getElementById('email');
const password = document.getElementById('password');
const authDiv = document.getElementById('auth');
const appDiv = document.getElementById('app');
const habitBtn = document.getElementById('habitBtn');
const status = document.getElementById('status');
const welcome = document.getElementById('welcome');
const today = document.getElementById('today');
const loginBtn = document.getElementById('loginBtn');
const logoutBtn = document.getElementById('logoutBtn');
const proCard = document.getElementById("proCard");
const goProBtn = document.getElementById("goProBtn");
const statsDiv = document.getElementById("stats");
const totalDays = document.getElementById("totalDays");
const adminPanel = document.getElementById("adminPanel");
const adminTestBtn = document.getElementById("adminTestBtn");
const userListDiv = document.getElementById("userList");
const darkModeToggle = document.getElementById("darkModeToggle");

// âœ… ì£¼ê°„ ë¦¬í¬íŠ¸ ìš”ì†Œ
const weeklyReport = document.getElementById("weeklyReport");
const weeklyReportBody = document.getElementById("weeklyReportBody");
const weeklyReportLocked = document.getElementById("weeklyReportLocked");
const weeklyGoProBtn = document.getElementById("weeklyGoProBtn");

const todayStr = new Date().toISOString().slice(0,10);
today.innerText = ` ${todayStr}`;

// Login Handler
loginBtn.onclick = async () => {
  if (!email.value || !password.value) {
    alert("ì´ë©”ì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.");
    return;
  }
  if (password.value.length < 6) {
    alert("ë¹„ë°€ë²ˆí˜¸ëŠ” 6ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤");
    return;
  }
  try {
    await signInWithEmailAndPassword(auth, email.value, password.value);
  } catch (error) {
    if (error.code === "auth/user-not-found") {
      await createUserWithEmailAndPassword(auth, email.value, password.value);
    } else if (error.code === "auth/wrong-password") {
      alert("ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤");
    } else if (error.code === "auth/email-already-in-use") {
      alert("ì´ë¯¸ ê°€ì…ëœ ì´ë©”ì¼ì…ë‹ˆë‹¤. ë¡œê·¸ì¸í•˜ì„¸ìš”.");
    } else if (error.code === "auth/invalid-email") {
      alert("ì˜ëª»ëœ ì´ë©”ì¼ í˜•ì‹ì…ë‹ˆë‹¤.");
    } else {
      console.error("Login error:", error);
      alert("ë¡œê·¸ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
    }
  }
};

// Logout Handler
logoutBtn.onclick = () => signOut(auth);

// Auth State Monitor
onAuthStateChanged(auth, async user => {
  if (!user) {
    authDiv.style.display = 'block';
    appDiv.style.display = 'none';
    adminPanel.style.display = 'none'; // ë¡œê·¸ì•„ì›ƒì‹œ ê´€ë¦¬ì íŒ¨ë„ ìˆ¨ê¹€
    return;
  }

  authDiv.style.display = 'none';
  appDiv.style.display = 'block';

  try {
    const tokenResult = await getIdTokenResult(user, true);
    const isAdmin = tokenResult.claims.admin === true;
    const isPro = tokenResult.claims.pro === true;

    console.log("admin?", isAdmin, "pro?", isPro);

    // Admin UI
    if (isAdmin) {
      adminPanel.style.display = "block";
      welcome.innerText = `ğŸ‘‘ ê´€ë¦¬ì ${user.email}`;
      loadAllUsers();
    } else {
      adminPanel.style.display = "none";
      welcome.innerText = `ğŸ‘‹ ${user.email}`;
    }

    // PRO UI
    if (isPro) {
      proCard.style.display = "none";
      statsDiv.style.display = "block";
      status.innerText = "ğŸŒŸ PRO íšŒì›ì…ë‹ˆë‹¤";
      loadStats(user.uid); // PROì¸ ê²½ìš° í†µê³„ ë¡œë“œ
    } else {
      proCard.style.display = "block";
      statsDiv.style.display = "none";
      status.innerText = "ë¬´ë£Œ íšŒì› (í•˜ë£¨ 1ìŠµê´€)";
    }

    // âœ… ì£¼ê°„ ë¦¬í¬íŠ¸ ì—…ë°ì´íŠ¸
    await updateWeeklyReport(user.uid, isPro);

    // âœ… 7ì¼ ì—°ì† ë‹¬ì„± ì‹œ PRO íŒì—…(ë¬´ë£Œ ìœ ì €ë§Œ)
    await maybeShow7DayPopup(user.uid, isPro);
  } catch (e) {
    console.error("Token error:", e);
  }
});

// 3. ìŠµê´€ ì €ì¥ ë¡œì§ ìˆ˜ì • (ê¸°ì¡´ habitBtn.onclick ë¶€ë¶„ ì—…ë°ì´íŠ¸)
habitBtn.onclick = async () => {
  const user = auth.currentUser;
  if(!user) return;

  const habitName = document.getElementById("habitName").value;
  if(habitName === "í…Œë§ˆë¥¼ ì„ íƒí•˜ì„¸ìš”" || !habitName) {
    alert("ìŠµê´€ì„ ì„ íƒí•˜ê±°ë‚˜ ì…ë ¥í•´ì£¼ì„¸ìš”!");
    return;
  }

  const ref = doc(db, "users", user.uid, "habits", todayStr);
  
  await setDoc(ref, {
    done: true,
    name: habitName, // ì–´ë–¤ ìŠµê´€ì„ ì™„ë£Œí–ˆëŠ”ì§€ ì´ë¦„ ì €ì¥
    timestamp: new Date()
  });

  habitBtn.classList.add("done");
  celebrate(); // íš¨ê³¼ í˜¸ì¶œ
};

goProBtn.onclick = () => {
  alert("ğŸ‘‘ ì´ ë²„íŠ¼ì€ ê´€ë¦¬ì í™•ì¸ìš©ì…ë‹ˆë‹¤.\nPRO ê¶Œí•œì€ ì„œë²„(ê´€ë¦¬ì)ì—ì„œë§Œ ë¶€ì—¬ë©ë‹ˆë‹¤.");
};

if (adminTestBtn) {
  adminTestBtn.onclick = () => alert("ğŸ‘‘ ê´€ë¦¬ì ì „ìš© ê¸°ëŠ¥ ì •ìƒ ì‘ë™!");
}

// Dark Mode Logic
function setDarkMode(isDark) {
  if (isDark) {
    document.body.classList.add('dark-mode');
    localStorage.setItem('darkMode', 'enabled');
  } else {
    document.body.classList.remove('dark-mode');
    localStorage.setItem('darkMode', 'disabled');
  }
}

const savedDarkMode = localStorage.getItem('darkMode');
if (savedDarkMode === 'enabled') {
  setDarkMode(true);
} else if (savedDarkMode === 'disabled') {
  setDarkMode(false);
} else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
  setDarkMode(true);
}

darkModeToggle.onclick = () => {
  setDarkMode(!document.body.classList.contains('dark-mode'));
};

// Functions
function dateKeyFromOffset(daysAgo) {
  const d = new Date();
  d.setDate(d.getDate() - daysAgo);
  return d.toISOString().slice(0, 10);
}

async function getConsecutiveStreak(uid) {
  let count = 0;
  let date = new Date();

  while (true) {
    const key = date.toISOString().slice(0, 10);
    const snap = await getDoc(doc(db, "users", uid, "habits", key));
    if (!snap.exists()) break;
    count++;
    date.setDate(date.getDate() - 1);
  }
  return count;
}

// [ìˆ˜ì •ë¨] AI ë¶„ì„ ë¡œì§ì´ í¬í•¨ëœ ë¦¬í¬íŠ¸ í•¨ìˆ˜
async function updateWeeklyReport(uid, isPro) {
  if (!weeklyReport || !weeklyReportBody || !weeklyReportLocked) return;

  // 1. ìµœê·¼ 7ì¼ ë°ì´í„° ìˆ˜ì§‘ ë° ë¶„ì„ ì¤€ë¹„
  let successCount = 0;
  const days = [];
  const dayNames = ["ì¼", "ì›”", "í™”", "ìˆ˜", "ëª©", "ê¸ˆ", "í† "];
  
  // ìš”ì¼ë³„ ì‹¤íŒ¨ íšŸìˆ˜ ì¹´ìš´íŒ… (0:ì¼ ~ 6:í† )
  const failCountsPerDay = [0, 0, 0, 0, 0, 0, 0]; 

  for (let i = 0; i < 7; i++) {
    const key = dateKeyFromOffset(i);
    const snap = await getDoc(doc(db, "users", uid, "habits", key));
    const done = snap.exists();
    
    // ë‚ ì§œ ê°ì²´ ìƒì„±í•˜ì—¬ ìš”ì¼ ì¸ë±ìŠ¤ ì¶”ì¶œ
    const dateObj = new Date(key);
    const dayIdx = dateObj.getDay(); 

    if (done) {
      successCount++;
    } else {
      failCountsPerDay[dayIdx]++; // ì‹¤íŒ¨í•œ ìš”ì¼ ì¹´ìš´íŠ¸ ì¦ê°€
    }
    
    days.push({ key, done, dayName: dayNames[dayIdx] });
  }

  const streak = await getConsecutiveStreak(uid);

  // 2. í‘œì‹œ ì¡°ê±´: 3ì¼ ì´ìƒ ì—°ì† ì„±ê³µ ì‹œ 'ë§›ë³´ê¸°'ë¡œë¼ë„ í‹€ì„ ë³´ì—¬ì¤Œ (ë™ê¸°ë¶€ì—¬ ìœ„í•´ 7ì¼->3ì¼ë¡œ ì™„í™” ì¶”ì²œ)
  if (streak < 3) {
    weeklyReport.style.display = "none";
    return;
  }
  weeklyReport.style.display = "block";

  // 3. ë¬´ë£Œ íšŒì›ì¼ ê²½ìš° (ì ê¸ˆ í™”ë©´)
  if (!isPro) {
    weeklyReportBody.innerHTML = "";
    weeklyReportLocked.style.display = "block";

    // í…ìŠ¤íŠ¸ë¥¼ ë” ìê·¹ì ìœ¼ë¡œ ë³€ê²½
    weeklyReportLocked.querySelector("div > div:nth-child(2)").innerHTML = 
      `<b>${streak}ì¼ ì—°ì† ì„±ê³µ</b> ì¤‘ì…ë‹ˆë‹¤!<br>
      AIê°€ ë¶„ì„í•œ <b>'ì‹¤íŒ¨ íŒ¨í„´ ë¦¬í¬íŠ¸'</b>ê°€ ë„ì°©í–ˆìŠµë‹ˆë‹¤.<br>
      PRO íšŒì›ì´ ë˜ì–´ í™•ì¸í•´ë³´ì„¸ìš”.`;

    if (weeklyGoProBtn) {
      weeklyGoProBtn.onclick = () => {
        alert("ê´€ë¦¬ì íŒ¨ë„ì—ì„œ 'PRO ë¶€ì—¬' ë²„íŠ¼ì„ ëˆŒëŸ¬ë³´ì„¸ìš”!\n(ì‹¤ì œ ê²°ì œ ì—°ë™ ì „ í…ŒìŠ¤íŠ¸)");
      };
    }
    return;
  }

  // 4. PRO íšŒì›ì¼ ê²½ìš° (AI ë¶„ì„ ê²°ê³¼ ì¶œë ¥)
  weeklyReportLocked.style.display = "none";

  const rate = Math.round((successCount / 7) * 100);
  
  // ê°€ì¥ ë§ì´ ì‹¤íŒ¨í•œ ìš”ì¼ ì°¾ê¸° (ìµœëŒ€ê°’ ì¸ë±ìŠ¤ ì°¾ê¸°)
  let maxFailures = -1;
  let worstDayIdx = -1;
  
  failCountsPerDay.forEach((count, idx) => {
    if (count > maxFailures) {
      maxFailures = count;
      worstDayIdx = idx;
    }
  });
  
  const worstDayName = (maxFailures > 0) ? dayNames[worstDayIdx] : null;

  // AI ì¡°ì–¸ ìƒì„± ë¡œì§
  let aiAdvice = "";
  if (rate === 100) {
    aiAdvice = "ì™„ë²½í•©ë‹ˆë‹¤! ì´ëŒ€ë¡œë©´ <b>'ìŠµê´€ ë§ˆìŠ¤í„°'</b> ì¹­í˜¸ê¹Œì§€ ì–¼ë§ˆ ì•ˆ ë‚¨ì•˜ì–´ìš”.";
  } else if (worstDayName) {
    if (worstDayName === "ê¸ˆ") aiAdvice = "<b>ë¶ˆê¸ˆ</b>ì´ë¼ ë§ˆìŒì´ ëœ¨ê¸° ì‰½êµ°ìš”. ê¸ˆìš”ì¼ ëª©í‘œëŠ” ì¡°ê¸ˆ ë” ì‘ê²Œ ì¡ì•„ë³¼ê¹Œìš”?";
    else if (worstDayName === "ì›”") aiAdvice = "<b>ì›”ìš”ë³‘</b>ì´ ìŠµê´€ê¹Œì§€ ë°©í•´í•˜ê³  ìˆì–´ìš”. ì¼ìš”ì¼ ë°¤ì— ë¯¸ë¦¬ ì¤€ë¹„í•´ë‘ë©´ ì–´ë–¨ê¹Œìš”?";
    else if (worstDayName === "í† " || worstDayName === "ì¼") aiAdvice = "ì£¼ë§ì—ëŠ” ë£¨í‹´ì´ ê¹¨ì§€ê¸° ì‰½ì£ . <b>ì˜¤ì „ ì¤‘ì— ë¯¸ë¦¬ í•´ì¹˜ìš°ëŠ” ì „ëµ</b>ì´ í•„ìš”í•©ë‹ˆë‹¤!";
    else aiAdvice = `íšŒì›ë‹˜ì€ ì£¼ë¡œ <b>${worstDayName}ìš”ì¼</b>ì— ì—ë„ˆì§€ê°€ ë–¨ì–´ì§‘ë‹ˆë‹¤. ì´ë‚ ì€ ì•Œë¦¼ì„ 10ë¶„ ì¼ì° ë§ì¶°ë³´ì„¸ìš”.`;
  } else {
    aiAdvice = "ì¡°ê¸ˆë§Œ ë” ë¶„ë°œí•˜ì„¸ìš”! ê¾¸ì¤€í•¨ì´ ì¬ëŠ¥ì„ ì´ê¹ë‹ˆë‹¤.";
  }

  // ë¦¬ìŠ¤íŠ¸ HTML ìƒì„±
  const listHTML = days.reverse().map(d => 
    `<div style="display:flex; justify-content:space-between; font-size:13px; margin-bottom:4px; color:var(--text-color);">
       <span>${d.key} (${d.dayName})</span>
       <span>${d.done ? "âœ… ì„±ê³µ" : "<span style='color:#e53e3e; opacity:0.6;'>Failed</span>"}</span>
     </div>`
  ).join("");

  // ìµœì¢… HTML ì£¼ì…
  weeklyReportBody.innerHTML = `
    <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:10px;">
      <span style="font-weight:900; font-size:16px;">ì´ë²ˆ ì£¼ ì„±ê³µë¥  <span style="color:#667eea;">${rate}%</span></span>
      <span style="font-size:12px; opacity:0.7;">ğŸ”¥ ${streak}ì¼ ì—°ì†</span>
    </div>

    <div class="ai-coach-card">
      <div class="ai-coach-badge">ğŸ¤– AI Habit Coach</div>
      <div class="ai-advice-text">
        ${rate === 100 
          ? aiAdvice 
          : `íšŒì›ë‹˜ì€ íŠ¹íˆ <span class="worst-day-highlight">${worstDayName}ìš”ì¼</span>ì— ì•½í•˜ì‹œë„¤ìš”.<br>ğŸ‘‰ ${aiAdvice}`}
      </div>
    </div>
    <div style="margin-top:12px; padding:12px; border-radius:10px; background:var(--bg-color); border:1px solid var(--input-border);">
      <div style="font-size:12px; opacity:0.6; margin-bottom:8px;">ìƒì„¸ ê¸°ë¡</div>
      ${listHTML}
    </div>
  `;
}

async function maybeShow7DayPopup(uid, isPro) {
  if (isPro) return;

  const streak = await getConsecutiveStreak(uid);
  if (streak < 7) return;

  // âœ… ê°™ì€ ì£¼ì— íŒì—… ë°˜ë³µ ë°©ì§€ (ì£¼ì°¨ í‚¤)
  const now = new Date();
  const weekKey = `${now.getFullYear()}-${Math.ceil((now.getDate()) / 7)}-${now.getMonth()+1}`;
  const storageKey = `hf_7day_popup_${uid}_${weekKey}`;

  if (localStorage.getItem(storageKey) === "shown") return;
  localStorage.setItem(storageKey, "shown");

  alert(
    "ğŸ‰ 7ì¼ ì—°ì† ì„±ê³µ!\n" +
    "ì§€ê¸ˆì´ ìŠµê´€ì´ êµ³ì–´ì§€ëŠ” íƒ€ì´ë°ì´ì—ìš”.\n\n" +
    "PROë¡œ ì—…ê·¸ë ˆì´ë“œí•˜ë©´ â€˜ì£¼ê°„ ë¦¬í¬íŠ¸â€™ë¡œ\n" +
    "ì„±ê³µë¥ /íŒ¨í„´ì„ í™•ì¸í•  ìˆ˜ ìˆì–´ìš”."
  );

  // ìŠ¤í¬ë¡¤ë¡œ ë¦¬í¬íŠ¸ ì˜ì—­ ë³´ì—¬ì£¼ê¸°
  if (weeklyReport) weeklyReport.scrollIntoView({ behavior: "smooth", block: "center" });
}

async function loadStats(uid){
  let count=0;
  let date=new Date();
  while(true){
    const key=date.toISOString().slice(0,10);
    const snap=await getDoc(doc(db,"users",uid,"habits",key));
    if(!snap.exists()) break;
    count++; date.setDate(date.getDate()-1);
  }
  if(totalDays) totalDays.innerText=`ğŸ”¥ ì—°ì† ì„±ê³µ ${count}ì¼`;
}

async function loadAllUsers() {
  if (!userListDiv) return;

  userListDiv.innerHTML = "ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...";

  try {
    const snap = await getDocs(collection(db, "users"));
    userListDiv.innerHTML = "";

    snap.forEach(docSnap => {
      const data = docSnap.data();
      const uid = docSnap.id;

      const box = document.createElement("div");
      box.style.background = "#fff";
      box.style.padding = "12px";
      box.style.borderRadius = "10px";
      box.style.marginBottom = "10px";
      box.style.color = "#333";

      box.innerHTML = `
        <div style="font-size:12px; word-break:break-all;"><b>UID</b>: ${uid}</div>
        <div style="margin:5px 0;"><b>PRO</b>: ${data.isPro ? "âœ…" : "âŒ"}</div>
        <button class="toggleProBtn" style="padding:5px 10px; cursor:pointer;">
          ${data.isPro ? "PRO í•´ì œ" : "PRO ë¶€ì—¬"}
        </button>
      `;

      box.querySelector(".toggleProBtn").onclick = async () => {
        await updateDoc(doc(db, "users", uid), {
          isPro: !data.isPro
        });
        alert("ë³€ê²½ ì™„ë£Œ");
        loadAllUsers();
      };

      userListDiv.appendChild(box);
    });
  } catch (error) {
    console.error("User load error:", error);
    userListDiv.innerHTML = "ê¶Œí•œì´ ì—†ê±°ë‚˜ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨";
  }
}

// ìŠµê´€ ì™„ë£Œ ì‹œ ê°„ë‹¨í•œ ì´í™íŠ¸ í•¨ìˆ˜
function celebrate() {
  const btn = document.getElementById("habitBtn");
  btn.style.transform = "scale(1.1)";
  setTimeout(() => { btn.style.transform = "scale(1)"; }, 200);
  
  // ë¸Œë¼ìš°ì € ê¸°ë³¸ ì•Œë¦¼ ëŒ€ì‹  ì»¤ìŠ¤í…€ ë©”ì‹œì§€
  status.innerHTML = `<span style="color:#22c55e; font-weight:bold; font-size:1.2em;">ğŸ‰ ë¯¸ì…˜ ì™„ë£Œ! ë‚´ì¼ë„ í•¨ê»˜í•´ìš”.</span>`;
}
// [ì¶”ê°€ ì½”ë“œ] 5ì¼ ì—°ì† ì„±ê³µ ì¹˜íŠ¸í‚¤ ë¡œì§
const cheatStreakBtn = document.getElementById("cheatStreakBtn");

if (cheatStreakBtn) {
  cheatStreakBtn.onclick = async () => {
    const user = auth.currentUser;
    if (!user) {
      alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤!");
      return;
    }

    const confirmCheat = confirm("ğŸ§ª í…ŒìŠ¤íŠ¸ ëª¨ë“œ: ì§€ë‚œ 5ì¼ê°„ì˜ ë°ì´í„°ë¥¼ 'ì„±ê³µ'ìœ¼ë¡œ ê°•ì œ ì¡°ì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ?");
    if (!confirmCheat) return;

    try {
      // 0ì¼ì „(ì˜¤ëŠ˜) ~ 4ì¼ì „(ê³¼ê±°)ê¹Œì§€ ì´ 5ì¼ ë£¨í”„
      for (let i = 0; i < 5; i++) {
        // dateKeyFromOffset í•¨ìˆ˜ëŠ” ê¸°ì¡´ ì½”ë“œì— ìˆìœ¼ë¯€ë¡œ ê·¸ëŒ€ë¡œ ì‚¬ìš©
        const dateStr = dateKeyFromOffset(i); 
        
        // Firestoreì— { done: true } ì €ì¥
        await setDoc(doc(db, "users", user.uid, "habits", dateStr), {
          done: true
        });
        console.log(`${dateStr} ì²˜ë¦¬ ì™„ë£Œ`);
      }

      alert("ğŸ‰ 5ì¼ ì—°ì† ì„±ê³µ ë°ì´í„° ìƒì„± ì™„ë£Œ!\nìƒˆë¡œê³ ì¹¨í•˜ì—¬ ë¦¬í¬íŠ¸ë¥¼ í™•ì¸í•˜ì„¸ìš”.");
      location.reload(); // í™”ë©´ ìƒˆë¡œê³ ì¹¨í•´ì„œ ê²°ê³¼ ë°”ë¡œ ë°˜ì˜

    } catch (error) {
      console.error("ì¹˜íŠ¸í‚¤ ì—ëŸ¬:", error);
      alert("ì—ëŸ¬ ë°œìƒ: " + error.message);
    }
  };
}
</script>

<script>
(() => {
  const audio = document.getElementById("bgmAudio");
  const btn = document.getElementById("bgmToggle");
  const vol = document.getElementById("bgmVol");
  const volText = document.getElementById("bgmVolText");

  if (!audio || !btn || !vol || !volText) return;

  // Set initial volume
  audio.volume = Number(vol.value);

  btn.addEventListener("click", async () => {
    try {
      if (audio.paused) {
        await audio.play();
        btn.textContent = "ì¼ì‹œì •ì§€";
      } else {
        audio.pause();
        btn.textContent = "ì¬ìƒ";
      }
    } catch (e) {
      alert("ë¸Œë¼ìš°ì € ì •ì±…ìƒ ìë™ì¬ìƒì´ ë§‰í˜€ìˆì–´ìš”. ë²„íŠ¼ì„ ë‹¤ì‹œ ëˆŒëŸ¬ì£¼ì„¸ìš”!");
      console.log(e);
    }
  });

  vol.addEventListener("input", () => {
    audio.volume = Number(vol.value);
    volText.textContent = Math.round(audio.volume * 100) + "%" ;
  });
})();
</script>
</body>
</html>