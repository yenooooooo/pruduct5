<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>HabitFlow</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pretendard@latest/dist/web/static/pretendard.css">
  <link href="https://fonts.googleapis.com/css2?family=Nanum+Myeongjo:wght@400;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

  <style>
    /* ====== Base Variables & Reset ====== */
    :root {
      --bg-color: #f8fafc;
      --text-main: #0f172a;
      --muted: #64748b;
      --card-bg: rgba(255, 255, 255, 0.72);
      --card-border: rgba(15, 23, 42, 0.08);
      --primary: #6366f1;
      --secondary: #a855f7;
      --shadow: 0 20px 25px -5px rgb(0 0 0 / .08), 0 8px 10px -6px rgb(0 0 0 / .06);
    }

    .dark-mode {
      --bg-color: #020617;
      --text-main: #f8fafc;
      --muted: #94a3b8;
      --card-bg: rgba(2, 6, 23, 0.55);
      --card-border: rgba(148, 163, 184, 0.12);
      --shadow: 0 20px 25px -5px rgb(0 0 0 / .45), 0 8px 10px -6px rgb(0 0 0 / .35);
    }

    * { box-sizing: border-box; }


    /* ====== Layout ====== */
    section { width: 100%; padding: 84px 20px; }
    .container { width: 100%; max-width: 1080px; margin: 0 auto; }
    
    /* Header */
    header {
      position: absolute; top: 0; left: 0; right: 0; padding: 20px 0; z-index: 10;
    }
    .header-inner { display: flex; justify-content: space-between; align-items: center; }
    .logo { font-weight: 900; font-size: 1.2rem; display: flex; align-items: center; gap: 8px; }
    .logo-badge { width: 12px; height: 12px; background: var(--primary); border-radius: 50%; }
    
    nav { display: flex; gap: 20px; align-items: center; }
    nav a { text-decoration: none; color: var(--text-main); font-weight: 700; font-size: 14px; }
    
    /* Section Head */
    .section-head { text-align: center; margin-bottom: 36px; }
    .section-head .kicker {
      display: inline-block; padding: 6px 12px; border-radius: 999px;
      font-size: 12px; font-weight: 800; letter-spacing: -0.2px;
      background: rgba(99, 102, 241, 0.12); color: var(--primary);
    }
    .section-head h2 { margin: 12px 0 8px; font-size: 28px; letter-spacing: -0.6px; }
    .section-head p { margin: 0; color: var(--muted); font-size: 15px; line-height: 1.7; }

    /* Glass Effect */
    .glass {
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      box-shadow: var(--shadow);
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
      border-radius: 22px;
      transition: 0.25s ease;
    }
    .glass:hover { transform: translateY(-4px); }

    /* ====== Hero ====== */
    .hero {
      padding: 140px 20px 80px;
      background: radial-gradient(800px circle at 80% -20%, rgba(168, 85, 247, 0.15), transparent 60%);
    }
    .hero-grid { display: grid; grid-template-columns: 1.2fr 1fr; gap: 48px; align-items: center; }
    .hero-pill {
      display: inline-block; padding: 8px 14px; border-radius: 999px;
      font-size: 13px; font-weight: 800; background: rgba(99, 102, 241, 0.12); color: var(--primary);
    }
    .hero-title { font-size: 46px; line-height: 1.2; letter-spacing: -1px; margin: 18px 0; }
    .hero-desc { font-size: 16px; color: var(--muted); line-height: 1.7; margin-bottom: 24px; }
    
    .hero-actions { display: flex; gap: 12px; }
    .hero-metrics { display: flex; gap: 14px; margin-top: 28px; }
    .metric-card {
      padding: 14px 18px; border-radius: 16px; background: rgba(255,255,255,0.5);
      border: 1px solid var(--card-border); display: flex; flex-direction: column; gap: 4px; font-size: 13px;
    }
    .hero-right { padding: 26px; }
    .recommend-card {
      background: rgba(255,255,255,0.8); border-radius: 16px; padding: 16px;
      margin-top: 14px; display: flex; flex-direction: column; gap: 6px; font-size: 14px; color: #000;
    }

    /* ====== Problems & Features ====== */
    .problem-grid, .features-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-top: 18px; }
    .problem-card, .feature-card { padding: 18px; text-align: left; }
    .feature-icon {
      width: 44px; height: 44px; display: grid; place-items: center; border-radius: 14px;
      background: rgba(99, 102, 241, 0.12); color: var(--primary); font-size: 20px; margin-bottom: 12px;
    }
    .problem-bottom { margin-top: 18px; display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; }
    .problem-pill {
      padding: 12px 14px; border-radius: 16px; border: 1px dashed var(--card-border);
      background: rgba(255, 255, 255, 0.35); color: var(--text-main); font-weight: 800; text-align: center;
    }

    /* ====== Pricing ====== */
    .pricing-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; margin-top: 18px; }
    .price-card { padding: 22px; text-align: left; }
    .price-card.pro { border: 2px solid rgba(99, 102, 241, 0.45); position: relative; }
    .price-card.pro::before {
      content: "ì¶”ì²œ"; position: absolute; top: 14px; right: 14px; font-size: 12px;
      font-weight: 900; padding: 6px 10px; border-radius: 999px;
      background: rgba(99, 102, 241, 0.14); color: var(--primary);
    }

    /* ====== Buttons & Inputs ====== */
    .btn {
      appearance: none; border: 1px solid var(--card-border); background: rgba(255, 255, 255, 0.8);
      color: var(--text-main); padding: 14px; border-radius: 14px; font-weight: 900; cursor: pointer;
      transition: all 0.2s ease;
    }
    .btn:active { transform: scale(0.98); }
    .btn-primary {
      border: none !important; background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: #fff; box-shadow: 0 14px 30px rgba(99, 102, 241, 0.25);
    }
    .btn-ghost { background: transparent; color: var(--text-main); border: 1px solid var(--card-border); }
    
    input {
      width: 100%; padding: 14px; margin-bottom: 10px; border-radius: 12px;
      border: 1px solid var(--card-border); background: rgba(255, 255, 255, 0.5); color: var(--text-main);
    }

    /* ====== Auth & App UI ====== */
    .auth-card { max-width: 400px; margin: 0 auto; padding: 30px; text-align: center; }
    .auth-actions { display: flex; gap: 10px; margin-top: 14px; }
    .auth-actions .btn { flex: 1; }
    .link-btn { border: none; background: transparent; color: var(--muted); font-weight: 800; cursor: pointer; text-decoration: underline; margin-top: 10px; }
    
    .tag-container { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; justify-content: center; }
    .theme-tag {
      padding: 6px 12px; border-radius: 20px; border: 1px solid var(--card-border);
      background: transparent; color: var(--text-main); cursor: pointer; font-size: 13px;
    }
    .theme-tag.active { background: var(--primary); color: white; border-color: var(--primary); }

    .habit {
      width: 100%; padding: 20px; font-size: 18px; font-weight: 900; margin-top: 16px;
      border: none; border-radius: 16px; background: var(--text-main); color: var(--bg-color); cursor: pointer;
    }

    /* ====== Badges ====== */
    .badge { padding: 4px 10px; border-radius: 999px; font-size: 12px; font-weight: 800; color: #fff; }
    .tier-bronze { background: #cd7f32; }
    .tier-silver { background: #c0c0c0; color: #333; }
    .tier-gold { background: #ffd700; color: #333; }
    .tier-platinum { background: #e5e4e2; color: #333; border: 1px solid #ccc; }
    .tier-diamond { background: #b9f2ff; color: #333; }
    .tier-master { background: linear-gradient(135deg, #ff00cc, #333399); }

    /* ====== Responsive ====== */
    @media (max-width: 900px) {
      .hero-grid, .problem-grid, .features-grid, .pricing-grid { grid-template-columns: 1fr; }
      .problem-bottom { grid-template-columns: 1fr; }
    }
    /* ========================= */
/* âœ… ADMIN CONSOLE (NEW UI) */
/* ========================= */

#adminFab{
  position: fixed;
  right: 20px;
  bottom: 20px;
  z-index: 9995;
  width: 56px;
  height: 56px;
  border-radius: 999px;
  border: none;
  cursor: pointer;
  font-size: 22px;
  font-weight: 900;
  background: linear-gradient(135deg, var(--primary), var(--secondary));
  color: #fff;
  box-shadow: 0 12px 28px rgba(0,0,0,0.25);
  transition: transform .2s ease;
}
#adminFab:active{ transform: scale(.96); }

.admin-overlay{
  position: fixed;
  inset: 0;
  z-index: 9999;
  background: rgba(0,0,0,.55);
  backdrop-filter: blur(8px);
  -webkit-backdrop-filter: blur(8px);
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 18px;
}

.admin-shell{
  width: min(1200px, 96vw);
  height: min(760px, 92vh);
  border-radius: 22px;
  overflow: hidden;
  display: grid;
  grid-template-columns: 260px 1fr;
  background: rgba(255,255,255,.78);
  border: 1px solid rgba(15,23,42,0.12);
  box-shadow: 0 30px 80px rgba(0,0,0,.35);
}

.dark-mode .admin-shell{
  background: rgba(2,6,23,.72);
  border: 1px solid rgba(148,163,184,0.18);
}

.admin-sidebar{
  padding: 16px;
  border-right: 1px solid rgba(15,23,42,.08);
  background: rgba(255,255,255,.55);
}
.dark-mode .admin-sidebar{
  background: rgba(2,6,23,.45);
  border-right: 1px solid rgba(148,163,184,0.12);
}

.admin-brand{
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 10px 10px 14px;
}
.admin-dot{
  width: 12px; height: 12px;
  border-radius: 999px;
  background: var(--primary);
}
.admin-title{ font-weight: 900; font-size: 14px; }
.admin-sub{ font-size: 12px; color: var(--muted); margin-top: 2px; }

.admin-nav{
  display: grid;
  gap: 8px;
  margin-top: 8px;
}
.admin-tab{
  width: 100%;
  text-align: left;
  padding: 10px 12px;
  border-radius: 14px;
  border: 1px solid rgba(15,23,42,.08);
  background: rgba(255,255,255,.6);
  cursor: pointer;
  font-weight: 900;
  color: var(--text-main);
}
.dark-mode .admin-tab{
  background: rgba(2,6,23,.35);
  border: 1px solid rgba(148,163,184,0.12);
}
.admin-tab.active{
  border: none;
  color: #fff;
  background: linear-gradient(135deg, var(--primary), var(--secondary));
}

.admin-side-actions{
  display: grid;
  gap: 10px;
  margin-top: auto;
  padding: 12px 6px 6px;
}

.admin-main{
  padding: 16px;
  overflow: auto;
}

.admin-topbar{
  display: flex;
  justify-content: space-between;
  align-items: end;
  gap: 12px;
  margin-bottom: 14px;
}
.admin-h1{
  font-weight: 900;
  font-size: 18px;
  letter-spacing: -0.4px;
}
.admin-hint{ color: var(--muted); font-size: 13px; margin-top: 4px; }

.admin-grid-kpi{
  display: grid;
  grid-template-columns: repeat(4, minmax(0, 1fr));
  gap: 12px;
}
@media (max-width: 980px){
  .admin-shell{ grid-template-columns: 1fr; }
  .admin-sidebar{ display:none; }
  .admin-grid-kpi{ grid-template-columns: repeat(2, minmax(0,1fr)); }
}
@media (max-width: 520px){
  .admin-grid-kpi{ grid-template-columns: 1fr; }
}

.admin-kpi{ padding: 14px; }
.admin-kpi-label{ color: var(--muted); font-size: 12px; font-weight: 800; }
.admin-kpi-value{ font-size: 22px; font-weight: 900; margin-top: 6px; }

.admin-two-col{
  display: grid;
  grid-template-columns: 1.2fr .8fr;
  gap: 12px;
  margin-top: 12px;
}
@media (max-width: 980px){
  .admin-two-col{ grid-template-columns: 1fr; }
}

.admin-box-title{
  font-weight: 900;
  font-size: 14px;
  margin-bottom: 10px;
}

.admin-toolbar{
  display: grid;
  grid-template-columns: 1fr 160px 160px 140px;
  gap: 10px;
  align-items: center;
}
@media (max-width: 980px){
  .admin-toolbar{ grid-template-columns: 1fr; }
}

.admin-input, .admin-select, .admin-textarea{
  width: 100%;
  border-radius: 12px;
  padding: 12px 12px;
  border: 1px solid rgba(15,23,42,.10);
  background: rgba(255,255,255,.75);
  color: var(--text-main);
  outline: none;
}
.dark-mode .admin-input, .dark-mode .admin-select, .dark-mode .admin-textarea{
  background: rgba(2,6,23,.35);
  border: 1px solid rgba(148,163,184,0.14);
}

.admin-textarea{ min-height: 110px; resize: vertical; }

.admin-table-head{
  display: grid;
  grid-template-columns: 1.6fr .5fr .7fr .6fr .6fr .6fr;
  gap: 10px;
  padding: 10px 10px;
  font-size: 12px;
  font-weight: 900;
  color: var(--muted);
  border-bottom: 1px solid rgba(15,23,42,.08);
}
.admin-table-row{
  display: grid;
  grid-template-columns: 1.6fr .5fr .7fr .6fr .6fr .6fr;
  gap: 10px;
  padding: 10px 10px;
  border-bottom: 1px solid rgba(15,23,42,.06);
  align-items: center;
  font-size: 13px;
}
.admin-pill{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  padding: 4px 10px;
  border-radius: 999px;
  font-size: 11px;
  font-weight: 900;
  border: 1px solid rgba(15,23,42,.10);
  background: rgba(255,255,255,.6);
}
.dark-mode .admin-pill{
  background: rgba(2,6,23,.35);
  border: 1px solid rgba(148,163,184,0.14);
}

.admin-list{
  display: grid;
  gap: 10px;
  font-size: 13px;
}
.admin-muted{ color: var(--muted); }

.admin-form-row{ margin: 10px 0; }

.admin-switch{
  display:flex;
  align-items:center;
  gap:10px;
  cursor:pointer;
  font-weight:900;
  font-size:13px;
  color: var(--text-main);
}
.admin-switch input{ display:none; }
.admin-switch-ui{
  width: 44px;
  height: 26px;
  border-radius: 999px;
  position: relative;
  background: rgba(0,0,0,.15);
  transition: .2s ease;
}
.admin-switch-ui::after{
  content:"";
  position:absolute;
  top:3px; left:3px;
  width:20px; height:20px;
  border-radius:999px;
  background:#fff;
  transition:.2s ease;
}
.admin-switch input:checked + .admin-switch-ui{
  background: rgba(99,102,241,.55);
}
.admin-switch input:checked + .admin-switch-ui::after{
  left: 21px;
}

.admin-modal{
  position: fixed;
  inset: 0;
  z-index: 10000;
  background: rgba(0,0,0,.55);
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 16px;
}
.admin-modal-card{
  width: min(860px, 95vw);
  height: min(740px, 92vh);
  background: rgba(255,255,255,.95);
  border-radius: 20px;
  overflow: hidden;
  display: flex;
  flex-direction: column;
  box-shadow: 0 30px 80px rgba(0,0,0,.35);
}
.dark-mode .admin-modal-card{ background: rgba(2,6,23,.85); }

.admin-modal-head{
  padding: 14px 16px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  border-bottom: 1px solid rgba(15,23,42,.08);
}
.admin-x{
  width: 38px; height: 38px;
  border-radius: 12px;
  border: 1px solid rgba(15,23,42,.10);
  background: rgba(255,255,255,.65);
  cursor: pointer;
  font-weight: 900;
}
.dark-mode .admin-x{
  background: rgba(2,6,23,.35);
  border: 1px solid rgba(148,163,184,0.14);
}

.admin-modal-tabs{
  display:flex;
  gap: 8px;
  padding: 12px 16px;
  border-bottom: 1px solid rgba(15,23,42,.08);
}
.um-tab{
  padding: 8px 10px;
  border-radius: 12px;
  border: 1px solid rgba(15,23,42,.10);
  background: rgba(255,255,255,.65);
  cursor:pointer;
  font-weight: 900;
  font-size: 12px;
}
.dark-mode .um-tab{
  background: rgba(2,6,23,.35);
  border: 1px solid rgba(148,163,184,0.14);
}
.um-tab.active{
  border: none;
  color:#fff;
  background: linear-gradient(135deg, var(--primary), var(--secondary));
}
.admin-modal-body{
  padding: 14px 16px;
  overflow: auto;
}
  </style>
</head>
<body>

  <header>
    <div class="container header-inner">
      <div class="logo">
        <div class="logo-badge"></div>
        HabitFlow
      </div>
      <nav>
        <a href="#features" class="pc-only">ê¸°ëŠ¥</a>
        <a href="#pricing" class="pc-only">ê°€ê²©</a>
        <button class="btn btn-primary" onclick="scrollToAuth()" style="padding: 8px 16px; font-size: 14px;">ì‹œì‘í•˜ê¸°</button>
        <button id="darkModeToggle" class="btn btn-ghost" style="padding: 8px;">ğŸŒ“</button>
      </nav>
    </div>
  </header>  

  <section class="hero">
    <div class="container hero-grid">
      <div class="hero-left">
        <span class="hero-pill">âœ¨ í•˜ë£¨ í•˜ë‚˜ë¡œ ì¶©ë¶„í•´ìš”</span>
        <h1 class="hero-title">í•˜ë£¨ í•˜ë‚˜,<br />ì¸ìƒì„ ë°”ê¾¸ëŠ” ìŠµê´€</h1>
        <p class="hero-desc">
          ì‘ì‹¬ì‚¼ì¼ì„ ëë‚´ëŠ” ê°€ì¥ ë‹¨ìˆœí•œ ë°©ì‹.<br />
          ë²„íŠ¼ í•œ ë²ˆìœ¼ë¡œ ê¸°ë¡í•˜ê³ , ì—°ì† ê¸°ë¡ìœ¼ë¡œ ë™ê¸°ë¶€ì—¬ë¥¼ ìœ ì§€í•˜ì„¸ìš”.
        </p>
        <div class="hero-actions">
          <button class="btn btn-primary" onclick="scrollToAuth()">ì§€ê¸ˆ ì‹œì‘í•˜ê¸°</button>
          <a href="#pricing" class="btn btn-ghost">ê°€ê²© ë³´ê¸°</a>
        </div>
        <div class="hero-metrics">
          <div class="metric-card"><b>1 Habit</b><span>í•˜ë£¨ ë”± í•˜ë‚˜</span></div>
          <div class="metric-card"><b>Streak</b><span>ì—°ì† ê¸°ë¡</span></div>
          <div class="metric-card"><b>Report</b><span>ì£¼ê°„ ë¦¬í¬íŠ¸</span></div>
        </div>
      </div>

      <div class="hero-right glass">
        <h3>ì˜¤ëŠ˜ì˜ ì¶”ì²œ ë£¨í‹´</h3>
        <p>ë¡œê·¸ì¸ í›„ í…Œë§ˆë¥¼ ì„ íƒí•˜ë©´ ì˜¤ëŠ˜ ìŠµê´€ì´ ìë™ìœ¼ë¡œ ì¶”ì²œë¼ìš”.</p>
        <div class="recommend-card">
          <div>ğŸš‘ <b>ìƒì¡´ ì²´ë ¥ íŒ©</b></div>
          <span style="font-size:12px; color:#555">ì§ì¥ì¸ì„ ìœ„í•œ â€œì£½ì§€ ì•Šìœ¼ë ¤ê³  í•˜ëŠ” ìš´ë™â€</span>
        </div>
        <div class="recommend-card">
          <div>âœ¨ <b>ê°“ìƒ ì…ë¬¸ íŒ©</b></div>
          <span style="font-size:12px; color:#555">ì„±ê³µ ë£¨í‹´ì„ 2ë¶„ì§œë¦¬ë¡œ ìª¼ê°œê¸°</span>
        </div>
      </div>
    </div>
  </section>

  <section class="problem">
    <div class="container">
      <div class="section-head">
        <span class="kicker">WHY</span>
        <h2>ì™œ ìŠµê´€ì€ í•­ìƒ ì‹¤íŒ¨í• ê¹Œ?</h2>
        <p>HabitFlowëŠ” â€œë”± 1ê°œë§Œ, ë²„íŠ¼ 1ë²ˆâ€ìœ¼ë¡œ ì‹¤í–‰ ì¥ë²½ì„ ìµœì†Œí™”í•©ë‹ˆë‹¤.</p>
      </div>
      <div class="problem-grid">
        <div class="problem-card glass">
          <h3>ğŸ¯ ëª©í‘œê°€ ë„ˆë¬´ ë§ë‹¤</h3>
          <p>ìš•ì‹¬ì´ ì»¤ì§ˆìˆ˜ë¡ ì‹œì‘ì´ ì–´ë ¤ì›Œì ¸ìš”. í•˜ë£¨ 1ê°œë§Œ ë‚¨ê¹ë‹ˆë‹¤.</p>
        </div>
        <div class="problem-card glass">
          <h3>ğŸ“ ê¸°ë¡ì´ ê·€ì°®ë‹¤</h3>
          <p>ê¸°ë¡ì´ ë²ˆê±°ë¡œìš°ë©´ í¬ê¸° í™•ë¥ ì´ ì˜¬ë¼ê°€ìš”. ë²„íŠ¼ í•œ ë²ˆì´ë©´ ë.</p>
        </div>
        <div class="problem-card glass">
          <h3>ğŸ“‰ ì„±ì·¨ê°€ ëˆˆì— ì•ˆ ë³´ì¸ë‹¤</h3>
          <p>ìŒ“ì´ëŠ” ëŠë‚Œì´ ì—†ìœ¼ë©´ ì§€ì†ì´ ì–´ë µì£ . ì—°ì† ê¸°ë¡ì„ ì¦‰ì‹œ ë³´ì—¬ì¤ë‹ˆë‹¤.</p>
        </div>
      </div>
    </div>
  </section>

  <section id="authSection" style="padding-top: 40px; min-height: 80vh;">
    <div class="container" style="display:flex; justify-content:center;">
      
      <div id="auth" class="auth-card glass">
        <h2>HabitFlow ì‹œì‘í•˜ê¸°</h2>
        <p style="color:var(--muted); margin-bottom:24px;">ì´ë©”ì¼ë¡œ ê°„í¸í•˜ê²Œ ì‹œì‘í•˜ì„¸ìš”</p>
        
        <input id="email" placeholder="ì´ë©”ì¼ ì£¼ì†Œ">
        <input id="password" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸ (6ì ì´ìƒ)">
        
        <div class="auth-actions">
           <button id="signupBtn" class="btn btn-primary" type="button">íšŒì›ê°€ì…</button>
           <button id="signinBtn" class="btn btn-ghost" type="button">ë¡œê·¸ì¸</button>
        </div>
        
        <div style="margin-top:16px;">
          <button id="resetPwBtn" class="link-btn" type="button">ë¹„ë°€ë²ˆí˜¸ ì°¾ê¸°</button>
        </div>
        
        <p id="authHint" style="margin-top:20px; font-size:13px; color:var(--muted);">
          ì²˜ìŒì´ë©´ <b>íšŒì›ê°€ì…</b> â†’ ë©”ì¼ ì¸ì¦ í›„ ë¡œê·¸ì¸í•˜ì„¸ìš”.
        </p>
      </div>

      <div id="app" class="glass" style="width:100%; max-width:480px; padding:30px; display:none; text-align:center;">
        <div style="display:flex; justify-content:space-between; align-items:center;">
          <h2 id="welcome" style="margin:0; font-size: 1.2rem;"></h2>
          <button id="logoutBtn" style="background:none; border:none; color:var(--muted); font-size:0.8rem; text-decoration:underline; cursor:pointer;">ë¡œê·¸ì•„ì›ƒ</button>
        </div>

        <div id="tierBadge" style="display:none; margin: 20px 0;">
          <span id="tierText" class="badge"></span>
          <p id="streakCount" style="font-size: 0.9rem; margin-top: 8px; font-weight:700;"></p>
        </div>

        <div id="themeSection" style="margin-top:24px;">
           <p style="font-size: 0.9rem; font-weight: 700; margin-bottom:10px;">ğŸ ì˜¤ëŠ˜ì˜ ë£¨í‹´ íŒ© ì„ íƒ</p>
           <div class="tag-container">
              <button class="theme-tag" onclick="selectTheme(this, 'survival')">ğŸš‘ ìƒì¡´</button>
              <button class="theme-tag" onclick="selectTheme(this, 'godsaeng')">âœ¨ ê°“ìƒ</button>
              <button class="theme-tag" onclick="selectTheme(this, 'detox')">ğŸ“± ë””í†¡ìŠ¤</button>
              <button class="theme-tag" onclick="selectTheme(this, 'custom')">â• ì»¤ìŠ¤í…€</button>
           </div>
        </div>
        
        <div id="todaySuggestion" style="margin-top:16px; font-size:0.9rem; padding:12px; background:rgba(99,102,241,0.1); border-radius:12px; color:var(--text-main);">
          í…Œë§ˆë¥¼ ì„ íƒí•˜ë©´ ì˜¤ëŠ˜ í•  ì¼ì´ ì¶”ì²œë©ë‹ˆë‹¤.
        </div>
        
        <input id="habitName" readonly value="í…Œë§ˆë¥¼ ì„ íƒí•˜ì„¸ìš”" style="margin-top: 20px; text-align: center; font-weight:700;">
        <button id="habitBtn" class="habit">ì˜¤ëŠ˜ ìŠµê´€ ì™„ë£Œ âœ…</button>
        <p id="status" style="margin-top:12px; font-size:14px; color:var(--primary); font-weight:700; min-height:20px;"></p>
        
        <div id="stats" style="display:none; margin-top:20px; padding:16px; background:rgba(255,255,255,0.5); border-radius:12px;">
          <h3 style="margin:0 0 10px; font-size:16px;">ğŸ“Š ë‚˜ì˜ ìŠµê´€ í†µê³„</h3>
          <p id="totalDays" style="margin:0; font-weight:700;"></p>
        </div>

        <button id="restoreStreakBtn" style="margin-top:10px; width:100%; padding:12px; border-radius:12px; background:#f59e0b; color:white; border:none; font-weight:800; display:none; cursor:pointer;">
          ğŸ”¥ ì—°ì† ê¸°ë¡ ë³µêµ¬ (PRO)
        </button>

        <div id="weeklyReport" style="display:none; width: 100%; margin-top: 30px; text-align: left;">
          <div id="weeklyReportBody"></div>
          <div id="weeklyReportLocked" style="display:none; padding: 24px; border: 2px dashed var(--card-border); border-radius: 16px; text-align: center;">
             <span style="font-size: 2rem; display:block; margin-bottom:10px;">ğŸ”’</span>
             <div>
                <b>-ì¼ ì—°ì† ì„±ê³µ</b> ì¤‘ì…ë‹ˆë‹¤!<br>
                AIê°€ ë¶„ì„í•œ <b>'ì‹¤íŒ¨ íŒ¨í„´ ë¦¬í¬íŠ¸'</b>ê°€ ë„ì°©í–ˆìŠµë‹ˆë‹¤.<br>
                PRO íšŒì›ì´ ë˜ì–´ í™•ì¸í•´ë³´ì„¸ìš”.
             </div>
             <button id="weeklyGoProBtn" class="btn btn-primary" style="margin-top: 15px; font-size:13px;" onclick="showProModal()">ë¦¬í¬íŠ¸ ì ê¸ˆ í•´ì œí•˜ê¸°</button>
          </div>
        </div>

        <div id="calendarSection" style="display:none; margin-top:30px; text-align:left;">
          <h3 style="font-size:16px; margin-bottom:10px;">ğŸ“… ì´ë²ˆ ë‹¬ ê¸°ë¡</h3>
          <div id="calendarGrid" style="display:grid; grid-template-columns: repeat(7, 1fr); gap:6px;"></div>
        </div>

      </div>

    </div>
  </section>

  <section id="pricing">
    <div class="container">
      <div class="section-head">
        <span class="kicker">PRICING</span>
        <h2>ê°€ê²©</h2>
        <p>ë¬´ë£Œë¡œ ì‹œì‘í•˜ê³ , íŒ¨í„´ ë¶„ì„ì´ í•„ìš”í•  ë•Œ PROë¡œ ì—…ê·¸ë ˆì´ë“œí•˜ì„¸ìš”.</p>
      </div>
      <div class="pricing-grid">
        <div class="price-card glass">
          <div class="plan">ë¬´ë£Œ</div>
          <div class="amount">â‚©0</div>
          <div class="desc">ê°€ë³ê²Œ ë£¨í‹´ì„ ë§Œë“¤ê³  ì‹¶ì€ ë¶„ì—ê²Œ</div>
          <ul>
            <li>âœ… í•˜ë£¨ 1ìŠµê´€</li>
            <li>âœ… ê¸°ë³¸ í…Œë§ˆ ì¶”ì²œ</li>
            <li>âœ… ê¸°ë³¸ ìŠ¤íŠ¸ë¦­ í™•ì¸</li>
          </ul>
        </div>
        <div class="price-card glass pro" id="proCard">
          <div class="plan">PRO</div>
          <div class="amount">â‚©3,900</div>
          <div class="desc">ìŠµê´€ì´ ë¬´ë„ˆì§€ëŠ” â€œíŒ¨í„´â€ì„ ì¡ê³  ì‹¶ì€ ë¶„ì—ê²Œ</div>
          <ul>
            <li>âœ¨ ìŠµê´€ ë¬´ì œí•œ + ì»¤ìŠ¤í…€</li>
            <li>âœ¨ ì£¼ê°„ ë¦¬í¬íŠ¸/AI ë¶„ì„</li>
            <li>âœ¨ ìº˜ë¦°ë”/í†µê³„/ë³µêµ¬ê¶Œ</li>
          </ul>
          <button id="goProBtn" class="btn btn-primary" style="width:100%; margin-top:14px;" onclick="showProModal()">PROë¡œ ì—…ê·¸ë ˆì´ë“œ</button>
        </div>
      </div>
    </div>
  </section>

  <footer>
    <div class="container" style="text-align:center; padding-bottom:40px; color:var(--muted); font-size:14px;">
      <p>Â© 2026 HabitFlow. All rights reserved.</p>
      <p>support@habitflow.app</p>
    </div>
  </footer>

<!-- ========================= -->
<!-- âœ… ADMIN CONSOLE (NEW UI) -->
<!-- ========================= -->

<!-- 1) ìš°ì¸¡ í•˜ë‹¨ í”Œë¡œíŒ… ë²„íŠ¼ -->
<button id="adminFab" aria-label="Admin Console">ğŸ‘‘</button>

<!-- 2) ê´€ë¦¬ì ì½˜ì†” ì˜¤ë²„ë ˆì´ -->
<div id="adminOverlay" class="admin-overlay" style="display:none;">
  <div class="admin-shell">
    <!-- Left: Sidebar -->
    <aside class="admin-sidebar">
      <div class="admin-brand">
        <div class="admin-dot"></div>
        <div>
          <div class="admin-title">HabitFlow Admin</div>
          <div id="adminMe" class="admin-sub">â€”</div>
        </div>
      </div>

      <nav class="admin-nav">
        <button class="admin-tab active" data-tab="dash">ëŒ€ì‹œë³´ë“œ</button>
        <button class="admin-tab" data-tab="users">ìœ ì €</button>
        <button class="admin-tab" data-tab="notice">ê³µì§€/íŒì—…</button>
        <button class="admin-tab" data-tab="logs">ìš´ì˜ ë¡œê·¸</button>
        <button class="admin-tab" data-tab="settings">ì„¤ì •</button>
      </nav>

      <div class="admin-side-actions">
        <button id="adminRefresh" class="btn btn-ghost" type="button">ìƒˆë¡œê³ ì¹¨</button>
        <button id="adminClose" class="btn" type="button">ë‹«ê¸°</button>
      </div>
    </aside>

    <!-- Right: Main -->
    <main class="admin-main">
      <!-- Header -->
      <div class="admin-topbar">
        <div>
          <div id="adminSectionTitle" class="admin-h1">ëŒ€ì‹œë³´ë“œ</div>
          <div class="admin-hint">ìš´ì˜ ìƒíƒœë¥¼ í•œëˆˆì— í™•ì¸í•˜ê³  ìœ ì €ë¥¼ ê´€ë¦¬í•˜ì„¸ìš”.</div>
        </div>
      </div>

      <!-- CONTENT: DASH -->
      <section class="admin-panel" data-panel="dash">
        <div class="admin-grid-kpi">
          <div class="admin-kpi glass">
            <div class="admin-kpi-label">ìµœê·¼ 7ì¼ í™œë™ ìœ ì €</div>
            <div id="kpiWAU" class="admin-kpi-value">â€”</div>
          </div>
          <div class="admin-kpi glass">
            <div class="admin-kpi-label">PRO ìœ ì € ìˆ˜</div>
            <div id="kpiPRO" class="admin-kpi-value">â€”</div>
          </div>
          <div class="admin-kpi glass">
            <div class="admin-kpi-label">íœ´ë©´ ìœ ì €(14ì¼+)</div>
            <div id="kpiDormant" class="admin-kpi-value">â€”</div>
          </div>
          <div class="admin-kpi glass">
            <div class="admin-kpi-label">ê°€ì… ìœ ì € ì´ê³„</div>
            <div id="kpiTotal" class="admin-kpi-value">â€”</div>
          </div>
        </div>

        <div class="admin-two-col">
          <div class="glass" style="padding:16px;">
            <div class="admin-box-title">ìµœê·¼ ê°€ì… ìœ ì €</div>
            <div id="dashRecentUsers" class="admin-list">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
          </div>

          <div class="glass" style="padding:16px;">
            <div class="admin-box-title">ìš´ì˜ ë©”ëª¨</div>
            <div class="admin-muted" style="font-size:13px; line-height:1.6;">
              - ëŒ€ì‹œë³´ë“œ KPIëŠ” Firestore users ì»¬ë ‰ì…˜ ê¸°ì¤€ì…ë‹ˆë‹¤.<br>
              - lastActiveAt / createdAt í•„ë“œê°€ ìˆìœ¼ë©´ ë” ì •í™•í•´ì§‘ë‹ˆë‹¤.
            </div>
          </div>
        </div>
      </section>

      <!-- CONTENT: USERS -->
      <section class="admin-panel" data-panel="users" style="display:none;">
        <div class="admin-toolbar glass" style="padding:12px;">
          <input id="userSearch" class="admin-input" placeholder="ì´ë©”ì¼ / UID ê²€ìƒ‰" />
          <select id="userFilter" class="admin-select">
            <option value="all">ì „ì²´</option>
            <option value="pro">PROë§Œ</option>
            <option value="free">ë¬´ë£Œë§Œ</option>
            <option value="dormant">íœ´ë©´(14ì¼+)</option>
            <option value="banned">ì°¨ë‹¨</option>
          </select>
          <select id="userSort" class="admin-select">
            <option value="recent">ìµœê·¼ í™œë™ìˆœ</option>
            <option value="created">ê°€ì… ìµœì‹ ìˆœ</option>
            <option value="success">ëˆ„ì  ì„±ê³µìˆœ</option>
          </select>
          <button id="userReload" class="btn btn-ghost" type="button">ëª©ë¡ ìƒˆë¡œê³ ì¹¨</button>
        </div>

        <div class="glass" style="padding:12px; margin-top:12px;">
          <div class="admin-table-head">
            <div>ìœ ì €</div>
            <div>ë“±ê¸‰</div>
            <div>ìµœê·¼í™œë™</div>
            <div>ëˆ„ì ì„±ê³µ</div>
            <div>ìƒíƒœ</div>
            <div style="text-align:right;">ì•¡ì…˜</div>
          </div>
          <div id="userTable" class="admin-table-body">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
        </div>
      </section>

      <!-- CONTENT: NOTICE -->
      <section class="admin-panel" data-panel="notice" style="display:none;">
        <div class="glass" style="padding:16px;">
          <div class="admin-box-title">ë°°ë„ˆ ê³µì§€</div>
          <div class="admin-form-row">
            <label class="admin-switch">
              <input id="bannerEnabled" type="checkbox" />
              <span class="admin-switch-ui"></span>
              <span>ë°°ë„ˆ í™œì„±í™”</span>
            </label>
          </div>
          <div class="admin-form-row">
            <input id="bannerText" class="admin-input" placeholder="ë°°ë„ˆ ë¬¸êµ¬" />
          </div>
          <div class="admin-form-row">
            <input id="bannerLink" class="admin-input" placeholder="ë°°ë„ˆ ë§í¬(ì„ íƒ)" />
          </div>
          <button id="saveBanner" class="btn btn-primary" type="button" style="width:220px;">ë°°ë„ˆ ì €ì¥</button>
        </div>

        <div class="glass" style="padding:16px; margin-top:12px;">
          <div class="admin-box-title">íŒì—… ê³µì§€</div>
          <div class="admin-form-row">
            <label class="admin-switch">
              <input id="popupEnabled" type="checkbox" />
              <span class="admin-switch-ui"></span>
              <span>íŒì—… í™œì„±í™”</span>
            </label>
          </div>
          <div class="admin-form-row">
            <input id="popupTitle" class="admin-input" placeholder="íŒì—… ì œëª©" />
          </div>
          <div class="admin-form-row">
            <textarea id="popupBody" class="admin-textarea" placeholder="íŒì—… ë‚´ìš©"></textarea>
          </div>
          <div class="admin-form-row">
            <input id="popupCtaText" class="admin-input" placeholder="ë²„íŠ¼ ë¬¸êµ¬(ì„ íƒ)" />
          </div>
          <div class="admin-form-row">
            <input id="popupCtaLink" class="admin-input" placeholder="ë²„íŠ¼ ë§í¬(ì„ íƒ)" />
          </div>
          <button id="savePopup" class="btn btn-primary" type="button" style="width:220px;">íŒì—… ì €ì¥</button>
        </div>
      </section>

      <!-- CONTENT: LOGS -->
      <section class="admin-panel" data-panel="logs" style="display:none;">
        <div class="glass" style="padding:16px;">
          <div class="admin-box-title">ìš´ì˜ ë¡œê·¸ (ìµœê·¼ 50ê°œ)</div>
          <div id="adminLogs" class="admin-list">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
        </div>
      </section>

      <!-- CONTENT: SETTINGS -->
      <section class="admin-panel" data-panel="settings" style="display:none;">
        <div class="glass" style="padding:16px;">
          <div class="admin-box-title">ê´€ë¦¬ì ì„¤ì •</div>
          <div class="admin-muted" style="font-size:13px; line-height:1.7;">
            - ê´€ë¦¬ì ì ‘ê·¼ì€ <b>Firebase Custom Claims(admin=true)</b>ê°€ ê°€ì¥ ì•ˆì „í•©ë‹ˆë‹¤.<br>
            - ì§€ê¸ˆì€ ë°ëª¨ìš©ìœ¼ë¡œ â€œê´€ë¦¬ì ì´ë©”ì¼â€ë„ í—ˆìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤(ì•„ë˜ JSì—ì„œ ì„¤ì •).<br>
          </div>
        </div>
      </section>
    </main>
  </div>
</div>

<!-- 3) ìœ ì € ìƒì„¸ ëª¨ë‹¬ -->
<div id="adminUserModal" class="admin-modal" style="display:none;">
  <div class="admin-modal-card">
    <div class="admin-modal-head">
      <div>
        <div id="umTitle" style="font-weight:900; font-size:16px;">ìœ ì € ìƒì„¸</div>
        <div id="umSub" class="admin-muted" style="font-size:12px;">â€”</div>
      </div>
      <button id="umClose" class="admin-x">âœ–</button>
    </div>

    <div class="admin-modal-tabs">
      <button class="um-tab active" data-umtab="overview">ê°œìš”</button>
      <button class="um-tab" data-umtab="actions">ì¡°ì¹˜</button>
      <button class="um-tab" data-umtab="notes">ë©”ëª¨</button>
    </div>

    <div class="admin-modal-body">
      <div class="um-panel" data-umpanel="overview">
        <div class="admin-grid-kpi" style="grid-template-columns: repeat(2, minmax(0,1fr));">
          <div class="admin-kpi glass"><div class="admin-kpi-label">ë“±ê¸‰</div><div id="umPlan" class="admin-kpi-value">â€”</div></div>
          <div class="admin-kpi glass"><div class="admin-kpi-label">ëˆ„ì  ì„±ê³µ</div><div id="umTotal" class="admin-kpi-value">â€”</div></div>
          <div class="admin-kpi glass"><div class="admin-kpi-label">ìµœê·¼ í™œë™</div><div id="umLast" class="admin-kpi-value">â€”</div></div>
          <div class="admin-kpi glass"><div class="admin-kpi-label">ìƒíƒœ</div><div id="umStatus" class="admin-kpi-value">â€”</div></div>
        </div>
        <div class="glass" style="padding:12px; margin-top:12px;">
          <div class="admin-box-title">ìµœê·¼ ê¸°ë¡(ìµœëŒ€ 10ê°œ)</div>
          <div id="umHabits" class="admin-list">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
        </div>
      </div>

      <div class="um-panel" data-umpanel="actions" style="display:none;">
        <div class="glass" style="padding:12px;">
          <div class="admin-box-title">ìƒíƒœ ë³€ê²½</div>
          <div class="admin-form-row">
            <select id="umStatusSelect" class="admin-select">
              <option value="active">ACTIVE</option>
              <option value="warned">WARNED</option>
              <option value="banned">BANNED</option>
            </select>
          </div>
          <div class="admin-form-row">
            <input id="umReason" class="admin-input" placeholder="ì‚¬ìœ (ì„ íƒ)" />
          </div>
          <button id="umSaveStatus" class="btn btn-primary" type="button" style="width:220px;">ìƒíƒœ ì €ì¥</button>
        </div>

        <div class="glass" style="padding:12px; margin-top:12px;">
          <div class="admin-box-title">PRO í† ê¸€(ë°ëª¨)</div>
          <div class="admin-muted" style="font-size:12px; line-height:1.6;">
            ì‹¤ì œ ìš´ì˜ì€ Custom Claimsê°€ ì•ˆì „í•˜ì§€ë§Œ, ì§€ê¸ˆì€ <b>users/{uid}.isPro</b>ë¡œ ë°ëª¨ í† ê¸€í•©ë‹ˆë‹¤.
          </div>
          <button id="umTogglePro" class="btn btn-ghost" type="button" style="margin-top:10px; width:220px;">PRO í† ê¸€</button>
        </div>
      </div>

      <div class="um-panel" data-umpanel="notes" style="display:none;">
        <div class="glass" style="padding:12px;">
          <div class="admin-box-title">ìš´ì˜ì ë©”ëª¨</div>
          <textarea id="umNoteText" class="admin-textarea" placeholder="ë©”ëª¨ë¥¼ ì…ë ¥í•˜ì„¸ìš”"></textarea>
          <button id="umAddNote" class="btn btn-primary" type="button" style="width:220px; margin-top:10px;">ë©”ëª¨ ì¶”ê°€</button>
          <div id="umNotes" class="admin-list" style="margin-top:12px;">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
        </div>
      </div>
    </div>
  </div>
</div>


<script>
  function scrollToAuth() {
    document.getElementById("authSection").scrollIntoView({ behavior: "smooth" });
  }
  function safeText(id, value) {
    const el = document.getElementById(id);
    if (el) el.textContent = value;
  }
</script>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import {
    getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword,
    onAuthStateChanged, signOut, getIdTokenResult, sendPasswordResetEmail, sendEmailVerification
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
  import { getFirestore, doc, setDoc, getDoc, collection, getDocs, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  // =========================
// âœ… ADMIN CONSOLE (NEW UI)
// =========================

// ğŸ”§ (1) ê´€ë¦¬ì ì´ë©”ì¼ ì˜ˆì™¸ í—ˆìš© (ì›í•˜ë©´ ì‚­ì œ ê°€ëŠ¥)
const ADMIN_EMAIL_ALLOWLIST = ["test@gmail.com"]; // ë„ˆ ê´€ë¦¬ì ì´ë©”ì¼ë¡œ ë°”ê¿”

// ğŸ”§ (2) Firestore ë¬¸ì„œ ìœ„ì¹˜
const SETTINGS_DOC = doc(db, "settings", "global");     // ê³µì§€/íŒì—… ì €ì¥
const LOGS_COL = collection(db, "adminLogs");           // ìš´ì˜ ë¡œê·¸

// --- Admin UI DOM ---
const adminFab = document.getElementById("adminFab");
const adminOverlay = document.getElementById("adminOverlay");
const adminClose = document.getElementById("adminClose");
const adminRefresh = document.getElementById("adminRefresh");
const adminMe = document.getElementById("adminMe");

const adminTabs = Array.from(document.querySelectorAll(".admin-tab"));
const adminPanels = Array.from(document.querySelectorAll(".admin-panel"));
const adminSectionTitle = document.getElementById("adminSectionTitle");

// Dashboard elements
const kpiWAU = document.getElementById("kpiWAU");
const kpiPRO = document.getElementById("kpiPRO");
const kpiDormant = document.getElementById("kpiDormant");
const kpiTotal = document.getElementById("kpiTotal");
const dashRecentUsers = document.getElementById("dashRecentUsers");

// Users elements
const userSearch = document.getElementById("userSearch");
const userFilter = document.getElementById("userFilter");
const userSort = document.getElementById("userSort");
const userReload = document.getElementById("userReload");
const userTable = document.getElementById("userTable");

// Notice elements
const bannerEnabled = document.getElementById("bannerEnabled");
const bannerText = document.getElementById("bannerText");
const bannerLink = document.getElementById("bannerLink");
const saveBanner = document.getElementById("saveBanner");

const popupEnabled = document.getElementById("popupEnabled");
const popupTitle = document.getElementById("popupTitle");
const popupBody = document.getElementById("popupBody");
const popupCtaText = document.getElementById("popupCtaText");
const popupCtaLink = document.getElementById("popupCtaLink");
const savePopup = document.getElementById("savePopup");

// Logs
const adminLogs = document.getElementById("adminLogs");

// User modal
const adminUserModal = document.getElementById("adminUserModal");
const umClose = document.getElementById("umClose");
const umTitle = document.getElementById("umTitle");
const umSub = document.getElementById("umSub");
const umPlan = document.getElementById("umPlan");
const umTotal = document.getElementById("umTotal");
const umLast = document.getElementById("umLast");
const umStatus = document.getElementById("umStatus");
const umHabits = document.getElementById("umHabits");
const umStatusSelect = document.getElementById("umStatusSelect");
const umReason = document.getElementById("umReason");
const umSaveStatus = document.getElementById("umSaveStatus");
const umTogglePro = document.getElementById("umTogglePro");
const umNoteText = document.getElementById("umNoteText");
const umAddNote = document.getElementById("umAddNote");
const umNotes = document.getElementById("umNotes");

const umTabs = Array.from(document.querySelectorAll(".um-tab"));
const umPanels = Array.from(document.querySelectorAll(".um-panel"));

let _isAdminUser = false;
let _adminEmail = "";
let _selectedUid = "";

// ---------- Helpers ----------
function fmtDate(ts){
  try{
    if(!ts) return "â€”";
    // Firestore Timestamp ëŒ€ì‘
    const d = ts.toDate ? ts.toDate() : new Date(ts);
    return d.toISOString().slice(0,10);
  }catch{ return "â€”"; }
}
function daysAgo(ts){
  if(!ts) return 9999;
  const d = ts.toDate ? ts.toDate() : new Date(ts);
  const diff = Date.now() - d.getTime();
  return Math.floor(diff / (1000*60*60*24));
}
function pill(text){
  return `<span class="admin-pill">${text}</span>`;
}
async function writeAdminLog(actionType, targetUid, before, after, note=""){
  try{
    await setDoc(doc(LOGS_COL), {
      createdAt: new Date(),
      adminEmail: _adminEmail || "unknown",
      targetUid: targetUid || "",
      actionType,
      before: before ?? null,
      after: after ?? null,
      note
    });
  }catch(e){
    console.log("log fail", e);
  }
}

// ---------- Open/Close ----------
function openAdmin(){
  if(!_isAdminUser){
    alert("ê´€ë¦¬ì ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.");
    return;
  }
  adminOverlay.style.display = "flex";
  // ê¸°ë³¸ íƒ­ ë¡œë“œ
  switchTab("dash");
  refreshAllAdmin();
}
function closeAdmin(){
  adminOverlay.style.display = "none";
}

adminFab?.addEventListener("click", openAdmin);
adminClose?.addEventListener("click", closeAdmin);
adminOverlay?.addEventListener("click", (e)=>{
  if(e.target === adminOverlay) closeAdmin();
});
adminRefresh?.addEventListener("click", refreshAllAdmin);

// ---------- Tabs ----------
function switchTab(tabKey){
  adminTabs.forEach(btn=>{
    btn.classList.toggle("active", btn.dataset.tab === tabKey);
  });
  adminPanels.forEach(p=>{
    p.style.display = (p.dataset.panel === tabKey) ? "block" : "none";
  });

  const titleMap = { dash:"ëŒ€ì‹œë³´ë“œ", users:"ìœ ì €", notice:"ê³µì§€/íŒì—…", logs:"ìš´ì˜ ë¡œê·¸", settings:"ì„¤ì •" };
  adminSectionTitle.textContent = titleMap[tabKey] || "Admin";
}
adminTabs.forEach(btn=>{
  btn.addEventListener("click", ()=> switchTab(btn.dataset.tab));
});

// ---------- Refresh ----------
async function refreshAllAdmin(){
  await Promise.all([
    loadDashboard(),
    loadUsers(),
    loadNoticeSettings(),
    loadAdminLogs()
  ]);
}

// ======================
// 1) DASHBOARD
// ======================
async function loadDashboard(){
  try{
    const usersSnap = await getDocs(collection(db, "users"));
    const total = usersSnap.size;

    let proCount = 0;
    let wau = 0;         // 7ì¼ ë‚´ í™œë™
    let dormant = 0;     // 14ì¼+ í™œë™ì—†ìŒ

    // ìµœê·¼ ê°€ì… 5ëª…(ë°ëª¨: createdAt ì—†ìœ¼ë©´ uidë¡œë§Œ í‘œì‹œ)
    const recent = [];

    usersSnap.forEach(docSnap=>{
      const u = docSnap.data();
      const uid = docSnap.id;

      if(u.isPro) proCount++;

      const last = u.lastActiveAt || u.lastActive || u.updatedAt || null;
      const ago = daysAgo(last);

      if(ago <= 7) wau++;
      if(ago >= 14) dormant++;

      recent.push({ uid, email: u.email || "(no email)", createdAt: u.createdAt || null, lastActiveAt: last, isPro: !!u.isPro, status: u.status || "active", totalSuccess: u.totalSuccess ?? 0 });
    });

    // createdAt ê¸°ì¤€ ì •ë ¬ (ì—†ìœ¼ë©´ ê·¸ëŒ€ë¡œ)
    recent.sort((a,b)=>{
      const ad = a.createdAt?.toDate ? a.createdAt.toDate().getTime() : (a.createdAt ? new Date(a.createdAt).getTime() : 0);
      const bd = b.createdAt?.toDate ? b.createdAt.toDate().getTime() : (b.createdAt ? new Date(b.createdAt).getTime() : 0);
      return bd - ad;
    });

    kpiTotal.textContent = String(total);
    kpiPRO.textContent = String(proCount);
    kpiWAU.textContent = String(wau);
    kpiDormant.textContent = String(dormant);

    dashRecentUsers.innerHTML = recent.slice(0,5).map(r=>{
      return `
        <div class="glass" style="padding:10px;">
          <div style="display:flex; justify-content:space-between; gap:10px; align-items:center;">
            <div style="font-weight:900; font-size:13px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">
              ${r.email}
            </div>
            <div style="display:flex; gap:6px;">
              ${r.isPro ? pill("PRO") : pill("FREE")}
              ${pill((r.status||"active").toUpperCase())}
            </div>
          </div>
          <div class="admin-muted" style="font-size:12px; margin-top:6px;">
            uid: ${r.uid.slice(0,8)}â€¦ Â· ìµœê·¼í™œë™: ${fmtDate(r.lastActiveAt)}
          </div>
        </div>
      `;
    }).join("") || "<div class='admin-muted'>ìœ ì €ê°€ ì—†ìŠµë‹ˆë‹¤.</div>";
  }catch(e){
    console.error(e);
    dashRecentUsers.innerHTML = "<div class='admin-muted'>ëŒ€ì‹œë³´ë“œ ë¡œë“œ ì‹¤íŒ¨</div>";
  }
}

// ======================
// 2) USERS
// ======================
userReload?.addEventListener("click", loadUsers);
userSearch?.addEventListener("input", ()=> loadUsers());
userFilter?.addEventListener("change", ()=> loadUsers());
userSort?.addEventListener("change", ()=> loadUsers());

async function loadUsers(){
  try{
    const qSnap = await getDocs(collection(db, "users"));
    const rows = [];
    qSnap.forEach(docSnap=>{
      const u = docSnap.data();
      rows.push({
        uid: docSnap.id,
        email: u.email || "(no email)",
        isPro: !!u.isPro,
        status: u.status || "active",
        lastActiveAt: u.lastActiveAt || u.lastActive || u.updatedAt || null,
        totalSuccess: u.totalSuccess ?? 0,
        createdAt: u.createdAt || null
      });
    });

    // ê²€ìƒ‰
    const keyword = (userSearch?.value || "").trim().toLowerCase();
    let filtered = rows.filter(r=>{
      if(!keyword) return true;
      return r.email.toLowerCase().includes(keyword) || r.uid.toLowerCase().includes(keyword);
    });

    // í•„í„°
    const f = userFilter?.value || "all";
    if(f === "pro") filtered = filtered.filter(r=> r.isPro);
    if(f === "free") filtered = filtered.filter(r=> !r.isPro);
    if(f === "banned") filtered = filtered.filter(r=> (r.status||"") === "banned");
    if(f === "dormant") filtered = filtered.filter(r=> daysAgo(r.lastActiveAt) >= 14);

    // ì •ë ¬
    const s = userSort?.value || "recent";
    filtered.sort((a,b)=>{
      if(s === "success") return (b.totalSuccess||0) - (a.totalSuccess||0);
      if(s === "created"){
        const ad = a.createdAt?.toDate ? a.createdAt.toDate().getTime() : (a.createdAt ? new Date(a.createdAt).getTime() : 0);
        const bd = b.createdAt?.toDate ? b.createdAt.toDate().getTime() : (b.createdAt ? new Date(b.createdAt).getTime() : 0);
        return bd - ad;
      }
      // recent
      const al = a.lastActiveAt?.toDate ? a.lastActiveAt.toDate().getTime() : (a.lastActiveAt ? new Date(a.lastActiveAt).getTime() : 0);
      const bl = b.lastActiveAt?.toDate ? b.lastActiveAt.toDate().getTime() : (b.lastActiveAt ? new Date(b.lastActiveAt).getTime() : 0);
      return bl - al;
    });

    userTable.innerHTML = filtered.map(r=>{
      const plan = r.isPro ? "PRO" : "FREE";
      const last = fmtDate(r.lastActiveAt);
      const st = (r.status || "active").toUpperCase();

      return `
        <div class="admin-table-row">
          <div style="min-width:0;">
            <div style="font-weight:900; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${r.email}</div>
            <div class="admin-muted" style="font-size:12px;">uid: ${r.uid.slice(0,10)}â€¦</div>
          </div>
          <div>${pill(plan)}</div>
          <div>${last}</div>
          <div>${r.totalSuccess ?? 0}</div>
          <div>${pill(st)}</div>
          <div style="text-align:right;">
            <button class="btn btn-ghost" data-open-uid="${r.uid}" type="button" style="padding:8px 10px;">ìƒì„¸</button>
          </div>
        </div>
      `;
    }).join("") || "<div class='admin-muted' style='padding:12px;'>ì¡°ê±´ì— ë§ëŠ” ìœ ì €ê°€ ì—†ìŠµë‹ˆë‹¤.</div>";

    // ìƒì„¸ ë²„íŠ¼ ì´ë²¤íŠ¸
    userTable.querySelectorAll("[data-open-uid]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        openUserModal(btn.getAttribute("data-open-uid"));
      });
    });
  }catch(e){
    console.error(e);
    userTable.innerHTML = "<div class='admin-muted' style='padding:12px;'>ìœ ì € ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨</div>";
  }
}

// ======================
// 3) NOTICE SETTINGS
// ======================
saveBanner?.addEventListener("click", saveBannerSettings);
savePopup?.addEventListener("click", savePopupSettings);

async function loadNoticeSettings(){
  try{
    const snap = await getDoc(SETTINGS_DOC);
    const data = snap.exists() ? snap.data() : {};

    const banner = data.banner || {};
    bannerEnabled.checked = !!banner.enabled;
    bannerText.value = banner.text || "";
    bannerLink.value = banner.link || "";

    const popup = data.popup || {};
    popupEnabled.checked = !!popup.enabled;
    popupTitle.value = popup.title || "";
    popupBody.value = popup.body || "";
    popupCtaText.value = popup.ctaText || "";
    popupCtaLink.value = popup.ctaLink || "";
  }catch(e){
    console.error(e);
  }
}

async function saveBannerSettings(){
  try{
    const beforeSnap = await getDoc(SETTINGS_DOC);
    const before = beforeSnap.exists() ? beforeSnap.data() : {};

    await setDoc(SETTINGS_DOC, {
      ...before,
      banner: {
        enabled: !!bannerEnabled.checked,
        text: bannerText.value.trim(),
        link: bannerLink.value.trim()
      }
    }, { merge:true });

    await writeAdminLog("SAVE_BANNER", "", before?.banner, {
      enabled: !!bannerEnabled.checked,
      text: bannerText.value.trim(),
      link: bannerLink.value.trim()
    });

    alert("ë°°ë„ˆ ì €ì¥ ì™„ë£Œ");
  }catch(e){
    console.error(e);
    alert("ë°°ë„ˆ ì €ì¥ ì‹¤íŒ¨");
  }
}

async function savePopupSettings(){
  try{
    const beforeSnap = await getDoc(SETTINGS_DOC);
    const before = beforeSnap.exists() ? beforeSnap.data() : {};

    await setDoc(SETTINGS_DOC, {
      ...before,
      popup: {
        enabled: !!popupEnabled.checked,
        title: popupTitle.value.trim(),
        body: popupBody.value.trim(),
        ctaText: popupCtaText.value.trim(),
        ctaLink: popupCtaLink.value.trim()
      }
    }, { merge:true });

    await writeAdminLog("SAVE_POPUP", "", before?.popup, {
      enabled: !!popupEnabled.checked,
      title: popupTitle.value.trim(),
      body: popupBody.value.trim(),
      ctaText: popupCtaText.value.trim(),
      ctaLink: popupCtaLink.value.trim()
    });

    alert("íŒì—… ì €ì¥ ì™„ë£Œ");
  }catch(e){
    console.error(e);
    alert("íŒì—… ì €ì¥ ì‹¤íŒ¨");
  }
}

// ======================
// 4) ADMIN LOGS
// ======================
async function loadAdminLogs(){
  try{
    // ìµœê·¼ 50ê°œ: Firestore ì¿¼ë¦¬(orderBy/limit) ì“°ë ¤ë©´ importê°€ í•„ìš”í•¨.
    // ê°„ë‹¨í•˜ê²Œ ì „ì²´ ì½ê³  ì •ë ¬(ë°ëª¨). ë¡œê·¸ê°€ ë§ì•„ì§€ë©´ orderBy+limitë¡œ ë°”ê¾¸ë©´ ë¨.
    const snap = await getDocs(LOGS_COL);
    const logs = [];
    snap.forEach(d=> logs.push({ id: d.id, ...d.data() }));
    logs.sort((a,b)=>{
      const at = a.createdAt?.toDate ? a.createdAt.toDate().getTime() : new Date(a.createdAt||0).getTime();
      const bt = b.createdAt?.toDate ? b.createdAt.toDate().getTime() : new Date(b.createdAt||0).getTime();
      return bt - at;
    });

    adminLogs.innerHTML = logs.slice(0,50).map(l=>{
      return `
        <div class="glass" style="padding:10px;">
          <div style="display:flex; justify-content:space-between; gap:10px;">
            <div style="font-weight:900; font-size:12px;">${l.actionType || "LOG"}</div>
            <div class="admin-muted" style="font-size:12px;">${fmtDate(l.createdAt)}</div>
          </div>
          <div class="admin-muted" style="font-size:12px; margin-top:6px; line-height:1.6;">
            admin: ${l.adminEmail || "-"}<br>
            target: ${l.targetUid ? l.targetUid.slice(0,10)+"â€¦" : "-"}<br>
            note: ${l.note || "-"}
          </div>
        </div>
      `;
    }).join("") || "<div class='admin-muted'>ë¡œê·¸ê°€ ì—†ìŠµë‹ˆë‹¤.</div>";
  }catch(e){
    console.error(e);
    adminLogs.innerHTML = "<div class='admin-muted'>ë¡œê·¸ ë¡œë“œ ì‹¤íŒ¨</div>";
  }
}

// ======================
// 5) USER MODAL
// ======================
umClose?.addEventListener("click", ()=> adminUserModal.style.display="none");
adminUserModal?.addEventListener("click", (e)=>{
  if(e.target === adminUserModal) adminUserModal.style.display="none";
});

umTabs.forEach(btn=>{
  btn.addEventListener("click", ()=>{
    const key = btn.dataset.umtab;
    umTabs.forEach(b=> b.classList.toggle("active", b === btn));
    umPanels.forEach(p=> p.style.display = (p.dataset.umpanel === key) ? "block" : "none");
  });
});

async function openUserModal(uid){
  _selectedUid = uid;
  adminUserModal.style.display = "flex";
  umTitle.textContent = "ìœ ì € ìƒì„¸";
  umSub.textContent = `uid: ${uid}`;

  // ê¸°ë³¸ íƒ­: overview
  umTabs.forEach((b,i)=> b.classList.toggle("active", i===0));
  umPanels.forEach(p=> p.style.display = (p.dataset.umpanel==="overview") ? "block" : "none");

  await loadUserModalData(uid);
}

async function loadUserModalData(uid){
  try{
    const uref = doc(db, "users", uid);
    const usnap = await getDoc(uref);
    const u = usnap.exists() ? usnap.data() : {};

    umPlan.textContent = u.isPro ? "PRO" : "FREE";
    umTotal.textContent = String(u.totalSuccess ?? 0);
    umLast.textContent = fmtDate(u.lastActiveAt || u.lastActive || u.updatedAt || null);
    umStatus.textContent = (u.status || "active").toUpperCase();
    umStatusSelect.value = (u.status || "active");
    umReason.value = "";

    // ìµœê·¼ habits 10ê°œ (ë°ëª¨: ì „ë¶€ ê°€ì ¸ì™€ ì •ë ¬)
    const hsnap = await getDocs(collection(db, "users", uid, "habits"));
    const habits = [];
    hsnap.forEach(d=>{
      habits.push({ date: d.id, ...d.data() });
    });
    habits.sort((a,b)=> new Date(b.date) - new Date(a.date));

    umHabits.innerHTML = habits.slice(0,10).map(h=>{
      return `
        <div class="glass" style="padding:10px;">
          <div style="display:flex; justify-content:space-between; gap:10px; align-items:center;">
            <div style="font-weight:900;">${h.date}</div>
            <div>${h.done ? "âœ…" : "âŒ"}</div>
          </div>
          <div class="admin-muted" style="font-size:12px; margin-top:6px;">
            ${h.name || "(no name)"}
          </div>
        </div>
      `;
    }).join("") || "<div class='admin-muted'>ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>";

    // notes
    await loadUserNotes(uid);

  }catch(e){
    console.error(e);
    umHabits.innerHTML = "<div class='admin-muted'>ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨</div>";
  }
}

// ìƒíƒœ ì €ì¥
umSaveStatus?.addEventListener("click", async ()=>{
  if(!_selectedUid) return;
  const uid = _selectedUid;

  try{
    const uref = doc(db, "users", uid);
    const beforeSnap = await getDoc(uref);
    const before = beforeSnap.exists() ? beforeSnap.data() : {};

    const nextStatus = umStatusSelect.value;
    const reason = umReason.value.trim();

    await setDoc(uref, {
      status: nextStatus,
      statusReason: reason,
      statusUpdatedAt: new Date()
    }, { merge:true });

    await writeAdminLog("SET_STATUS", uid, {status: before.status, statusReason: before.statusReason}, {status: nextStatus, statusReason: reason});

    alert("ìƒíƒœ ì €ì¥ ì™„ë£Œ");
    await loadUsers();
    await loadUserModalData(uid);
  }catch(e){
    console.error(e);
    alert("ìƒíƒœ ì €ì¥ ì‹¤íŒ¨");
  }
});

// PRO í† ê¸€(ë°ëª¨: users.isPro)
umTogglePro?.addEventListener("click", async ()=>{
  if(!_selectedUid) return;
  const uid = _selectedUid;

  try{
    const uref = doc(db, "users", uid);
    const beforeSnap = await getDoc(uref);
    const before = beforeSnap.exists() ? beforeSnap.data() : {};
    const next = !before.isPro;

    await setDoc(uref, { isPro: next }, { merge:true });
    await writeAdminLog("TOGGLE_PRO", uid, {isPro: before.isPro}, {isPro: next});

    alert(`PRO ë³€ê²½ ì™„ë£Œ: ${next ? "PRO" : "FREE"}`);
    await loadUsers();
    await loadUserModalData(uid);
  }catch(e){
    console.error(e);
    alert("PRO ë³€ê²½ ì‹¤íŒ¨");
  }
});

// notes
async function loadUserNotes(uid){
  try{
    const nsnap = await getDocs(collection(db, "users", uid, "adminNotes"));
    const notes = [];
    nsnap.forEach(d=> notes.push({ id:d.id, ...d.data() }));
    notes.sort((a,b)=>{
      const at = a.createdAt?.toDate ? a.createdAt.toDate().getTime() : new Date(a.createdAt||0).getTime();
      const bt = b.createdAt?.toDate ? b.createdAt.toDate().getTime() : new Date(b.createdAt||0).getTime();
      return bt - at;
    });

    umNotes.innerHTML = notes.map(n=>{
      return `
        <div class="glass" style="padding:10px;">
          <div style="display:flex; justify-content:space-between; gap:10px;">
            <div style="font-weight:900; font-size:12px;">${n.adminEmail || "-"}</div>
            <div class="admin-muted" style="font-size:12px;">${fmtDate(n.createdAt)}</div>
          </div>
          <div style="margin-top:6px; font-size:13px; line-height:1.6;">${(n.text||"").replaceAll("<","&lt;")}</div>
        </div>
      `;
    }).join("") || "<div class='admin-muted'>ë©”ëª¨ê°€ ì—†ìŠµë‹ˆë‹¤.</div>";
  }catch(e){
    console.error(e);
    umNotes.innerHTML = "<div class='admin-muted'>ë©”ëª¨ ë¡œë“œ ì‹¤íŒ¨</div>";
  }
}

umAddNote?.addEventListener("click", async ()=>{
  if(!_selectedUid) return;
  const text = (umNoteText.value || "").trim();
  if(!text) return alert("ë©”ëª¨ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");

  try{
    const nid = doc(collection(db, "users", _selectedUid, "adminNotes"));
    await setDoc(nid, {
      text,
      createdAt: new Date(),
      adminEmail: _adminEmail || "unknown"
    });

    await writeAdminLog("ADD_NOTE", _selectedUid, null, {text});
    umNoteText.value = "";
    await loadUserNotes(_selectedUid);
  }catch(e){
    console.error(e);
    alert("ë©”ëª¨ ì¶”ê°€ ì‹¤íŒ¨");
  }
});

// ======================
// âœ… ê´€ë¦¬ì ê¶Œí•œ íŒë³„: onAuthStateChanged ì•ˆì—ì„œ í˜¸ì¶œí•´ì•¼ í•¨
// ======================
function setAdminAccess(user, tokenResult){
  const isAdminClaim = tokenResult?.claims?.admin === true;
  const isAllowlisted = ADMIN_EMAIL_ALLOWLIST.includes(user.email);

  _isAdminUser = isAdminClaim || isAllowlisted;
  _adminEmail = user.email || "";

  // ê´€ë¦¬ìë©´ FAB ë²„íŠ¼ ë…¸ì¶œ
  adminFab.style.display = _isAdminUser ? "block" : "none";
  adminMe.textContent = _isAdminUser ? _adminEmail : "No Access";
}
  const firebaseConfig = {
    apiKey: "AIzaSyAIaroNs2VsMamnnNJV1cP9LdXqIDhl3Ig",
    authDomain: "giiiddd-36340523-3f595.firebaseapp.com",
    projectId: "giiiddd-36340523-3f595",
    storageBucket: "giiiddd-36340523-3f595.firebasestorage.app",
    messagingSenderId: "698901018936",
    appId: "1:698901018936:web:2fb12a7a03cbd844c1e9cd"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // --- Theme Data ---
  const themeData = {
    survival: ["ğŸ›Œ ë°¤ 11ì‹œ í° ë„ê¸°", "ğŸ’§ ê³µë³µ ë¬¼ í•œ ì”", "ğŸ’Š ì˜ì–‘ì œ ì±™ê²¨ë¨¹ê¸°", "ğŸ¢ ê±°ë¶ëª© ìŠ¤íŠ¸ë ˆì¹­", "ğŸ‘ï¸ ë¨¼ ì‚° ë³´ê¸°", "ğŸ§¹ ì±…ìƒ ìœ„ ë¦¬ì…‹", "ğŸš¶ 30ë¶„ ì‚°ì±…"],
    godsaeng: ["ğŸ“… ë‹¤ìŒ ì£¼ ê³„íš ì§œê¸°", "ğŸ›ï¸ ì´ë¶ˆ ì •ë¦¬í•˜ê¸°", "ğŸ’° ê°€ê³„ë¶€ ì ê¸°", "ğŸ“š ì±… 2í˜ì´ì§€ ì½ê¸°", "ğŸ—£ï¸ ì˜ë‹¨ì–´ 1ê°œ ì™¸ìš°ê¸°", "ğŸ“ ê°ì‚¬ ì¼ê¸° 3ì¤„", "ğŸ§¹ ë°© ì²­ì†Œí•˜ê¸°"],
    detox: ["ğŸ“ ë‚´ì¼ í•  ì¼ ì†ê¸°ë¡", "ğŸ“µ ê¸°ìƒ í›„ 10ë¶„ ë…¸í°", "ğŸ½ï¸ ì‹ì‚¬ ì¤‘ ì˜ìƒ ê¸ˆì§€", "ğŸ§ ì´ì–´í° ì—†ì´ ê±·ê¸°", "ğŸ“± ìŠ¤í¬ë¦° íƒ€ì„ í™•ì¸", "ğŸ§˜ 5ë¶„ ëª…ìƒ", "ğŸ“µ ë””ì§€í„¸ í”„ë¦¬ 1ì‹œê°„"]
  };

  // --- Helper Functions ---
  function dateKeyFromOffset(daysAgo) {
    const d = new Date();
    d.setDate(d.getDate() - daysAgo);
    return d.toISOString().slice(0, 10);
  }

  async function getConsecutiveStreak(uid) {
    let count = 0;
    let date = new Date();
    while (true) {
      const key = date.toISOString().slice(0, 10);
      const snap = await getDoc(doc(db, "users", uid, "habits", key));
      if (!snap.exists()) break;
      count++;
      date.setDate(date.getDate() - 1);
    }
    return count;
  }

  function requireEmailPass() {
    const emailEl = document.getElementById("email");
    const passEl = document.getElementById("password");
    if (!emailEl?.value || !passEl?.value) {
      alert("ì´ë©”ì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.");
      return false;
    }
    if (passEl.value.length < 6) {
      alert("ë¹„ë°€ë²ˆí˜¸ëŠ” 6ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.");
      return false;
    }
    return true;
  }

  // --- Window Global Functions ---
  window.selectTheme = async (el, themeType) => {
    const user = auth.currentUser;
    if (!user) return alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");

    const tokenResult = await getIdTokenResult(user);
    const isPro = tokenResult.claims.pro === true;
    const habitInput = document.getElementById("habitName");
    const dayIdx = new Date().getDay();
    setAdminAccess(user, tokenResult);


    document.querySelectorAll('.theme-tag').forEach(tag => tag.classList.remove('active'));

    if (themeType === 'custom') {
      if (!isPro) {
        alert("ğŸ”’ ì»¤ìŠ¤í…€ ìŠµê´€ì€ PRO ì „ìš©ì…ë‹ˆë‹¤.");
        return;
      }
      habitInput.readOnly = false;
      habitInput.value = "";
      habitInput.placeholder = "ì›í•˜ëŠ” ìŠµê´€ì„ ì…ë ¥í•˜ì„¸ìš”";
      habitInput.style.background = "#fff";
      habitInput.focus();
    } else {
      habitInput.readOnly = true;
      habitInput.style.background = "var(--bg-color)";
      habitInput.value = themeData[themeType][dayIdx];
    }
    if (el) el.classList.add('active');
  };
  
  window.showProModal = () => document.getElementById("proModal").style.display = "flex";

  // --- DOM Elements ---
  const authDiv = document.getElementById('auth');
  const appDiv = document.getElementById('app');
  const emailInput = document.getElementById("email");
  const passInput = document.getElementById("password");
  const signupBtn = document.getElementById("signupBtn");
  const signinBtn = document.getElementById("signinBtn");
  const resetPwBtn = document.getElementById("resetPwBtn");
  const logoutBtn = document.getElementById("logoutBtn");
  const habitBtn = document.getElementById('habitBtn');
  
  // PRO & Admin UI
  const proCard = document.getElementById("proCard");
  const statsDiv = document.getElementById("stats");
  const restoreBtn = document.getElementById("restoreStreakBtn");
  const weeklyReport = document.getElementById("weeklyReport");

  // --- Auth Event Listeners ---
  signupBtn.onclick = async () => {
    if (!requireEmailPass()) return;
    try {
      const cred = await createUserWithEmailAndPassword(auth, emailInput.value, passInput.value);
      await sendEmailVerification(cred.user);
      alert("âœ… íšŒì›ê°€ì… ì™„ë£Œ! ì¸ì¦ ë©”ì¼ì„ í™•ì¸í•´ì£¼ì„¸ìš”.");
      await signOut(auth);
    } catch (e) {
      alert("ê°€ì… ì‹¤íŒ¨: " + e.message);
    }
  };

  signinBtn.onclick = async () => {
    if (!requireEmailPass()) return;
    try {
      await signInWithEmailAndPassword(auth, emailInput.value, passInput.value);
      // ë¡œê·¸ì¸ ì²´í¬ëŠ” onAuthStateChangedì—ì„œ ìˆ˜í–‰
    } catch (e) {
      alert("ë¡œê·¸ì¸ ì‹¤íŒ¨: " + e.message);
    }
  };

  resetPwBtn.onclick = async () => {
    if (!emailInput.value) return alert("ì´ë©”ì¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
    try {
      await sendPasswordResetEmail(auth, emailInput.value);
      alert("ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì • ë©”ì¼ì„ ë³´ëƒˆìŠµë‹ˆë‹¤.");
    } catch(e) { alert("ì˜¤ë¥˜: " + e.message); }
  };

  logoutBtn.onclick = () => signOut(auth);

  // --- Core Logic (Auth Monitor) ---
  onAuthStateChanged(auth, async user => {
    // 1. ë¡œê·¸ì•„ì›ƒ ìƒíƒœ
    if (!user) {
      authDiv.style.display = 'block';
      appDiv.style.display = 'none';
      if(document.getElementById("adminPanel")) document.getElementById("adminPanel").style.display = 'none';
      if(document.getElementById("adminOpenBtn")) document.getElementById("adminOpenBtn").style.display = 'none';
      return;
    }

    // 2. ê´€ë¦¬ì ì˜ˆì™¸ ì´ë©”ì¼ ì„¤ì •
    const adminEmail = "test@gmail.com"; 

    // 3. ì´ë©”ì¼ ì¸ì¦ ì²´í¬ (ê´€ë¦¬ì ê³„ì •ì€ íŒ¨ìŠ¤)
    if (!user.emailVerified && user.email !== adminEmail) {
      alert("ğŸ“© ì´ë©”ì¼ ì¸ì¦ í›„ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.");
      await signOut(auth);
      authDiv.style.display = 'block';
      appDiv.style.display = 'none';
      return;
    }

    // 4. ë¡œê·¸ì¸ ì„±ê³µ UI
    authDiv.style.display = 'none';
    appDiv.style.display = 'block';
    
    const dayIdx = new Date().getDay();
    const suggestionEl = document.getElementById("todaySuggestion");
    if(suggestionEl) suggestionEl.innerHTML = `ğŸ‘‰ ì˜¤ëŠ˜ ì¶”ì²œ: <b>${themeData.survival[dayIdx]}</b> (ê¸°ë³¸)`;

    try {
      const tokenResult = await getIdTokenResult(user, true);
      const isAdmin = tokenResult.claims.admin === true;
      const isPro = tokenResult.claims.pro === true;

      document.getElementById("welcome").textContent = `ğŸ‘‹ ${user.email.split('@')[0]}ë‹˜`;

      // --- [ê´€ë¦¬ì íŒ¨ë„ ë¡œì§] ---
      const openBtn = document.getElementById("adminOpenBtn");
      const panel = document.getElementById("adminPanel");
      
      // ê´€ë¦¬ì ê¶Œí•œ í™•ì¸
      if (isAdmin || user.email === adminEmail) {
        if(openBtn) {
            openBtn.style.display = 'block'; // ì™•ê´€ ë²„íŠ¼ ë³´ì´ê¸°
            openBtn.onclick = () => {
                // íŒ¨ë„ í† ê¸€
                if (panel.style.display === 'none' || panel.style.display === '') {
                    panel.style.display = 'block';
                    loadAllUsers(); // ë°ì´í„° ë¡œë“œ
                } else {
                    panel.style.display = 'none';
                }
            };
        }
      } else {
        if(openBtn) openBtn.style.display = 'none';
        if(panel) panel.style.display = 'none';
      }
      // -------------------------

      // PRO UI
      if (isPro) {
        if(proCard) proCard.style.display = "none";
        if(statsDiv) statsDiv.style.display = "block";
        safeText("status", "ğŸŒŸ PRO ë©¤ë²„ì‹­ ì´ìš© ì¤‘");
        loadStats(user.uid);
      } else {
        if(proCard) proCard.style.display = "block";
        if(statsDiv) statsDiv.style.display = "none";
        safeText("status", "ğŸŒ± ë¬´ë£Œ íšŒì› (í•˜ë£¨ 1ìŠµê´€)");
      }

      // Load Data
      const streak = await getConsecutiveStreak(user.uid);
      updateTierUI(streak);
      await updateWeeklyReport(user.uid, isPro);
      await renderCalendar(user.uid, isPro);
      await updateStreakProtectionUI(user.uid, isPro);
      
      if (!isPro && streak >= 7) showProModal();

    } catch (e) {
      console.error("Auth init error:", e);
    }
  });

  // --- Habit Actions (ê½ƒê°€ë£¨ íš¨ê³¼ ì ìš©) ---
  habitBtn.onclick = async () => {
    const user = auth.currentUser;
    if (!user) return;
    
    const habitName = document.getElementById("habitName").value;
    if (habitName === "í…Œë§ˆë¥¼ ì„ íƒí•˜ì„¸ìš”" || !habitName.trim()) {
      alert("í…Œë§ˆë¥¼ ì„ íƒí•˜ê±°ë‚˜ ìŠµê´€ì„ ì…ë ¥í•˜ì„¸ìš”!");
      return;
    }
    
    const todayStr = new Date().toISOString().slice(0, 10);
    const ref = doc(db, "users", user.uid, "habits", todayStr);
    
    await setDoc(ref, {
      done: true,
      name: habitName,
      timestamp: new Date()
    });

    celebrate(); // ê½ƒê°€ë£¨ í•¨ìˆ˜ í˜¸ì¶œ
    
    const streak = await getConsecutiveStreak(user.uid);
    updateTierUI(streak);
  };

  // ê½ƒê°€ë£¨ íš¨ê³¼ í•¨ìˆ˜
  function celebrate() {
    const btn = document.getElementById("habitBtn");
    
    // ë²„íŠ¼ ì• ë‹ˆë©”ì´ì…˜
    btn.style.transform = "scale(0.95)";
    setTimeout(() => { btn.style.transform = "scale(1)"; }, 150);
    
    safeText("status", "ğŸ‰ ì˜¤ëŠ˜ì˜ ë¯¸ì…˜ í´ë¦¬ì–´! í›Œë¥­í•©ë‹ˆë‹¤.");
    btn.innerHTML = "ì™„ë£Œí•¨ âœ¨";
    btn.style.background = "#ddd";
    btn.style.color = "#888";
    btn.style.cursor = "default";
    btn.disabled = true;

    // ê½ƒê°€ë£¨ ë°œì‚¬ (window.confettiê°€ ë¡œë“œë˜ì–´ ìˆì–´ì•¼ í•¨)
    if (typeof confetti === 'function') {
        const count = 200;
        const defaults = { origin: { y: 0.7 } };
        function fire(particleRatio, opts) {
          confetti(Object.assign({}, defaults, opts, {
            particleCount: Math.floor(count * particleRatio)
          }));
        }
        fire(0.25, { spread: 26, startVelocity: 55 });
        fire(0.2, { spread: 60 });
        fire(0.35, { spread: 100, decay: 0.91, scalar: 0.8 });
        fire(0.1, { spread: 120, startVelocity: 25, decay: 0.92, scalar: 1.2 });
        fire(0.1, { spread: 120, startVelocity: 45 });
    } else {
        console.log("Confetti script not loaded");
    }
  }

  // --- UI Update Functions ---
  function updateTierUI(streak) {
    const tierBadge = document.getElementById("tierBadge");
    const tierText = document.getElementById("tierText");
    const streakCount = document.getElementById("streakCount");

    tierBadge.style.display = "block";
    streakCount.textContent = `ğŸ”¥ í˜„ì¬ ${streak}ì¼ ì—°ì† ì„±ê³µ ì¤‘!`;

    let label = "ğŸ¥‰ BRONZE";
    let cls = "tier-bronze";
    if (streak >= 30) { label = "ğŸ† GRANDMASTER"; cls = "tier-master"; }
    else if (streak >= 20) { label = "ğŸ’ DIAMOND"; cls = "tier-diamond"; }
    else if (streak >= 14) { label = "âœ¨ PLATINUM"; cls = "tier-platinum"; }
    else if (streak >= 7) { label = "ğŸ¥‡ GOLD"; cls = "tier-gold"; }
    else if (streak >= 3) { label = "ğŸ¥ˆ SILVER"; cls = "tier-silver"; }

    tierText.textContent = label;
    tierText.className = "badge " + cls;
  }

  async function updateWeeklyReport(uid, isPro) {
    const reportBody = document.getElementById("weeklyReportBody");
    const lockedDiv = document.getElementById("weeklyReportLocked");
    const reportDiv = document.getElementById("weeklyReport");
    
    let successCount = 0;
    const days = [];
    const dayNames = ["ì¼", "ì›”", "í™”", "ìˆ˜", "ëª©", "ê¸ˆ", "í† "];
    
    for (let i = 0; i < 7; i++) {
       const key = dateKeyFromOffset(i);
       const snap = await getDoc(doc(db, "users", uid, "habits", key));
       const done = snap.exists();
       const d = new Date(key);
       if (done) successCount++;
       days.push({ key, done, dayName: dayNames[d.getDay()] });
    }

    const streak = await getConsecutiveStreak(uid);
    if (streak < 3) {
      reportDiv.style.display = "none";
      return;
    }
    reportDiv.style.display = "block";

    if (!isPro) {
      reportBody.innerHTML = "";
      lockedDiv.style.display = "block";
      document.querySelector("#weeklyReportLocked b").textContent = `${streak}ì¼ ì—°ì† ì„±ê³µ`;
      return;
    }

    lockedDiv.style.display = "none";
    const rate = Math.round((successCount/7)*100);
    const listHTML = days.reverse().map(d => `
       <div style="display:flex; justify-content:space-between; margin-bottom:6px; font-size:13px;">
         <span>${d.dayName} (${d.key.slice(5)})</span>
         <span>${d.done ? "âœ…" : "âŒ"}</span>
       </div>
    `).join('');

    reportBody.innerHTML = `
      <div style="background:rgba(99,102,241,0.1); padding:16px; border-radius:12px; margin-bottom:12px;">
         <div style="font-weight:700; margin-bottom:8px;">ğŸ¤– AI Habit Coach</div>
         <div style="font-size:13px; line-height:1.5;">
            ì´ë²ˆ ì£¼ ì„±ê³µë¥ ì€ <b>${rate}%</b>ì…ë‹ˆë‹¤.<br>
            ${rate === 100 ? "ì™„ë²½í•©ë‹ˆë‹¤! ê°“ìƒ ê·¸ ìì²´ì‹œë„¤ìš”." : "ì£¼ë§ì— ì¡°ê¸ˆ ë” ì‹ ê²½ì¨ë³´ë©´ ì–´ë–¨ê¹Œìš”?"}
         </div>
      </div>
      <div style="padding:10px; background:#fff; border-radius:12px; border:1px solid #eee;">
         ${listHTML}
      </div>
    `;
  }

  async function renderCalendar(uid, isPro) {
    const section = document.getElementById("calendarSection");
    const grid = document.getElementById("calendarGrid");
    
    if (!isPro) {
      section.style.display = "none";
      return;
    }
    section.style.display = "block";
    grid.innerHTML = "";

    const now = new Date();
    const year = now.getFullYear();
    const month = now.getMonth();
    const lastDay = new Date(year, month + 1, 0).getDate();

    for (let d = 1; d <= lastDay; d++) {
      const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
      const snap = await getDoc(doc(db, "users", uid, "habits", dateStr));
      
      const cell = document.createElement("div");
      cell.textContent = d;
      cell.style.padding = "6px";
      cell.style.borderRadius = "6px";
      cell.style.fontSize = "12px";
      cell.style.textAlign = "center";
      
      if (snap.exists()) {
        cell.style.background = "#22c55e";
        cell.style.color = "white";
      } else {
        cell.style.background = "rgba(0,0,0,0.05)";
        cell.style.color = "var(--muted)";
      }
      grid.appendChild(cell);
    }
  }

  async function updateStreakProtectionUI(uid, isPro) {
    if (!isPro) return;
    const snap = await getDoc(doc(db, "users", uid));
    const left = snap.data()?.streakProtectionLeft ?? 2;
    
    if (left > 0) {
      restoreBtn.style.display = "block";
      restoreBtn.textContent = `ğŸ”¥ ì—°ì† ê¸°ë¡ ë³µêµ¬ (${left}íšŒ ë‚¨ìŒ)`;
      restoreBtn.onclick = async () => {
         const yesterday = dateKeyFromOffset(1);
         await setDoc(doc(db, "users", uid, "habits", yesterday), { done: true, restored: true });
         await updateDoc(doc(db, "users", uid), { streakProtectionLeft: left - 1 });
         alert("ğŸ”¥ ì–´ì œ ê¸°ë¡ì´ ë³µêµ¬ë˜ì—ˆìŠµë‹ˆë‹¤!");
         location.reload();
      };
    } else {
      restoreBtn.style.display = "none";
    }
  }

  async function loadStats(uid) {
    let count = 0;
    const snap = await getDocs(collection(db, "users", uid, "habits"));
    safeText("totalDays", `ì´ ëˆ„ì  ì„±ê³µ: ${snap.size}ì¼`);
  }

  // --- Admin Functions (ëª¨ë‹¬ì°½ ì ìš© ì™„ë£Œ) ---
  async function loadAllUsers() {
    const listDiv = document.getElementById("userList");
    if (!listDiv) return;

    listDiv.innerHTML = "<div style='text-align:center; padding:20px;'>ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>";
    
    try {
      const snap = await getDocs(collection(db, "users"));
      listDiv.innerHTML = "";
      
      if (snap.empty) {
          listDiv.innerHTML = "ê°€ì…ëœ ìœ ì €ê°€ ì—†ìŠµë‹ˆë‹¤.";
          return;
      }

      snap.forEach(docSnap => {
        const data = docSnap.data();
        const uid = docSnap.id;
        
        const item = document.createElement("div");
        item.style.cssText = "background:white; padding:10px; margin-bottom:8px; border-radius:6px; border:1px solid #e2e8f0; display:flex; flex-direction:column; gap:6px;";
        
        item.innerHTML = `
          <div style="display:flex; justify-content:space-between; align-items:center;">
             <span style="font-weight:bold; color:#334155; font-size:11px;">UID: ${uid.slice(0,6)}...</span>
             <span class="badge" style="background:${data.isPro ? '#6366f1' : '#94a3b8'}">${data.isPro ? 'PRO' : 'FREE'}</span>
          </div>
          <div style="display:flex; gap:5px; margin-top:4px;">
             <button class="info-btn" style="flex:1; border:1px solid #cbd5e1; background:#f8fafc; cursor:pointer; border-radius:4px; font-size:11px; padding:4px;">ğŸ” ìƒì„¸ ì •ë³´</button>
             <button class="pro-btn" style="flex:1; border:none; background:${data.isPro ? '#fb7185' : '#6366f1'}; color:white; cursor:pointer; border-radius:4px; font-size:11px; padding:4px;">
                ${data.isPro ? 'PRO í•´ì œ' : 'PRO ë¶€ì—¬'}
             </button>
          </div>
        `;

        item.querySelector(".pro-btn").onclick = async () => {
           if(confirm(`[${uid}] ë‹˜ì˜ ë“±ê¸‰ì„ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
               await updateDoc(doc(db, "users", uid), { isPro: !data.isPro });
               loadAllUsers(); 
           }
        };

        // ìƒì„¸ ì •ë³´ ëª¨ë‹¬ ì—´ê¸°
        item.querySelector(".info-btn").onclick = async () => {
            const modal = document.getElementById("adminUserDetailModal");
            const content = document.getElementById("detailContent");
            
            modal.style.display = "flex";
            content.innerHTML = "ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...";

            const habitsSnap = await getDocs(collection(db, "users", uid, "habits"));
            const totalHabits = habitsSnap.size;
            
            let recentHabitsHTML = "";
            let habitsArr = [];
            habitsSnap.forEach(h => habitsArr.push({date: h.id, ...h.data()}));
            habitsArr.sort((a,b) => new Date(b.date) - new Date(a.date));
            
            habitsArr.slice(0, 5).forEach(h => {
                recentHabitsHTML += `<li style="margin-bottom:4px;">${h.date}: ${h.name} ${h.done?'âœ…':'âŒ'}</li>`;
            });

            content.innerHTML = `
                <p><strong>ğŸ†” UID:</strong> ${uid}</p>
                <p><strong>ğŸ’ ë©¤ë²„ì‹­:</strong> ${data.isPro ? '<span style="color:blue">PRO ìœ ì €</span>' : 'ë¬´ë£Œ ìœ ì €'}</p>
                <p><strong>ğŸ›¡ï¸ ê¸°ë¡ ë³µêµ¬ê¶Œ:</strong> ${data.streakProtectionLeft ?? 0}íšŒ ë‚¨ìŒ</p>
                <hr style="border:0; border-top:1px dashed #ccc; margin:15px 0;">
                <p><strong>ğŸ“Š ì´ ì„±ê³µ ì¼ìˆ˜:</strong> ${totalHabits}ì¼</p>
                <p><strong>ğŸ—“ï¸ ìµœê·¼ í™œë™:</strong></p>
                <ul style="padding-left:20px; background:#f8fafc; padding:10px 10px 10px 30px; border-radius:8px;">
                    ${recentHabitsHTML || "<li style='color:#999'>ê¸°ë¡ ì—†ìŒ</li>"}
                </ul>
            `;
        };

        listDiv.appendChild(item);
      });
    } catch (error) {
      console.error(error);
      listDiv.innerHTML = "ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.";
    }
  }

  const cheatBtn = document.getElementById("cheatStreakBtn");
  if(cheatBtn) {
    cheatBtn.onclick = async () => {
       const user = auth.currentUser;
       if (!user) return alert("ë¡œê·¸ì¸ í•„ìš”");
       if (!confirm("ì§€ë‚œ 5ì¼ ë°ì´í„°ë¥¼ ê°•ì œ ì„±ê³µ ì²˜ë¦¬í• ê¹Œìš”?")) return;
       for(let i=0; i<5; i++) {
          const k = dateKeyFromOffset(i);
          await setDoc(doc(db, "users", user.uid, "habits", k), { done: true, cheat: true });
       }
       alert("ì¹˜íŠ¸ ì ìš© ì™„ë£Œ! ìƒˆë¡œê³ ì¹¨í•˜ì„¸ìš”.");
       location.reload();
    };
  }
  
  // --- Dark Mode ---
  const toggle = document.getElementById("darkModeToggle");
  toggle.onclick = () => {
    document.body.classList.toggle("dark-mode");
    localStorage.setItem("darkMode", document.body.classList.contains("dark-mode") ? "on" : "off");
  };
  if (localStorage.getItem("darkMode") === "on") document.body.classList.add("dark-mode");
</script>

<script>
  // BGM Player Logic (Vanilla JS)
  (() => {
    const audio = document.getElementById("bgmAudio");
    const bgmBtn = document.getElementById("bgmToggle");
    const vol = document.getElementById("bgmVol");
    const volText = document.getElementById("bgmVolText");

    if (audio && bgmBtn) {
      audio.volume = 0.25;

      bgmBtn.onclick = () => {
        if (audio.paused) {
          audio.play().then(() => {
            bgmBtn.textContent = "ì¼ì‹œì •ì§€";
          }).catch((e) => {
            alert("ë¸Œë¼ìš°ì € ì •ì±…ìƒ ìë™ì¬ìƒì´ ë§‰í˜€ìˆì–´ìš”. ë²„íŠ¼ì„ ë‹¤ì‹œ ëˆŒëŸ¬ì£¼ì„¸ìš”!");
            console.error(e);
          });
        } else {
          audio.pause();
          bgmBtn.textContent = "ì¬ìƒ";
        }
      };

      vol.oninput = () => {
        audio.volume = vol.value;
        volText.textContent = Math.round(vol.value * 100) + "%";
      };
    }
  })();
</script>
</body>
</html>