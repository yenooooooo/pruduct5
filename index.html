<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>HabitFlow - Ultimate God Mode</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

  <link href="https://cdn.jsdelivr.net/gh/sunn-us/SUIT/fonts/static/woff2/SUIT.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

  <style>
    /* ====== âœ¨ Core Variables ====== */
    :root {
      --bg-color: #f8fafc;
      --text-main: #0f172a;
      --text-muted: #64748b;
      --card-bg: rgba(255, 255, 255, 0.85);
      --card-border: rgba(255, 255, 255, 0.6);
      --panel-bg: #ffffff;
      --input-bg: rgba(241, 245, 249, 0.8);
      --primary: #6366f1;
      --secondary: #a855f7;
      --accent: #f59e0b;
      --shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.08);
      --glass-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.1);
    }

    body.dark-mode {
      --bg-color: #0f172a;
      --text-main: #f1f5f9;
      --text-muted: #94a3b8;
      --card-bg: rgba(30, 41, 59, 0.75);
      --card-border: rgba(255, 255, 255, 0.08);
      --panel-bg: #1e293b;
      --input-bg: rgba(15, 23, 42, 0.6);
      --shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5);
      --glass-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

    body {
      margin: 0; font-family: 'SUIT', sans-serif;
      background: var(--bg-color); color: var(--text-main);
      overflow-x: hidden; transition: background 0.3s, color 0.3s;
      min-height: 100vh; position: relative;
    }

    /* ====== Animations ====== */
    @keyframes pulse { 0% { transform: scale(0.95); opacity: 0.7; } 100% { transform: scale(1.05); opacity: 1; } }
    @keyframes fadeIn { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:translateY(0); } }
    @keyframes fireScale { 0% { transform: scale(1) rotate(-5deg); } 100% { transform: scale(1.2) rotate(5deg); } }

    /* ====== UI Components ====== */
    ul { list-style: none; padding: 0; margin: 0; }
    button { font-family: inherit; }

    section { width: 100%; padding: 84px 20px; position: relative; z-index: 1; pointer-events: none; }
    .container, .glass, button, input, .card, .price-card, .workout-side-panel, .problem-card, .memo-panel { pointer-events: auto; }
    .container { width: 100%; max-width: 1080px; margin: 0 auto; }

    header { position: absolute; top: 0; left: 0; right: 0; padding: 20px 0; z-index: 10; pointer-events: auto; }
    .header-inner { display: flex; justify-content: space-between; align-items: center; }
    .logo { font-weight: 900; font-size: 1.2rem; display: flex; align-items: center; gap: 8px; color: var(--text-main); }
    .logo-badge { width: 12px; height: 12px; background: var(--primary); border-radius: 50%; }

    nav { display: flex; gap: 12px; align-items: center; }
    .pc-only { display: block; }
    @media (max-width: 600px) { .pc-only { display: none; } }

    .glass {
      background: var(--card-bg); border: 1px solid var(--card-border);
      box-shadow: var(--glass-shadow); backdrop-filter: blur(16px);
      border-radius: 24px; transition: transform 0.25s ease;
    }
    .glass:hover { transform: translateY(-4px); }

    .hero { padding-top: 140px; padding-bottom: 80px; }
    .hero-grid { display: grid; grid-template-columns: 1.2fr 1fr; gap: 48px; align-items: center; }
    .hero-pill { display: inline-block; padding: 8px 14px; border-radius: 999px; font-size: 13px; font-weight: 800; background: rgba(99, 102, 241, 0.15); color: var(--primary); }
    .hero-title { font-size: 46px; line-height: 1.2; letter-spacing: -1px; margin: 18px 0; font-weight: 900; color: var(--text-main); }
    .hero-desc { font-size: 16px; color: var(--text-muted); line-height: 1.7; margin-bottom: 24px; }
    .hero-metrics { display: flex; gap: 14px; margin-top: 28px; }
    .metric-card { padding: 14px 18px; border-radius: 16px; background: var(--input-bg); border: 1px solid var(--card-border); display: flex; flex-direction: column; gap: 4px; font-size: 13px; color: var(--text-main); }
    .recommend-card { background: var(--card-bg); border-radius: 24px; padding: 30px; margin-top: 20px; display: flex; flex-direction: column; gap: 8px; font-size: 15px; color: var(--text-main); border: 1px solid var(--card-border); box-shadow: var(--shadow); transition: opacity 0.5s ease-in-out; min-height: 140px; justify-content: center; }

    .problem-section { padding-top: 40px; padding-bottom: 60px; }
    .section-head { text-align: center; margin-bottom: 36px; }
    .section-head .kicker { display: inline-block; padding: 6px 12px; border-radius: 999px; font-size: 12px; font-weight: 800; background: rgba(99, 102, 241, 0.15); color: var(--primary); }
    .section-head h2 { margin: 12px 0 8px; font-size: 28px; color: var(--text-main); }
    .section-head p { color: var(--text-muted); }
    .problem-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-top: 18px; }
    .problem-card { padding: 24px; text-align: left; display: flex; flex-direction: column; gap: 10px; background: var(--card-bg); border-radius: 24px; border: 1px solid var(--card-border); box-shadow: var(--shadow); }
    .problem-card h3 { margin:0; font-size: 18px; color: var(--text-main); }
    .problem-card p { margin:0; font-size: 14px; color: var(--text-muted); line-height: 1.5; }

    .dashboard-layout { display: flex; justify-content: center; align-items: flex-start; gap: 24px; max-width: 960px; margin: 0 auto; display: none; }
    #app { flex: 1; max-width: 480px; padding: 30px; text-align: center; position: relative; z-index: 10; width: 100%; }
    .right-stack { display: flex; flex-direction: column; gap: 20px; width: 340px; flex-shrink: 0; }

    .workout-side-panel { width: 100%; background: linear-gradient(145deg, #1e293b, #0f172a); color: white; padding: 24px; border-radius: 24px; border: 1px solid rgba(255, 255, 255, 0.1); box-shadow: 0 20px 40px -10px rgba(0, 0, 0, 0.5); display: none; text-align: left; position: relative; overflow: hidden; }
    .master-badge-corner { position: absolute; top: 16px; right: 16px; background: rgba(251, 191, 36, 0.2); color: #fbbf24; border: 1px solid #fbbf24; font-size: 10px; font-weight: 800; padding: 4px 8px; border-radius: 6px; letter-spacing: 1px; }
    .w-title { font-size: 18px; font-weight: 800; margin-bottom: 20px; background: linear-gradient(to right, #fff, #94a3b8); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .workout-tabs { display: flex; background: rgba(0,0,0,0.3); padding: 4px; border-radius: 12px; margin-bottom: 20px; }
    .w-tab { flex: 1; border: none; background: transparent; color: #94a3b8; padding: 8px; font-size: 13px; font-weight: 700; border-radius: 8px; cursor: pointer; transition: 0.2s; }
    .w-tab.active { background: #fbbf24; color: #000; box-shadow: 0 4px 12px rgba(251, 191, 36, 0.3); }
    .workout-display { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 16px; padding: 24px 10px; text-align: center; margin-bottom: 20px; min-height: 100px; display: flex; align-items: center; justify-content: center; flex-direction: column; }
    .wd-main { font-size: 20px; font-weight: 800; margin-bottom: 4px; color: #fff; }
    .wd-sub { font-size: 12px; color: #94a3b8; }
    .workout-anim { animation: pulse 0.5s infinite alternate; color: #fbbf24; font-size: 24px; font-weight: 900; }

    .memo-panel { width: 100%; padding: 20px; text-align: left; position: relative; display: flex; flex-direction: column; gap: 10px; overflow: hidden; }
    .memo-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
    .memo-title { font-weight: 800; font-size: 16px; color: var(--text-main); display: flex; align-items: center; gap: 6px; }
    .memo-badge { font-size: 10px; padding: 2px 6px; border-radius: 4px; background: var(--primary); color: white; font-weight: 700; }
    textarea.memo-input { width: 100%; height: 100px; border: none; border-radius: 12px; background: var(--input-bg); color: var(--text-main); padding: 12px; font-family: inherit; font-size: 14px; line-height: 1.5; resize: none; outline: none; box-shadow: inset 0 2px 4px rgba(0,0,0,0.05); }
    .memo-history-list { max-height: 150px; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; }
    .memo-item { background: var(--input-bg); padding: 10px; border-radius: 10px; font-size: 13px; color: var(--text-main); border: 1px solid var(--card-border); }
    .memo-date { font-size: 11px; color: var(--text-muted); margin-bottom: 4px; font-weight: 700; }

    .panel-lock { position: absolute; inset: 0; background: rgba(0,0,0,0.1); backdrop-filter: blur(8px); display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 24px; z-index: 10; color: var(--text-main); font-weight: 800; text-align: center; padding: 20px; }

    .pricing-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-top: 18px; }
    .price-card { padding: 24px; text-align: left; display:flex; flex-direction:column; justify-content: space-between; height: 100%; background: var(--card-bg); border-radius: 24px; border: 1px solid var(--card-border); box-shadow: var(--shadow); }
    .price-card .plan { font-size: 13px; font-weight: 800; color: var(--text-muted); margin-bottom: 4px; text-transform: uppercase; }
    .price-card .amount { font-size: 24px; font-weight: 900; margin-bottom: 4px; letter-spacing: -1px; color: var(--text-main); }
    .price-card .desc { font-size: 12px; color: var(--text-muted); margin-bottom: 15px; min-height: 32px; }
    .price-card ul { margin-bottom: 15px; padding: 0; list-style: none; }
    .price-card li { display: flex; gap: 6px; font-size: 12px; margin-bottom: 6px; align-items: center; font-weight: 500; color: var(--text-main); }
    .price-card.pro { border: 2px solid var(--primary); }
    .price-card.ultra { border: 2px solid var(--accent); }
    .price-card.master { border: 2px solid #333; background: linear-gradient(135deg, #1e1e1e, #0f172a); box-shadow: 0 10px 30px rgba(0,0,0,0.3); transform: scale(1.03); z-index: 2; position: relative; }
    .price-card.master .plan { color: #ffd700; }
    .price-card.master .desc { color: #94a3b8; }
    .price-card.master .amount, .price-card.master li { color: #fff; }
    .price-card.master .btn { background: #ffd700; color: #000; border:none; font-weight: 900; }

    .auth-card { max-width: 400px; margin: 0 auto; padding: 30px; text-align: center; }
    .btn { padding: 12px; border-radius: 12px; font-weight: 900; cursor: pointer; border:1px solid var(--card-border); background: var(--panel-bg); color: var(--text-main); width:100%; transition:0.2s; box-shadow: var(--shadow); }
    .btn:active { transform: scale(0.95); }
    .btn-primary { border:none; background: linear-gradient(135deg, var(--primary), var(--secondary)); color: #fff; }
    input { width: 100%; padding: 14px; margin-bottom: 10px; border-radius: 12px; border: 1px solid var(--card-border); background: var(--input-bg); color: var(--text-main); }

    .tag-container { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; justify-content: center; }
    .theme-tag { padding: 6px 12px; border-radius: 20px; border: 1px solid var(--card-border); background: transparent; cursor: pointer; font-size: 13px; color: var(--text-main); }
    .theme-tag.active { background: var(--primary); color: white; border-color: var(--primary); }

    .aura-effect { position: relative; }
    .aura-effect::before { content: ''; position: absolute; top: -15px; left: -15px; right: -15px; bottom: -15px; border-radius: 50%; background: linear-gradient(45deg, #ff0000, #ff7300, #fffb00, #48ff00, #00ffd5, #002bff, #7a00ff, #ff00c8, #ff0000); background-size: 400%; z-index: -1; filter: blur(25px); animation: glowing 20s linear infinite; opacity: 0.5; }
    @keyframes glowing { 0% { background-position: 0 0; } 50% { background-position: 400% 0; } 100% { background-position: 0 0; } }

    .pet-container { display: flex; flex-direction: column; align-items: center; justify-content: center; margin: 20px 0; cursor: pointer; transition: transform 0.2s; }
    .pet-emoji { font-size: 80px; animation: bounce 2s infinite; filter: drop-shadow(0 10px 10px rgba(0,0,0,0.15)); }
    .pet-bubble { background: var(--panel-bg); color: var(--text-main); padding: 8px 16px; border-radius: 20px; font-size: 13px; font-weight: bold; position: relative; margin-bottom: 10px; opacity: 0; transition: opacity 0.3s; box-shadow: var(--shadow); }

    .sticker { position: absolute; font-size: 40px; cursor: grab; user-select: none; z-index: 50; transition: transform 0.1s; filter: drop-shadow(2px 4px 6px rgba(0,0,0,0.15)); }
    .sticker:active { cursor: grabbing; transform: scale(1.1); }

    .heatmap-grid { display: grid; grid-template-columns: repeat(20, 1fr); gap: 4px; margin-top: 10px; justify-content: center; }
    .grass { width: 100%; aspect-ratio: 1; border-radius: 3px; background: rgba(0,0,0,0.08); }
    .grass.active { background: #22c55e; }

    .blob-cont { position: fixed; top: 0; left: 0; width: 100%; height: 100vh; z-index: 0; overflow: hidden; pointer-events: none; }
    .blob { position: absolute; border-radius: 50%; opacity: 0.6; filter: blur(60px); animation: float 10s infinite alternate; }
    .blob-1 { top: 10%; left: 10%; width: 300px; height: 300px; background: var(--secondary); animation-duration: 25s; }
    .blob-2 { bottom: 20%; right: 10%; width: 350px; height: 350px; background: var(--primary); animation-duration: 30s; }
    .blob-3 { bottom: 10%; left: 30%; width: 250px; height: 250px; background: #ec4899; animation-duration: 22s; }
    @keyframes float { 0% { transform: translate(0, 0); } 100% { transform: translate(40px, 60px); } }
    @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }

    @media (max-width: 900px) {
        .hero-grid, .pricing-grid, .problem-grid, .dashboard-layout { grid-template-columns: 1fr; flex-direction: column; align-items: center; }
        .workout-side-panel, .right-stack { width: 100%; max-width: 480px; }
        .admin-shell { grid-template-columns: 1fr; }
        .admin-left { display: none; }
    }

    /* ===================================================================== */
    /* ğŸ‘‘ GOD MODE ADMIN & NEW FEATURES */
    /* ===================================================================== */
    #adminPanel { display:none; position: fixed; inset: 0; z-index: 10000; background: rgba(0,0,0,0.85); backdrop-filter: blur(12px); padding: 20px; animation: fadeIn 0.3s; }
    .admin-shell { width: 100%; max-width: 1400px; height: 90vh; margin: 0 auto; border-radius: 20px; overflow: hidden; display: grid; grid-template-columns: 260px 1fr; background: #111; box-shadow: 0 0 100px rgba(99,102,241,0.2); border: 1px solid #333; }

    .admin-left { padding: 20px; background: #000; border-right: 1px solid #333; display:flex; flex-direction:column; }
    .admin-right { padding: 30px; overflow-y:auto; background: #0a0a0a; color: #eee; }

    .admin-title { font-weight: 1000; font-size: 24px; color: #fff; margin-bottom: 5px; display: flex; align-items: center; gap: 10px; }
    .admin-sub { color: #666; font-size: 11px; margin-bottom: 30px; letter-spacing: 1px; font-family: monospace; }

    .adminNavBtn { width:100%; padding: 14px 16px; border-radius: 8px; border: none; background: transparent; cursor: pointer; font-weight: 700; text-align:left; color:#888; margin-bottom: 5px; transition: 0.2s; }
    .adminNavBtn:hover { background: #222; color: #fff; }
    .adminNavBtn.active { background: linear-gradient(90deg, #6366f1, #4f46e5); color: #fff; box-shadow: 0 4px 15px rgba(99,102,241,0.3); }

    .admin-cards { display:grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 30px; }
    .admin-card { padding: 20px; border-radius: 12px; background: #1a1a1a; border: 1px solid #333; }
    .admin-card .k { color: #888; font-size: 12px; font-weight: 800; text-transform: uppercase; }
    .admin-card .v { font-size: 32px; font-weight: 1000; margin-top: 10px; color: #fff; }

    /* Matrix Terminal */
    .matrix-bg { position: absolute; inset: 0; pointer-events: none; opacity: 0.1; z-index: 0; background-image: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0MCIgaGVpZ2h0PSI0MCI+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZpbGw9IiMwZjAiIGZvbnQtZmFtaWx5PSJtb25vc3BhY2UiIGZvbnQtc2l6ZT0iMTIiIHRleHQtYW5jaG9yPSJtaWRkbGUiPjEwPC90ZXh0Pjwvc3ZnPg=='); }
    .matrix-terminal { background: #000; color: #00ff41; padding: 20px; border-radius: 12px; font-family: 'Courier New', monospace; height: 250px; overflow-y: auto; font-size: 12px; line-height: 1.5; border: 1px solid #0f0; box-shadow: inset 0 0 30px rgba(0, 255, 0, 0.1); margin-top: 20px; position: relative; z-index: 1; }
    .log-line { margin-bottom: 4px; display: flex; }
    .log-line span { opacity: 0.5; margin-right: 10px; }

    .admin-table { width:100%; border-collapse: collapse; margin-top: 20px; }
    .admin-table th { text-align: left; padding: 15px; color: #666; font-size: 12px; border-bottom: 1px solid #333; text-transform: uppercase; }
    .admin-table td { padding: 15px; border-bottom: 1px solid #222; font-size: 14px; color: #ddd; }

    .admin-pane { display:none; animation: fadeIn 0.3s; }
    .admin-pane.active { display:block; }

    /* Admin Close Button */
    .admin-close-x { position: absolute; top: 20px; right: 20px; background: transparent; border: none; color: #fff; font-size: 24px; cursor: pointer; opacity: 0.6; transition: 0.2s; z-index: 20; }
    .admin-close-x:hover { opacity: 1; color: #ef4444; }

    /* Visual Charts (CSS based) */
    .chart-container { display: flex; gap: 5px; height: 10px; width: 100%; margin-top: 10px; background: #222; border-radius: 5px; overflow: hidden; }
    .chart-bar { height: 100%; transition: width 0.5s; }
    .chart-legend { display: flex; gap: 15px; margin-top: 5px; font-size: 11px; color: #888; }
    .dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 5px; }

    /* New User Features */
    .live-ticker { position: fixed; bottom: 0; left: 0; width: 100%; background: rgba(0,0,0,0.8); backdrop-filter: blur(10px); color: white; padding: 8px 0; z-index: 9000; overflow: hidden; white-space: nowrap; font-size: 13px; font-weight: 700; border-top: 1px solid rgba(255,255,255,0.1); }
    .ticker-content { display: inline-block; animation: ticker 30s linear infinite; padding-left: 100%; }
    .ticker-item { display: inline-flex; align-items: center; gap: 6px; margin-right: 40px; }
    @keyframes ticker { 0% { transform: translateX(0); } 100% { transform: translateX(-100%); } }

    .zen-overlay { position: fixed; inset: 0; background: var(--bg-color); z-index: 20000; display: none; flex-direction: column; align-items: center; justify-content: center; text-align: center; opacity: 0; transition: opacity 0.35s; }
    .zen-circle { width: 150px; height: 150px; border-radius: 50%; background: linear-gradient(135deg, var(--primary), var(--secondary)); opacity: 0.3; animation: breathe 4s infinite ease-in-out; margin-bottom: 30px; }
    @keyframes breathe { 0%, 100% { transform: scale(1); opacity: 0.3; } 50% { transform: scale(1.5); opacity: 0.6; } }

    .broadcast-overlay { position: fixed; top: 100px; left: 50%; transform: translateX(-50%); background: rgba(239, 68, 68, 0.9); color: white; padding: 15px 30px; border-radius: 50px; font-weight: 900; box-shadow: 0 10px 30px rgba(239, 68, 68, 0.4); z-index: 30000; display: none; animation: slideDown 0.5s; }
    .broadcast-overlay.active { display: block; }
    @keyframes slideDown { from { top: -100px; } to { top: 100px; } }

    .achievement-toast { position: fixed; top: 20px; right: 20px; background: linear-gradient(135deg, #ffd700, #f59e0b); color: #000; padding: 15px 20px; border-radius: 12px; font-weight: 800; box-shadow: 0 10px 30px rgba(245, 158, 11, 0.4); z-index: 25000; display: none; align-items: center; gap: 10px; animation: slideInRight 0.5s; }
    @keyframes slideInRight { from { transform: translateX(100%); } to { transform: translateX(0); } }

    /* Hearts Animation */
    .cheer-heart { position: fixed; font-size: 24px; animation: floatUp 3s linear forwards; z-index: 9999; pointer-events: none; }
    @keyframes floatUp { 0% { transform: translateY(0) scale(1); opacity: 1; } 100% { transform: translateY(-100vh) scale(1.5); opacity: 0; } }
  </style>
</head>
<body>

  <div id="liveTicker" class="live-ticker">
    <div class="ticker-content" id="tickerContent">
      <div class="ticker-item">âš¡ HabitFlow LIVE: ì „ ì„¸ê³„ ìœ ì €ë“¤ì´ ê°“ìƒì„ ì‚´ê³  ìˆìŠµë‹ˆë‹¤.</div>
    </div>
  </div>

  <div id="zenOverlay" class="zen-overlay">
    <div class="zen-circle"></div>
    <h2 style="font-weight:300; margin-bottom:10px;">Deep Focus</h2>
    <p style="color:var(--text-muted);">ì˜¤ì§ ë‚˜ì—ê²Œë§Œ ì§‘ì¤‘í•˜ì„¸ìš”.</p>
    <button class="btn btn-ghost" onclick="toggleZenMode()" style="margin-top:30px;">ë‚˜ê°€ê¸°</button>
  </div>

  <div id="broadcastOverlay" class="broadcast-overlay">
    ğŸ“¢ <span id="broadcastMsg">ê¸´ê¸‰ ê³µì§€ì‚¬í•­ì…ë‹ˆë‹¤.</span>
  </div>

  <div id="achievementToast" class="achievement-toast">
    <div style="font-size:24px;">ğŸ†</div>
    <div>
      <div style="font-size:10px; opacity:0.8;">ACHIEVEMENT UNLOCKED</div>
      <div id="achievementTitle">ì‘ì‹¬ì‚¼ì¼ íƒˆì¶œ!</div>
    </div>
  </div>

  <div class="blob-cont">
    <div class="blob blob-1"></div>
    <div class="blob blob-2"></div>
    <div class="blob blob-3"></div>
  </div>

  <!-- FIX: pointer-events auto so stickers can drag/click -->
  <div id="stickerLayer" style="position: absolute; top:0; left:0; width:100%; height:100%; overflow:hidden; pointer-events:auto; z-index:5;"></div>

  <div id="coinDisplay" style="position: fixed; top: 20px; right: 20px; z-index: 500; background: var(--panel-bg); padding: 8px 12px; border-radius: 20px; font-weight: 800; font-size: 14px; display:none; border: 2px solid var(--accent); color: var(--text-main); box-shadow: var(--shadow);">
      <span>â­</span> <span id="coinCount">0</span>
  </div>

  <header>
    <div class="container header-inner">
      <div class="logo"><div class="logo-badge"></div>HabitFlow</div>
      <nav>
        <button class="btn" onclick="toggleZenMode()" style="padding: 8px 12px; width:auto;">ğŸ§˜</button>
        <button class="btn btn-primary" onclick="scrollToAuth()" style="padding: 8px 16px; font-size: 14px; width:auto;">ì‹œì‘í•˜ê¸°</button>
        <button id="darkModeToggle" class="btn btn-ghost" style="padding: 8px; width:auto;">ğŸŒ“</button>
      </nav>
    </div>
  </header>

  <div id="topBanner" style="display:none; position:fixed; top:70px; z-index:9998; width:100%; padding:12px 18px; background: rgba(99,102,241,0.12); border-bottom:1px solid rgba(99,102,241,0.20); color: var(--text-main); font-weight: 900; text-align:center; backdrop-filter: blur(10px);"></div>

  <section class="hero">
    <div class="container hero-grid">
      <div class="hero-left">
        <span class="hero-pill">âœ¨ í•˜ë£¨ í•˜ë‚˜ë¡œ ì¶©ë¶„í•´ìš”</span>
        <h1 class="hero-title">í•˜ë£¨ í•˜ë‚˜,<br />ì¸ìƒì„ ë°”ê¾¸ëŠ” ìŠµê´€</h1>
        <p class="hero-desc">ì‘ì‹¬ì‚¼ì¼ì„ ëë‚´ëŠ” ê°€ì¥ ë‹¨ìˆœí•œ ë°©ì‹.<br>ë²„íŠ¼ í•œ ë²ˆìœ¼ë¡œ ê¸°ë¡í•˜ê³ , ì—°ì† ê¸°ë¡ìœ¼ë¡œ ë™ê¸°ë¶€ì—¬ë¥¼ ìœ ì§€í•˜ì„¸ìš”.</p>
        <div class="hero-actions">
          <button class="btn btn-primary" style="width:auto;" onclick="scrollToAuth()">ì§€ê¸ˆ ì‹œì‘í•˜ê¸°</button>
        </div>
        <div class="hero-metrics">
          <div class="metric-card"><b>1 Habit</b><span>í•˜ë£¨ ë”± í•˜ë‚˜</span></div>
          <div class="metric-card"><b>Streak</b><span>ì—°ì† ê¸°ë¡</span></div>
          <div class="metric-card"><b>Report</b><span>ì£¼ê°„ ë¦¬í¬íŠ¸</span></div>
        </div>
      </div>
      <div class="hero-right glass">
        <h3 style="margin-top:0;">ì˜¤ëŠ˜ì˜ ì¶”ì²œ ë£¨í‹´</h3>
        <p style="color:var(--text-muted); font-size:14px;">ë¡œê·¸ì¸ í›„ í…Œë§ˆë¥¼ ì„ íƒí•˜ë©´ ë§¤ì¼ ë‹¤ë¥¸ ë£¨í‹´ì´ ì¶”ì²œë©ë‹ˆë‹¤.</p>
        <div id="heroRecommendCard" class="recommend-card fade-anim" style="transition: opacity 0.5s;">
          <div>ğŸš‘ <b>ìƒì¡´ ì²´ë ¥ íŒ©</b></div>
          <span style="font-size:12px; color:var(--text-muted);">ì§ì¥ì¸ì„ ìœ„í•œ "ì£½ì§€ ì•Šìœ¼ë ¤ê³  í•˜ëŠ” ìš´ë™"</span>
        </div>
      </div>
    </div>
  </section>

  <section id="authSection" style="padding-top: 40px; min-height: 80vh;">
    <div class="container" style="display:flex; justify-content:center;">
      <div id="auth" class="auth-card glass">
        <h2>HabitFlow ì‹œì‘í•˜ê¸°</h2>
        <input id="email" placeholder="ì´ë©”ì¼ ì£¼ì†Œ">
        <input id="password" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸ (6ì ì´ìƒ)">
        <div class="auth-actions">
           <button id="signupBtn" class="btn btn-primary">íšŒì›ê°€ì…</button>
           <button id="signinBtn" class="btn btn-ghost">ë¡œê·¸ì¸</button>
        </div>
        <div style="margin-top:10px;"><button id="resetPwBtn" class="link-btn">ë¹„ë°€ë²ˆí˜¸ ì°¾ê¸°</button></div>
      </div>

      <div id="dashboardLayout" class="dashboard-layout">
          <div id="app" class="glass">
            <div style="display:flex; justify-content:space-between; align-items:center;">
              <h2 id="welcome" style="margin:0; font-size: 1.2rem;"></h2>
              <button id="logoutBtn" style="background:none; border:none; color:var(--text-muted); font-size:0.8rem; text-decoration:underline; cursor:pointer;">ë¡œê·¸ì•„ì›ƒ</button>
            </div>

            <div style="margin: 10px 0 10px;">
              <div style="display:flex; justify-content:space-between; align-items:flex-end; margin-bottom:5px;">
                <span id="levelBadge" style="font-weight:900; color:var(--primary); font-size:18px;">Lv.1</span>
                <span id="xpText" style="font-size:12px; color:var(--text-muted); font-weight:700;">0 / 100 XP</span>
              </div>
              <div style="background:rgba(0,0,0,0.08); border-radius:10px; height:10px; overflow:hidden; position:relative;">
                <div id="xpBar" style="background:linear-gradient(90deg, var(--primary), var(--secondary)); width:0%; height:100%; transition: width 0.6s; border-radius:10px;"></div>
              </div>
            </div>

            <div class="pet-container" id="petContainer">
                <div id="petBubble" class="pet-bubble">ì‘ì›í•©ë‹ˆë‹¤!</div>
                <div id="petEmoji" class="pet-emoji">ğŸ¥š</div>
            </div>

            <button id="globalCheerBtn" class="btn" style="background: #fff0f7; color: #ec4899; border: 1px solid #ec4899; width: 100%; margin-bottom: 15px;">
                ğŸ’– ëª¨ë‘ì—ê²Œ ì‘ì› ë³´ë‚´ê¸°
            </button>

            <div class="heatmap-container" style="margin: 15px 0; padding: 15px; border-radius: 16px; background: rgba(0,0,0,0.05); border: 1px solid var(--card-border);">
               <div style="font-size:12px; font-weight:700; color:var(--text-muted); display:flex; justify-content:space-between; margin-bottom: 5px;">
                 <span>ğŸŒ¿ ìµœê·¼ 20ì¼</span><span>Log</span>
               </div>
               <div id="heatmapGrid" class="heatmap-grid"></div>
            </div>

            <div id="tierBadge" style="display:none; margin: 20px 0;">
              <span id="tierText" class="badge"></span>
              <p id="streakCount" style="font-size: 0.9rem; margin-top: 8px; font-weight:700;"></p>
            </div>

            <div id="themeSection" style="margin-top:24px;">
               <p style="font-size: 0.9rem; font-weight: 700; margin-bottom:10px;">ğŸ ì˜¤ëŠ˜ì˜ ë£¨í‹´ íŒ©</p>
               <div class="tag-container">
                  <button class="theme-tag" onclick="selectTheme(this, 'survival')">ğŸš‘ ìƒì¡´</button>
                  <button class="theme-tag" onclick="selectTheme(this, 'godsaeng')">âœ¨ ê°“ìƒ</button>
                  <button class="theme-tag" onclick="selectTheme(this, 'detox')">ğŸ“± ë””í†¡ìŠ¤</button>
                  <button class="theme-tag" onclick="selectTheme(this, 'custom')">â• ì»¤ìŠ¤í…€</button>
               </div>
            </div>

            <div id="todaySuggestion" style="margin-top:16px; font-size:0.9rem; padding:12px; background:rgba(99,102,241,0.1); border-radius:12px; color:var(--text-main);">í…Œë§ˆë¥¼ ì„ íƒí•˜ì„¸ìš”.</div>

            <input id="habitName" readonly value="í…Œë§ˆë¥¼ ì„ íƒí•˜ì„¸ìš”" style="margin-top: 20px; text-align: center; font-weight:700;">
            <div style="display:flex; gap:8px; margin-top:10px;">
                <button id="habitBtn" class="btn btn-primary">ì˜¤ëŠ˜ ìŠµê´€ ì™„ë£Œ âœ…</button>
                <button id="timerBtn" class="btn" style="width:60px; background:#333; color:white; display:none;">â±ï¸</button>
            </div>
            <p id="status" style="margin-top:12px; font-size:14px; color:var(--primary); font-weight:700; min-height:20px;"></p>

            <div id="stats" style="display:none; margin-top:20px; padding:16px; background:rgba(0,0,0,0.05); border-radius:12px;">
              <h3 style="margin:0 0 10px; font-size:16px;">ğŸ“Š í†µê³„</h3>
              <p id="totalDays" style="margin:0; font-weight:700;"></p>
            </div>

            <button id="restoreStreakBtn" style="margin-top:10px; width:100%; padding:12px; border-radius:12px; background:var(--accent); color:white; border:none; display:none;">ğŸ”¥ ì—°ì† ê¸°ë¡ ë³µêµ¬</button>

            <div id="weeklyReport" style="display:none; width: 100%; margin-top: 30px; text-align: left;">
              <div id="weeklyReportBody"></div>
              <div id="weeklyReportLocked" style="display:none; padding: 24px; border: 2px dashed var(--card-border); border-radius: 16px; text-align: center;">
                 ğŸ”’ PRO íšŒì›ì´ ë˜ì–´ ë¦¬í¬íŠ¸ë¥¼ í™•ì¸í•˜ì„¸ìš”.
                 <button class="btn btn-primary" style="margin-top: 15px; font-size:13px;" onclick="showProModal('PRO')">ì ê¸ˆ í•´ì œ</button>
              </div>
            </div>

            <div id="calendarSection" style="display:none; margin-top:30px; text-align:left;">
              <h3 style="font-size:16px; margin-bottom:10px;">ğŸ“… ìº˜ë¦°ë”</h3>
              <div id="calendarGrid" style="display:grid; grid-template-columns: repeat(7, 1fr); gap:6px;"></div>
            </div>
          </div>

          <div class="right-stack">
              <div id="workoutSidePanel" class="workout-side-panel">
                  <span class="master-badge-corner">MASTER</span>
                  <div class="w-title">ğŸ”¥ ì˜¤ëŠ˜ì˜ ì±Œë¦°ì§€</div>
                  <div class="workout-tabs">
                      <button class="w-tab active" data-type="walk" onclick="selectWorkoutTab('walk')">ğŸš¶ ê±·ê¸°</button>
                      <button class="w-tab" data-type="run" onclick="selectWorkoutTab('run')">ğŸƒ ë‹¬ë¦¬ê¸°</button>
                      <button class="w-tab" data-type="gym" onclick="selectWorkoutTab('gym')">ğŸ‹ï¸ í—¬ìŠ¤</button>
                  </div>
                  <div class="workout-display">
                      <div id="workoutResult" class="wd-main">â“</div>
                      <div class="wd-sub">ì¢…ëª© ì„ íƒ í›„ ë¯¸ì…˜ ë½‘ê¸°!</div>
                  </div>
                  <button id="startWorkoutBtn" class="btn" style="background:var(--accent); color:#000; border:none; font-weight:900; box-shadow:0 4px 15px rgba(251,191,36,0.4);">ğŸ° ë¯¸ì…˜ ëœë¤ ë½‘ê¸°</button>
                  <button id="completeWorkoutBtn" class="btn" style="background:linear-gradient(to right, #22c55e, #16a34a); color:#fff; border:none; display:none;">âœ… ì™„ë£Œ (ì½”ì¸ 3ë°°)</button>
              </div>

              <div id="memoPanel" class="glass memo-panel" style="display:none;">
                  <div class="memo-header">
                      <div class="memo-title">ğŸ“ ì˜¤ëŠ˜ì˜ ë©”ëª¨</div>
                      <span class="memo-badge">PRO+</span>
                  </div>
                  <div id="memoLocked" class="panel-lock">
                      <div style="font-size:30px; margin-bottom:10px;">ğŸ”’</div>
                      <div>PRO ë“±ê¸‰ë¶€í„° ì‚¬ìš© ê°€ëŠ¥</div>
                      <button class="btn btn-primary" style="margin-top:15px; width:auto; padding:8px 16px; font-size:12px;" onclick="showProModal('PRO')">ì ê¸ˆ í•´ì œ</button>
                  </div>
                  <textarea id="dailyMemo" class="memo-input" placeholder="ì˜¤ëŠ˜ì˜ ë‹¤ì§ì´ë‚˜ í•  ì¼ì„ ê¸°ë¡í•˜ì„¸ìš”..."></textarea>
                  <button id="saveMemoBtn" class="btn btn-primary" style="margin-top:10px;">ğŸ’¾ ì €ì¥í•˜ê¸°</button>
              </div>

              <div id="memoHistoryPanel" class="glass memo-panel" style="display:none;">
                  <div class="memo-header">
                      <div class="memo-title">ğŸ“‚ ì§€ë‚œ ë©”ëª¨ ê¸°ë¡</div>
                  </div>
                  <div id="memoHistoryList" class="memo-history-list">
                      <div style="text-align:center; padding:10px; color:var(--text-muted); font-size:13px;">ê¸°ë¡ëœ ë©”ëª¨ê°€ ì—†ìŠµë‹ˆë‹¤.</div>
                  </div>
              </div>
          </div>
      </div>
    </div>
  </section>

  <section id="pricing">
    <div class="container">
      <div class="section-head">
        <span class="kicker">PRICING</span>
        <h2>ê°€ê²©</h2>
        <p>ë‹¹ì‹ ì˜ ì„±ì¥ì„ ê°€ì†í™”í•  ìµœì ì˜ í”Œëœì„ ì„ íƒí•˜ì„¸ìš”.</p>
      </div>
      <div class="pricing-grid">
        <div class="price-card glass">
          <div><div class="plan">ë¬´ë£Œ</div><div class="amount">â‚©0</div><div class="desc">ê°€ë³ê²Œ ì‹œì‘í•˜ëŠ” ì…ë¬¸ììš©</div><ul><li>âœ… í•˜ë£¨ 1ìŠµê´€ ê¸°ë¡</li><li>âœ… ê¸°ë³¸ í…Œë§ˆ ì¶”ì²œ</li></ul></div>
        </div>
        <div class="price-card glass pro">
          <div><div class="plan" style="color:var(--primary);">PRO</div><div class="amount">â‚©3,900</div><div class="desc">ìŠµê´€ íŒ¨í„´ì„ ì¡ê³  ì‹¶ì€ ë¶„</div><ul><li>âœ¨ ìŠµê´€ ë¬´ì œí•œ + ì»¤ìŠ¤í…€</li><li>âœ¨ ì£¼ê°„ AI ë¶„ì„ ë¦¬í¬íŠ¸</li><li>âœ¨ ìº˜ë¦°ë” ë·° / ë³µêµ¬ê¶Œ</li><li>ğŸ“ <b>ì˜¤ëŠ˜ì˜ ë©”ëª¨ & íˆìŠ¤í† ë¦¬</b></li></ul></div>
          <button class="btn btn-primary" onclick="showProModal('PRO')">PRO ì—…ê·¸ë ˆì´ë“œ</button>
        </div>
        <div class="price-card glass ultra">
          <div><div class="plan" style="color:var(--accent);">ULTRA</div><div class="amount">â‚©5,900</div><div class="desc">ë‚˜ë§Œì˜ ê°ì„±ìœ¼ë¡œ ê¾¸ë¯¸ê¸°</div><ul><li>ğŸŒˆ ì•± ì»¬ëŸ¬ í…Œë§ˆ ë³€ê²½</li><li>ğŸµ BGM ì„ ê³¡ê¶Œ (ë¹—ì†Œë¦¬ ë“±)</li><li>ğŸ’° ì½”ì¸ íšë“ 2ë°°</li><li>ğŸ‘‘ PRO ê¸°ëŠ¥ ëª¨ë‘ í¬í•¨</li></ul></div>
          <button class="btn btn-primary" style="background:linear-gradient(135deg, #f59e0b, #d97706);" onclick="showProModal('ULTRA')">ULTRA ì—…ê·¸ë ˆì´ë“œ</button>
        </div>
        <div class="price-card glass master">
          <div><div class="plan">MASTER</div><div class="amount">â‚©7,900</div><div class="desc">ê·¹í•œì˜ ì„±ì¥ì„ ìœ„í•œ ì™„ì „ì²´</div><ul><li>ğŸ’ª <b>ë§¤ì¼ ìš´ë™ ì±Œë¦°ì§€ íŒ¨ë„</b></li><li>â±ï¸ í¬ëª¨ë„ë¡œ ì§‘ì¤‘ íƒ€ì´ë¨¸</li><li>âœ¨ ë§ˆìŠ¤í„° ì „ìš© ì˜¤ë¼ ì´í™íŠ¸</li><li>ğŸ’° ì½”ì¸ íšë“ 3ë°°</li></ul></div>
          <button class="btn" onclick="showProModal('MASTER')">MASTER ì—…ê·¸ë ˆì´ë“œ</button>
        </div>
      </div>
    </div>
  </section>

  <footer><div class="container" style="text-align:center; padding-bottom:40px; color:var(--text-muted); font-size:14px;"><p>Â© 2026 HabitFlow. All rights reserved.</p></div></footer>

  <button id="trashModeBtn" style="display:none; position:fixed; bottom:50px; right:140px; z-index:9990; width:50px; height:50px; border-radius:50%; border:none; background:var(--accent); color:white; font-size:22px; cursor:pointer; box-shadow:0 4px 12px rgba(0,0,0,0.3);">ğŸ—‘ï¸</button>
  <button id="themeBtn" style="display:none; position:fixed; bottom:50px; right:200px; z-index:9990; width:50px; height:50px; border-radius:50%; border:none; background:#ec4899; color:white; font-size:22px; cursor:pointer; box-shadow:0 4px 12px rgba(0,0,0,0.3);">ğŸ¨</button>
  <button id="shopOpenBtn" style="display:none; position:fixed; bottom:50px; right:80px; z-index:9990; width:50px; height:50px; border-radius:50%; border:none; background:#8b5cf6; color:white; font-size:22px; cursor:pointer; box-shadow:0 4px 12px rgba(0,0,0,0.3);">ğŸ</button>
  <button id="rankOpenBtn" style="display:none; position:fixed; bottom:50px; right:20px; z-index:9990; width:50px; height:50px; border-radius:50%; border:none; background:var(--accent); color:white; font-size:24px; cursor:pointer; box-shadow:0 4px 12px rgba(0,0,0,0.3);">ğŸ†</button>
  <button id="adminOpenBtn" style="display:none; position:fixed; bottom:50px; left:20px; z-index:9990; width:50px; height:50px; border-radius:50%; border:none; background:#000; color:#0f0; border:2px solid #0f0; font-size:24px; cursor:pointer; box-shadow:0 0 20px #0f0;">ğŸ˜</button>
  <button id="bgmOpenBtn" style="display:none; position:fixed; bottom:50px; left:80px; z-index:99999; width:40px; height:40px; border-radius:50%; border:none; background:var(--panel-bg); color:var(--text-main); font-size:22px; cursor:pointer; box-shadow:0 4px 12px rgba(0,0,0,0.2); backdrop-filter: blur(5px);">ğŸµ</button>

  <div id="shopPanel" class="glass" style="display:none; position:fixed; bottom:110px; right:20px; width:300px; padding:20px; z-index:10000; border:2px solid #8b5cf6; background:var(--panel-bg);">
    <div style="display:flex; justify-content:space-between; margin-bottom:15px;"><h3 style="margin:0; color:#7c3aed;">ğŸ ìƒì </h3><button class="close-btn" onclick="this.parentElement.parentElement.style.display='none'">âœ–</button></div>
    <div style="text-align:center; margin-bottom:20px;"><div style="font-size:60px;">ğŸ”®</div><button id="gachaBtn" class="btn btn-primary" style="margin-top:10px;">1ì½”ì¸ ë½‘ê¸°! (ë³´ìœ : <span id="shopCoinCount">0</span>)</button></div>
    <div style="font-size:12px; font-weight:bold; margin-bottom:5px;">ğŸ’ ë‚´ ìŠ¤í‹°ì»¤</div>
    <div id="inventoryList" style="height:150px; overflow-y:auto; background:var(--input-bg); padding:10px; border-radius:8px; display:grid; grid-template-columns:repeat(4,1fr); gap:10px;"></div>
  </div>

  <div id="rankPanel" class="glass" style="display:none; position:fixed; bottom:110px; right:20px; width:340px; padding:20px; z-index:10000; border:2px solid var(--accent); background:var(--panel-bg);">
    <div style="display:flex; justify-content:space-between; margin-bottom:15px;"><h3 style="margin:0; color:var(--accent);">ğŸ† ëª…ì˜ˆì˜ ì „ë‹¹</h3><button class="close-btn" onclick="this.parentElement.parentElement.style.display='none'">âœ–</button></div>
    <div id="rankList" style="height:300px; overflow-y:auto; background:var(--input-bg); padding:10px; border-radius:8px;"></div>
  </div>

  <div id="themePanel" class="glass" style="display:none; position:fixed; bottom:110px; right:120px; width:200px; padding:20px; z-index:10000; background:var(--panel-bg);">
    <div style="margin-bottom:10px; font-weight:bold;">ğŸ¨ í…Œë§ˆ (ULTRA+)</div>
    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
        <button onclick="changeTheme('purple')" style="background:#6366f1; height:40px; border-radius:8px; border:none;"></button>
        <button onclick="changeTheme('blue')" style="background:#3b82f6; height:40px; border-radius:8px; border:none;"></button>
        <button onclick="changeTheme('pink')" style="background:#ec4899; height:40px; border-radius:8px; border:none;"></button>
        <button onclick="changeTheme('gold')" style="background:#d97706; height:40px; border-radius:8px; border:none;"></button>
    </div>
  </div>

  <div id="bgm" class="glass" style="display:none; position:fixed; bottom:100px; left:20px; padding:15px; width:240px; z-index:10000; background:var(--panel-bg);">
    <div style="display:flex; justify-content:space-between; margin-bottom:10px;"><b>ğŸµ BGM</b><button onclick="this.parentElement.parentElement.style.display='none'">âœ–</button></div>
    <select id="bgmSelect" style="width:100%; padding:5px; margin-bottom:10px; display:none;"><option value="./bgm.mp3">ê¸°ë³¸</option><option value="rain">ë¹„ì˜¤ëŠ” ë‚ </option><option value="forest">ìˆ²ì†</option></select>
    <div style="display:flex; align-items:center; gap:10px; margin-bottom:10px;"><button id="bgmToggle" style="flex:1; padding:6px; border-radius:6px; background:var(--primary); color:white; border:none;">ì¬ìƒ</button></div>
    <input id="bgmVol" type="range" min="0" max="1" step="0.01" value="0.25" style="width:100%;">
  </div>

  <div id="timerModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.8); z-index:20000; align-items:center; justify-content:center;">
      <div class="glass" style="padding:40px; text-align:center; background:var(--panel-bg); width:300px;">
          <h2 style="margin:0;">â±ï¸ ì§‘ì¤‘ íƒ€ì´ë¨¸</h2>
          <div id="timerDisplay" style="font-size:60px; font-weight:900; margin:20px 0;">25:00</div>
          <div style="display:flex; gap:10px;">
              <button id="startTimerBtn" class="btn btn-primary">ì‹œì‘</button>
              <button id="stopTimerBtn" class="btn">ì¤‘ì§€</button>
          </div>
          <button onclick="document.getElementById('timerModal').style.display='none'" style="margin-top:20px; border:none; background:none; text-decoration:underline;">ë‹«ê¸°</button>
      </div>
  </div>

  <div id="proModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6); align-items:center; justify-content:center; z-index:10001; backdrop-filter:blur(5px);">
    <div class="glass" style="padding:40px; max-width:360px; width:90%; text-align:center; background:var(--panel-bg);">
      <h2 style="margin-top:0;" id="modalTitle">ğŸ‘‘ ì—…ê·¸ë ˆì´ë“œ</h2>
      <p style="color:var(--text-muted); margin-bottom:20px;">ë” ê°•ë ¥í•œ ê¸°ëŠ¥ìœ¼ë¡œ ì„±ì¥í•˜ì„¸ìš”.</p>
      <button class="btn btn-primary" onclick="alert('ê²°ì œ ê¸°ëŠ¥ ì¤€ë¹„ì¤‘!')">ì‹œì‘í•˜ê¸°</button>
      <p style="margin-top:16px; font-size:13px; cursor:pointer; color:var(--text-muted);" onclick="this.closest('#proModal').style.display='none'">ë‹«ê¸°</p>
    </div>
  </div>

  <div id="levelUpOverlay" class="levelup-overlay" style="display:none; position: fixed; inset:0; background: rgba(0,0,0,0.85); z-index: 25000; flex-direction: column; align-items: center; justify-content: center; color: white;">
    <div style="font-size:80px; margin-bottom:20px;">ğŸ†™</div>
    <div style="font-size: 4rem; font-weight: 900; background: linear-gradient(to right, #ffd700, #ff8c00); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">LEVEL UP!</div>
    <p style="font-size:1.5rem; margin-top:10px; color:#fff;">ì¶•í•˜í•©ë‹ˆë‹¤! í•œ ë‹¨ê³„ ì„±ì¥í•˜ì…¨êµ°ìš”.</p>
    <button class="btn btn-primary" onclick="document.getElementById('levelUpOverlay').style.display='none'" style="margin-top:30px; font-size:1.2rem; padding:15px 40px; width:auto;">ê³„ì†í•˜ê¸°</button>
  </div>

  <div id="adminPanel">
    <div class="matrix-bg"></div>
    <button class="admin-close-x" onclick="document.getElementById('adminPanel').style.display='none'">âœ–</button>

    <div class="admin-shell">
      <div class="admin-left">
        <div class="admin-title">ğŸ‘‘ GOD MODE</div>
        <div class="admin-sub" id="adminSubtitle">SYSTEM ACCESS GRANTED</div>

        <div class="admin-nav">
          <button class="adminNavBtn active" data-pane="pane-dashboard">ğŸ“Š ëŒ€ì‹œë³´ë“œ</button>
          <button class="adminNavBtn" data-pane="pane-users">ğŸ‘¥ ìœ ì € ê´€ë¦¬</button>
          <button class="adminNavBtn" data-pane="pane-tools">ğŸ› ï¸ ì‹ ì˜ ê¶ŒëŠ¥</button>
        </div>

        <div style="margin-top:auto; color:#666; font-size:11px;">
          SECURE CONNECTION ESTABLISHED<br>v2.5.0 ULTIMATE
        </div>
      </div>

      <div class="admin-right">
        <div id="pane-dashboard" class="admin-pane active">
          <h2 style="color:#fff; margin-top:0;">ì‹œìŠ¤í…œ í˜„í™©</h2>
          <div class="admin-cards">
            <div class="admin-card"><div class="k">TOTAL USERS</div><div class="v" id="dashTotal">0</div></div>
            <div class="admin-card"><div class="k">PRO MEMBERS</div><div class="v" id="dashPro">0</div></div>
            <div class="admin-card"><div class="k">ACTIVE (7D)</div><div class="v" id="dashActive">0</div></div>
          </div>

          <h4 style="color:#aaa; margin-bottom:5px;">USER TIER DISTRIBUTION</h4>
          <div class="chart-container" id="tierChart"></div>
          <div class="chart-legend">
             <span id="legendFree"><span class="dot" style="background:#444"></span>FREE</span>
             <span id="legendPro"><span class="dot" style="background:#6366f1"></span>PRO</span>
             <span id="legendMaster"><span class="dot" style="background:#ffd700"></span>MASTER</span>
          </div>

          <h3 style="color:#0f0; margin-top:30px;">ğŸ“Ÿ THE MATRIX LOG</h3>
          <div id="matrixLog" class="matrix-terminal">
            <div class="log-line"><span>[SYSTEM]</span> Initializing global surveillance...</div>
          </div>
        </div>

        <div id="pane-users" class="admin-pane">
          <h2 style="color:#fff; margin-top:0;">ìœ ì € ê´€ë¦¬</h2>
          <div style="display:flex; gap:10px; margin-bottom:20px;">
            <input id="adminSearch" placeholder="ì´ë©”ì¼ ê²€ìƒ‰..." style="flex:1; background:#222; border:1px solid #444; color:#fff;">
            <button id="refreshAdminBtn" class="btn" style="background:#333; color:#fff; border:1px solid #555;">ìƒˆë¡œê³ ì¹¨</button>
          </div>
          <div id="admUserList" style="display:grid; gap:10px;"></div>
        </div>

        <div id="pane-tools" class="admin-pane">
          <h2 style="color:#fff; margin-top:0;">ì‹ ì˜ ê¶ŒëŠ¥ (God Tools)</h2>

          <div class="admin-cards" style="grid-template-columns: 1fr 1fr;">
            <div class="admin-card">
              <div class="k">ğŸ’° MASS GIFT</div>
              <p style="color:#888; font-size:12px; margin-bottom:15px;">ëª¨ë“  ìœ ì €ì—ê²Œ 100 ì½”ì¸ì„ ì„ ë¬¼í•©ë‹ˆë‹¤.</p>
              <button onclick="godModeGift()" class="btn" style="width:100%; background:#ffd700; color:#000; border:none; font-weight:900;">ì „ì²´ ì½”ì¸ ë°œì†¡</button>
            </div>

            <div class="admin-card">
              <div class="k">ğŸ“¢ EMERGENCY BROADCAST</div>
              <p style="color:#888; font-size:12px; margin-bottom:10px;">ëª¨ë“  ìœ ì € í™”ë©´ì— ê¸´ê¸‰ ê³µì§€ë¥¼ ë„ì›ë‹ˆë‹¤.</p>
              <div style="display:flex; gap:5px;">
                <input id="broadcastInput" placeholder="ê³µì§€ ë‚´ìš© ì…ë ¥" style="background:#222; border:1px solid #444; color:#fff; width:100%;">
                <button onclick="godModeBroadcast()" class="btn" style="background:#ef4444; color:#fff; border:none; width:auto;">ì „ì†¡</button>
              </div>
            </div>
          </div>

          <div class="admin-card" style="margin-top:20px;">
            <div class="k">ğŸ“‚ DATA BACKUP</div>
            <p style="color:#888; font-size:12px;">ìœ ì € ë°ì´í„°ë¥¼ CSVë¡œ ì¶”ì¶œí•©ë‹ˆë‹¤.</p>
            <button onclick="exportCSV()" class="btn" style="background:#333; color:#fff; border:1px solid #555;">CSV ë‹¤ìš´ë¡œë“œ</button>
          </div>

          <button onclick="document.getElementById('adminPanel').style.display='none'" class="btn" style="margin-top:30px; background:transparent; color:#ef4444; border:1px solid #ef4444; width:100%;">GOD MODE ì¢…ë£Œ</button>
        </div>
      </div>
    </div>
  </div>

  <audio id="bgmAudio" src="./bgm.mp3" preload="auto" loop></audio>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut, getIdTokenResult, sendPasswordResetEmail, sendEmailVerification } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
  import { getFirestore, doc, setDoc, getDoc, collection, getDocs, updateDoc, onSnapshot, addDoc, query, orderBy, limit, arrayUnion } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAIaroNs2VsMamnnNJV1cP9LdXqIDhl3Ig",
    authDomain: "giiiddd-36340523-3f595.firebaseapp.com",
    projectId: "giiiddd-36340523-3f595",
    storageBucket: "giiiddd-36340523-3f595.firebasestorage.app",
    messagingSenderId: "698901018936",
    appId: "1:698901018936:web:2fb12a7a03cbd844c1e9cd"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // ğŸš¨ ê´€ë¦¬ì ì´ë©”ì¼ ì„¤ì •
  const ADMIN_EMAILS = ["test@gmail.com"];

  // ===== Helpers (FIX: missing safeText / scrollToAuth) =====
  function safeText(id, text) {
    const el = document.getElementById(id);
    if (el) el.textContent = text;
  }
  window.scrollToAuth = () => {
    document.getElementById("authSection")?.scrollIntoView({ behavior: "smooth", block: "start" });
  };

  // ğŸ”Š Audio Manager
  const sfx = {
      click: new Audio("https://cdn.pixabay.com/download/audio/2022/03/15/audio_c8c8a73467.mp3?filename=click-124467.mp3"),
      success: new Audio("https://cdn.pixabay.com/download/audio/2021/08/04/audio_bb630cc098.mp3?filename=success-1-6297.mp3"),
      levelUp: new Audio("https://cdn.pixabay.com/download/audio/2022/03/15/audio_7368884964.mp3?filename=success-fanfare-trumpets-6185.mp3"),
      adminOpen: new Audio("https://cdn.pixabay.com/download/audio/2022/03/24/audio_03e0545939.mp3?filename=sci-fi-click-903.mp3"),
      play: (name) => { try { sfx[name].currentTime=0; sfx[name].play(); } catch(e){} }
  };

  const STICKERS = ["ğŸ","ğŸ’Š","ğŸ“š","ğŸ¸","ğŸ’","ğŸ‘‘","ğŸš€","ğŸ¦„","ğŸ¦–","ğŸ•","ğŸŒˆ","ğŸ”¥","ğŸ’§","â­","ğŸ€","ğŸ„"];
  const themeData = {
    survival: ["ğŸ›Œ ë°¤ 11ì‹œ í° ë„ê¸°", "ğŸ’§ ê³µë³µ ë¬¼ í•œ ì”", "ğŸ’Š ì˜ì–‘ì œ ì±™ê²¨ë¨¹ê¸°", "ğŸ¢ ê±°ë¶ëª© ìŠ¤íŠ¸ë ˆì¹­", "ğŸ‘ï¸ ë¨¼ ì‚° ë³´ê¸°", "ğŸ§¹ ì±…ìƒ ìœ„ ë¦¬ì…‹"],
    godsaeng: ["ğŸ“… ì£¼ê°„ ê³„íš", "ğŸ›ï¸ ì´ë¶ˆ ì •ë¦¬", "ğŸ’° ê°€ê³„ë¶€", "ğŸ“š ë…ì„œ 2p", "ğŸ—£ï¸ ì˜ë‹¨ì–´ 1ê°œ", "ğŸ“ ê°ì‚¬ì¼ê¸°"],
    detox: ["ğŸ“ ì†ê¸°ë¡", "ğŸ“µ ê¸°ìƒí›„ ë…¸í°", "ğŸ½ï¸ ë°¥ë¨¹ì„ë•Œ í°X", "ğŸ§ ì´ì–´í° ë¹¼ê¸°", "ğŸ§˜ ëª…ìƒ 5ë¶„"],
    custom: []
  };

  // Rotating Recommendation
  const recommendations = [
      { t: "ğŸš‘ ìƒì¡´ ì²´ë ¥ íŒ©", d: 'ì§ì¥ì¸ì„ ìœ„í•œ "ì£½ì§€ ì•Šìœ¼ë ¤ê³  í•˜ëŠ” ìš´ë™"' },
      { t: "âœ¨ ê°“ìƒ ì…ë¬¸ íŒ©", d: 'ì„±ê³µ ë£¨í‹´ì„ 2ë¶„ì§œë¦¬ë¡œ ìª¼ê°œê¸°' },
      { t: "ğŸ§˜ ë””í†¡ìŠ¤ íë§ íŒ©", d: 'ìŠ¤ë§ˆíŠ¸í° ë‚´ë ¤ë†“ê³  ë‡Œ íœ´ì‹í•˜ê¸°' }
  ];
  let recIdx = 0;
  setInterval(() => {
      const card = document.getElementById('heroRecommendCard');
      if(card) {
          recIdx = (recIdx + 1) % recommendations.length;
          card.style.opacity = 0;
          setTimeout(() => {
              card.innerHTML = `<div><b>${recommendations[recIdx].t}</b></div><span style="font-size:12px; color:var(--text-muted)">${recommendations[recIdx].d}</span>`;
              card.style.opacity = 1;
          }, 500);
      }
  }, 4000);

  // Workout Challenge (FIX: event usage removed)
  window.selectWorkoutTab = (type) => {
      sfx.play('click');
      document.querySelectorAll('.w-tab').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.type === type);
      });
      document.getElementById('startWorkoutBtn').dataset.type = type;
      document.getElementById('workoutResult').innerHTML = '<span class="wd-main">â“</span><div class="wd-sub">ì¢…ëª© ì„ íƒ í›„ ë¯¸ì…˜ ë½‘ê¸°!</div>';
      document.getElementById('completeWorkoutBtn').style.display = 'none';
      document.getElementById('startWorkoutBtn').style.display = 'inline-block';
  };

  document.getElementById("startWorkoutBtn").onclick = () => {
      sfx.play('click');
      const type = document.getElementById('startWorkoutBtn').dataset.type;
      if(!type) return alert("ì¢…ëª©ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”!");

      const res = document.getElementById("workoutResult");
      res.innerHTML = '<span class="workout-anim">...ë‘êµ¬ë‘êµ¬...</span>';

      setTimeout(() => {
          let mainText = "";
          let subText = "í™”ì´íŒ…!";
          if(type === 'walk') {
              const times = [30, 60, 90, 120];
              const t = times[Math.floor(Math.random()*times.length)];
              mainText = `ğŸš¶ ê±·ê¸° ${t}ë¶„`;
              subText = "ê°€ë³ê²Œ ì‹œì‘í•´ë³´ì„¸ìš”!";
          } else if(type === 'run') {
              const times = [20, 30, 40, 60];
              const t = times[Math.floor(Math.random()*times.length)];
              mainText = `ğŸƒ ë‹¬ë¦¬ê¸° ${t}ë¶„`;
              subText = "ì‹¬ì¥ì´ í„°ì§ˆ ë•Œê¹Œì§€!";
          } else {
              const routines = ["ìŠ¤ì¿¼íŠ¸ 100ê°œ", "í‘¸ì‰¬ì—… 50ê°œ + í”Œë­í¬ 3ë¶„", "ë“± ìš´ë™ 5ì„¸íŠ¸", "í•˜ì²´ ì§‘ì¤‘ íƒ€ê²©", "ë²„í”¼ 50íšŒ"];
              mainText = `ğŸ‹ï¸ ${routines[Math.floor(Math.random()*routines.length)]}`;
              subText = "ê·¼ì„±ì¥ ê°€ì¦ˆì•„!";
          }
          res.innerHTML = `<div class="wd-main">${mainText}</div><div class="wd-sub">${subText}</div>`;
          document.getElementById('startWorkoutBtn').style.display = 'none';
          document.getElementById('completeWorkoutBtn').style.display = 'inline-block';
      }, 1000);
  };

  document.getElementById("completeWorkoutBtn").onclick = async () => {
      sfx.play('success');
      const user = auth.currentUser;
      if(!user) return;
      const ref = doc(db,"users",user.uid);
      const snap = await getDoc(ref);
      let coins = snap.data().coins || 0;
      coins += 3;
      await updateDoc(ref, { coins });
      alert("ğŸ”¥ ì±Œë¦°ì§€ ì™„ë£Œ! ì½”ì¸ 3ê°œ íšë“!");
      updateLevelUI(user.uid);
      confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
      document.getElementById('completeWorkoutBtn').style.display = 'none';
      document.getElementById('startWorkoutBtn').style.display = 'inline-block';
      document.getElementById('workoutResult').innerHTML = '<div class="wd-main">âœ… ì™„ë£Œ</div><div class="wd-sub">ë‚´ì¼ ë˜ ë„ì „í•˜ì„¸ìš”!</div>';
  };

  function dateKeyFromOffset(n) { const d = new Date(); d.setDate(d.getDate()-n); return d.toISOString().slice(0,10); }
  async function getConsecutiveStreak(uid) {
    let c = 0, d = new Date();
    while(true) {
      if(!(await getDoc(doc(db,"users",uid,"habits",d.toISOString().slice(0,10)))).exists()) break;
      c++; d.setDate(d.getDate()-1);
    }
    return c;
  }

  async function updateLevelUI(uid) {
    const d = (await getDoc(doc(db,"users",uid))).data() || {};
    const lvl = d.level||1;
    document.getElementById("levelBadge").innerText = `Lv.${lvl}`;
    document.getElementById("xpText").innerText = `${d.xp||0} / 100 XP`;
    document.getElementById("xpBar").style.width = `${(d.xp||0)}%`;
    document.getElementById("coinDisplay").style.display = 'flex';
    document.getElementById("coinCount").innerText = d.coins||0;
    document.getElementById("shopCoinCount").innerText = d.coins||0;

    // Title Rank System
    let title = "ì…ë¬¸ì";
    if(lvl >= 5) title = "ìˆ™ë ¨ì";
    if(lvl >= 10) title = "ì „ë¬¸ê°€";
    if(lvl >= 20) title = "ìŠµê´€ì˜ ì‹ ";
    document.getElementById("welcome").innerHTML = `ğŸ‘‹ ${d.email.split('@')[0]} <span style="font-size:12px; color:var(--primary);">[${title}]</span>`;

    const petC = document.getElementById("petContainer");
    if(d.isMaster) petC.classList.add("aura-effect");
    else petC.classList.remove("aura-effect");

    let emoji = "ğŸ¥š";
    if(lvl>=16) emoji="ğŸ‘‘"; else if(lvl>=8) emoji="ğŸ²"; else if(lvl>=4) emoji="ğŸ¥"; else if(lvl>=2) emoji="ğŸ£";
    document.getElementById("petEmoji").innerText = emoji;
  }

  // --- Sticker Logic ---
  let isDeleteMode = false;
  const trashBtn = document.getElementById("trashModeBtn");
  trashBtn.onclick = () => {
      sfx.play('click');
      isDeleteMode = !isDeleteMode;
      trashBtn.style.background = isDeleteMode ? "#ef4444" : "var(--accent)";
      document.body.classList.toggle("is-delete-mode");
      alert(isDeleteMode ? "ğŸ—‘ï¸ ì‚­ì œ ëª¨ë“œ ON: ìŠ¤í‹°ì»¤ë¥¼ í´ë¦­í•´ì„œ ì§€ìš°ì„¸ìš”." : "âœ¨ ì‚­ì œ ëª¨ë“œ OFF");
  };

  async function loadInventory(uid) {
      const d = (await getDoc(doc(db,"users",uid))).data() || {};
      const list = document.getElementById("inventoryList"); list.innerHTML = "";
      (d.inventory||[]).forEach(s => {
          const div = document.createElement("div"); div.innerText = s;
          div.style.cssText = "font-size:30px; cursor:grab; background:white; border-radius:8px; text-align:center;";
          div.onmousedown = (e) => startDrag(e,s,uid,true);
          div.ontouchstart = (e) => startDrag(e,s,uid,true);
          list.appendChild(div);
      });
      document.getElementById("shopCoinCount").innerText = d.coins||0;
  }

  async function loadPlacedStickers(uid) {
      const d = (await getDoc(doc(db,"users",uid))).data() || {};
      const layer = document.getElementById("stickerLayer"); layer.innerHTML = "";
      (d.placedStickers||[]).forEach(s => createStickerEl(s, uid));
  }

  function createStickerEl(data, uid) {
      const el = document.createElement("div"); el.className = "sticker"; el.innerText = data.char;
      el.style.left = data.x+"%"; el.style.top = data.y+"%"; el.id = data.id;

      const dragStart = (e) => {
          if(isDeleteMode) return;
          startDrag(e, el, uid, false);
      };
      el.addEventListener('mousedown', dragStart);
      el.addEventListener('touchstart', dragStart, {passive:false});

      el.addEventListener('click', async (e) => {
          if(!isDeleteMode) return;
          e.stopPropagation(); e.preventDefault();
          if(confirm("ì´ ìŠ¤í‹°ì»¤ë¥¼ ì‚­ì œí• ê¹Œìš”?")) {
              el.remove();
              const r = doc(db,"users",uid);
              const p = (await getDoc(r)).data().placedStickers || [];
              await updateDoc(r, { placedStickers: p.filter(s => s.id !== data.id) });
          }
      });
      document.getElementById("stickerLayer").appendChild(el);
  }

  let dragCtx = null;
  function startDrag(e, target, uid, isNew) {
      if(isDeleteMode) return;
      e.preventDefault();
      const el = isNew ? document.createElement("div") : target;
      if(isNew) { el.className = "sticker"; el.innerText = target; el.style.pointerEvents="none"; document.body.appendChild(el); }

      dragCtx = { el, isNew, char: isNew?target:null, uid };
      const cx = e.clientX||e.touches[0].clientX;
      const cy = e.clientY||e.touches[0].clientY;

      if(!isNew) {
          const r = el.getBoundingClientRect();
          dragCtx.ox = cx - r.left; dragCtx.oy = cy - r.top;
          el.style.zIndex = 1000;
      } else {
          el.style.left = (cx-20)+"px"; el.style.top = (cy-20)+"px";
      }

      document.addEventListener('mousemove', onMove); document.addEventListener('mouseup', onEnd);
      document.addEventListener('touchmove', onMove, {passive:false}); document.addEventListener('touchend', onEnd);
  }

  function onMove(e) {
      if(!dragCtx) return;
      e.preventDefault();
      const cx = e.clientX||e.touches[0].clientX; const cy = e.clientY||e.touches[0].clientY;
      if(dragCtx.isNew) { dragCtx.el.style.left=(cx-20)+"px"; dragCtx.el.style.top=(cy-20)+"px"; }
      else { dragCtx.el.style.left=(cx-dragCtx.ox)+"px"; dragCtx.el.style.top=(cy-dragCtx.oy)+"px"; }
  }

  async function onEnd(e) {
      document.removeEventListener('mousemove', onMove); document.removeEventListener('mouseup', onEnd);
      document.removeEventListener('touchmove', onMove); document.removeEventListener('touchend', onEnd);
      if(!dragCtx) return;

      const layer = document.getElementById("stickerLayer");
      const r = layer.getBoundingClientRect();
      const cx = e.clientX||(e.changedTouches?e.changedTouches[0].clientX:0);
      const cy = e.clientY||(e.changedTouches?e.changedTouches[0].clientY:0);

      let x, y;
      if(dragCtx.isNew) {
          x = ((cx - r.left)/r.width)*100; y = ((cy - r.top)/r.height)*100;
          dragCtx.el.remove();
      } else {
          const er = dragCtx.el.getBoundingClientRect();
          x = ((er.left - r.left)/r.width)*100; y = ((er.top - r.top)/r.height)*100;
          dragCtx.el.style.zIndex="";
      }

      const ref = doc(db,"users",dragCtx.uid);
      const placed = (await getDoc(ref)).data().placedStickers || [];

      if(dragCtx.isNew) {
          const s = { id: Date.now().toString(), char: dragCtx.char, x, y };
          placed.push(s); createStickerEl(s, dragCtx.uid);
      } else {
          const i = placed.findIndex(s => s.id === dragCtx.el.id);
          if(i>-1) { placed[i].x=x; placed[i].y=y; dragCtx.el.style.left=x+"%"; dragCtx.el.style.top=y+"%"; }
      }
      await updateDoc(ref, { placedStickers: placed });
      dragCtx = null;
  }

  window.selectTheme = async (el, type) => {
      sfx.play('click');
      const user = auth.currentUser; if(!user) return alert("ë¡œê·¸ì¸ í•„ìš”");
      const input = document.getElementById("habitName");
      document.querySelectorAll('.theme-tag').forEach(t=>t.classList.remove('active'));

      if(type==='custom') {
          const t = await getIdTokenResult(user);
          if(!t.claims.pro && !t.claims.admin) return alert("ğŸ”’ PRO ì „ìš©");
          input.readOnly=false; input.value=""; input.focus();
      } else {
          input.readOnly=true;
          const pool = themeData[type];
          input.value = pool[Math.floor(Math.random()*pool.length)];
      }
      if(el) el.classList.add('active');
  };

  window.showProModal = (type) => {
      document.getElementById("modalTitle").innerText = `ğŸ‘‘ ${type} ì—…ê·¸ë ˆì´ë“œ`;
      document.getElementById("proModal").style.display = 'flex';
  };

  window.changeTheme = async (c) => {
      const user = auth.currentUser; if(!user) return;
      const d = (await getDoc(doc(db,"users",user.uid))).data();
      if(!d.isUltra && !d.isMaster && user.email!=="test@gmail.com") return alert("ğŸ’ ULTRA ì „ìš©");

      let p, s;
      if(c==='blue') { p='#3b82f6'; s='#60a5fa'; }
      else if(c==='pink') { p='#ec4899'; s='#f472b6'; }
      else if(c==='gold') { p='#d97706'; s='#fbbf24'; }
      else { p='#6366f1'; s='#a855f7'; }
      document.documentElement.style.setProperty('--primary', p);
      document.documentElement.style.setProperty('--secondary', s);
      document.querySelector('.blob-1').style.background = s;
      document.querySelector('.blob-2').style.background = p;
  };

  async function loadStats(uid) {
      const snap = await getDocs(collection(db,"users",uid,"habits"));
      let successCount = 0;
      snap.forEach(x => { if(x.data().done) successCount++; });
      safeText("totalDays", `ì´ ëˆ„ì  ì„±ê³µ: ${successCount}ì¼`);
  }

  // Memo Saving
  document.getElementById("saveMemoBtn").onclick = async () => {
      sfx.play('click');
      const user = auth.currentUser; if(!user) return;
      const memo = document.getElementById("dailyMemo").value;
      if(!memo.trim()) return alert("ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”");

      const today = dateKeyFromOffset(0);
      await setDoc(doc(db,"users",user.uid,"habits",today), { memo: memo }, { merge: true });
      alert("âœ… ë©”ëª¨ ì €ì¥ ì™„ë£Œ!");
      renderMemoHistory(user.uid);
  };

  async function renderMemoHistory(uid) {
      const listDiv = document.getElementById("memoHistoryList");
      listDiv.innerHTML = "ë¡œë”© ì¤‘...";

      const snap = await getDocs(collection(db,"users",uid,"habits"));
      let memos = [];
      snap.forEach(d => {
          const data = d.data();
          if(data.memo) memos.push({date: d.id, text: data.memo});
      });

      memos.sort((a,b) => new Date(b.date) - new Date(a.date));

      if(memos.length === 0) {
          listDiv.innerHTML = '<div style="text-align:center; padding:10px; color:var(--text-muted); font-size:13px;">ê¸°ë¡ëœ ë©”ëª¨ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
          return;
      }

      listDiv.innerHTML = "";
      memos.forEach(m => {
          const div = document.createElement("div");
          div.className = "memo-item";
          div.innerHTML = `<div class="memo-date">${m.date}</div><div>${m.text}</div>`;
          listDiv.appendChild(div);
      });
  }

  // Global Cheer
  document.getElementById("globalCheerBtn").onclick = async () => {
      sfx.play('success');
      const user = auth.currentUser;
      if(!user) return;
      await addDoc(collection(db, "global_logs"), {
          msg: "CHEER",
          type: "cheer",
          timestamp: new Date()
      });
      triggerHearts();
  };

  function triggerHearts() {
      for(let i=0; i<5; i++) {
          const heart = document.createElement("div");
          heart.innerText = "ğŸ’–";
          heart.className = "cheer-heart";
          heart.style.left = Math.random() * 100 + "vw";
          heart.style.bottom = "-20px";
          heart.style.animationDuration = (3 + Math.random()) + "s";
          document.body.appendChild(heart);
          setTimeout(() => heart.remove(), 4000);
      }
  }

  // ===== Missing stubs (kept safe) =====
  function renderCalendar(){ /* (placeholder) */ }
  function updateTierUI(streak) {
      const el = document.getElementById("tierBadge");
      if(el) {
          el.style.display = 'block';
          const txt = document.getElementById("streakCount");
          if(streak >= 3) txt.innerHTML = `ğŸ”¥ ${streak}ì¼ ì—°ì† ì„±ê³µ!`;
          else txt.innerHTML = `ğŸ”¥ ${streak}ì¼ ì—°ì† ì„±ê³µ ì¤‘!`;
      }
  }

  // =====================================================
  // ğŸ”¥ NEW FEATURE PACK (ADD-ONLY) - FIXED/INTEGRATED
  // =====================================================

  // 1ï¸âƒ£ ì‹¤íŒ¨ ê°ì • ê¸°ë¡
  window.recordFailEmotion = async (emotion) => {
    const user = auth.currentUser;
    if (!user) return;

    const today = dateKeyFromOffset(0);
    await setDoc(
      doc(db, "users", user.uid, "fail_logs", today),
      { emotion, timestamp: new Date() },
      { merge: true }
    );

    alert("ê¸°ë¡í–ˆì–´ìš” ğŸ‘ ë‚´ì¼ì€ ë” ì‰¬ì›Œì§ˆ ê±°ì˜ˆìš”.");
  };

  // ì‹¤íŒ¨ ê°ì • UI ìë™ ì‚½ì… (1íšŒë§Œ)
  function injectFailBoxOnce() {
    if (document.getElementById("failBox")) return;
    const failBox = document.createElement("div");
    failBox.id = "failBox";
    failBox.style.cssText = `
      margin-top:15px;
      padding:12px;
      border-radius:12px;
      background:rgba(239,68,68,0.08);
      font-size:13px;
      text-align:left;
      border:1px solid rgba(239,68,68,0.15);
    `;
    failBox.innerHTML = `
      <b>ì˜¤ëŠ˜ ëª»í–ˆë‹¤ë©´ ì´ìœ ë§Œ ì²´í¬í•˜ì„¸ìš”</b>
      <div style="display:flex; gap:6px; margin-top:8px; flex-wrap:wrap;">
        <button class="btn" style="width:auto; padding:8px 10px; font-size:12px;" onclick="recordFailEmotion('tired')">ğŸ˜µ ì§€ì¹¨</button>
        <button class="btn" style="width:auto; padding:8px 10px; font-size:12px;" onclick="recordFailEmotion('lazy')">ğŸ˜ ê·€ì°®ìŒ</button>
        <button class="btn" style="width:auto; padding:8px 10px; font-size:12px;" onclick="recordFailEmotion('sad')">ğŸ˜­ ì˜ìš•ì—†ìŒ</button>
        <button class="btn" style="width:auto; padding:8px 10px; font-size:12px;" onclick="recordFailEmotion('busy')">ğŸ˜¡ ë°”ì¨</button>
      </div>
      <div style="margin-top:10px; display:flex; gap:8px; align-items:center;">
        <button class="btn" style="width:auto; padding:8px 10px; font-size:12px; border:1px dashed var(--card-border);" onclick="analyzeHabitDNA(auth.currentUser?.uid)">ğŸ§¬ ìŠµê´€ DNA</button>
        <span style="font-size:12px; color:var(--text-muted);">(ë°ì´í„° ê¸°ë°˜ íƒ€ì… ë¶„ì„)</span>
      </div>
    `;
    document.getElementById("app")?.appendChild(failBox);
  }

  // 2ï¸âƒ£ ìŠµê´€ ë¯¸ì™„ë£Œ ì•Œë¦¼ (ë¸Œë¼ìš°ì €) - FIX: ì‹¤ì œ 'ì˜¤ëŠ˜ 18:00'ì— ë§ì¶¤
  function scheduleHabitReminderAt18() {
    try {
      const user = auth.currentUser;
      if (!user) return;

      const now = new Date();
      const target = new Date();
      target.setHours(18, 0, 0, 0);
      if (now > target) target.setDate(target.getDate() + 1);
      const ms = target.getTime() - now.getTime();

      setTimeout(() => {
        const u = auth.currentUser;
        if (!u) return;

        const today = dateKeyFromOffset(0);
        getDoc(doc(db, "users", u.uid, "habits", today)).then(s => {
          if (s.exists() && s.data().done) return;

          if (!("Notification" in window)) return;
          Notification.requestPermission().then(p => {
            if (p === "granted") {
              new Notification("â° HabitFlow", {
                body: "ì˜¤ëŠ˜ ìŠµê´€ ì•„ì§ ì•ˆ í–ˆì–´ìš”! ë”± 1ë¶„ì´ë©´ ëë‚˜ìš”.",
                icon: "https://cdn-icons-png.flaticon.com/512/2921/2921222.png"
              });
            }
          });
        });
      }, ms);
    } catch(e) {}
  }

  // 3ï¸âƒ£ ì—°ì† ê¸°ë¡ ìœ„ê¸° ê²½ê³  (FIX: ì˜¤ëŠ˜ ì™„ë£Œ ì•ˆí–ˆì„ ë•Œë§Œ)
  async function checkStreakDanger(uid) {
    const today = dateKeyFromOffset(0);
    const todaySnap = await getDoc(doc(db, "users", uid, "habits", today));
    if (todaySnap.exists() && todaySnap.data().done) return;

    // streak = ì—°ì† ê¸°ë¡(ì˜¤ëŠ˜ ë¯¸ì™„ì´ë©´ ì–´ì œê¹Œì§€ ì—°ì†)
    const streak = await getConsecutiveStreak(uid);
    if (streak >= 3) {
      alert(`ğŸ”¥ ${streak}ì¼ ì—°ì† ì¤‘!\nì˜¤ëŠ˜ ì•ˆ í•˜ë©´ ê¸°ë¡ì´ ëŠê¸¸ ìˆ˜ ìˆì–´ìš”!`);
    }
  }

  // 4ï¸âƒ£ ìŠµê´€ DNA íƒ€ì… ìë™ ë¶„ì„
  async function analyzeHabitDNA(uid) {
    if(!uid) return;
    const snap = await getDocs(collection(db, "users", uid, "habits"));
    const days = snap.size;

    let type = "ğŸ¢ ê±°ë¶ì´í˜•";
    if (days > 20) type = "âš¡ í­ì£¼í˜•";
    else if (days > 10) type = "ğŸ” ë°˜ë³µí˜•";
    else if (days <= 3) type = "ğŸ’¥ ëª°ì•„ì¹˜ê¸°í˜•";

    alert(`ğŸ§¬ ë‹¹ì‹ ì˜ ìŠµê´€ DNA\n\n${type}`);
  }
  window.analyzeHabitDNA = analyzeHabitDNA;

  // 5ï¸âƒ£ íˆë“  ì—…ì 
  async function checkHiddenAchievement(uid) {
    const streak = await getConsecutiveStreak(uid);
    if (streak === 7) {
      document.getElementById("achievementTitle").innerText = "ğŸ•µï¸ ìˆ¨ê²¨ì§„ 7ì¼ ë‹¬ì„±";
      document.getElementById("achievementToast").style.display = "flex";
      setTimeout(() => {
        document.getElementById("achievementToast").style.display = "none";
      }, 4000);
    }
  }

  // =====================================================
  // Auth State
  // =====================================================
  let globalLogsUnsub = null;
  let broadcastUnsub = null;

  onAuthStateChanged(auth, async user => {
      if(!user) {
          document.getElementById("auth").style.display='block';
          document.getElementById("dashboardLayout").style.display='none';
          document.getElementById("coinDisplay").style.display = 'none';
          ['adminOpenBtn','rankOpenBtn','shopOpenBtn','trashModeBtn','bgmOpenBtn','themeBtn'].forEach(id=>document.getElementById(id).style.display='none');

          // clean listeners
          try { globalLogsUnsub && globalLogsUnsub(); } catch(e){}
          try { broadcastUnsub && broadcastUnsub(); } catch(e){}
          globalLogsUnsub = null; broadcastUnsub = null;

          return;
      }

      const isAdmin = ADMIN_EMAILS.includes(user.email || "");
      if(!user.emailVerified && !isAdmin) { alert("ì¸ì¦ í•„ìš”"); await signOut(auth); return; }

      document.getElementById("auth").style.display='none';
      document.getElementById("dashboardLayout").style.display='flex';

      ['rankOpenBtn','shopOpenBtn','trashModeBtn','bgmOpenBtn'].forEach(id=>document.getElementById(id).style.display='block');

      const userRef = doc(db,"users",user.uid);
      let snap = await getDoc(userRef);
      if(!snap.exists()){
          await setDoc(userRef, {
              email: user.email, isPro: false, isUltra: false, isMaster: false, isBanned: false,
              streakProtectionLeft: 2,
              level: 1, xp: 0, coins: 0,
              createdAt: new Date().toISOString()
          }, {merge:true});
          snap = await getDoc(userRef);
      }

      if(snap.data().isBanned){ alert("ì°¨ë‹¨ëœ ê³„ì •ì…ë‹ˆë‹¤."); await signOut(auth); return; }

      let { isPro, isUltra, isMaster } = snap.data() || {};

      if(isAdmin) {
          isPro=true; isUltra=true; isMaster=true;
          document.getElementById("adminOpenBtn").style.display='block';
          globalLogsUnsub = subscribeToGlobalLogs(false);
      } else {
          globalLogsUnsub = subscribeToGlobalLogs(true);
      }

      broadcastUnsub = subscribeToBroadcast();

      if(isUltra || isMaster) {
          document.getElementById("themeBtn").style.display='block';
          document.getElementById("bgmSelect").style.display='block';
      }
      if(isMaster) {
          document.getElementById("workoutSidePanel").style.display='block';
          document.getElementById("timerBtn").style.display='block';
      } else {
          document.getElementById("workoutSidePanel").style.display='none';
          document.getElementById("timerBtn").style.display='none';
      }

      // Memo UI
      document.getElementById("memoPanel").style.display = 'flex';
      document.getElementById("memoHistoryPanel").style.display = 'flex';
      if(isPro || isUltra || isMaster) {
          document.getElementById("memoLocked").style.display='none';
          const today = dateKeyFromOffset(0);
          const s = await getDoc(doc(db,"users",user.uid,"habits",today));
          if(s.exists() && s.data().memo) document.getElementById("dailyMemo").value = s.data().memo;
          renderMemoHistory(user.uid);
      } else {
          document.getElementById("memoLocked").style.display='flex';
          document.getElementById("memoHistoryPanel").style.display='none';
      }

      if(isPro||isUltra||isMaster) {
          document.getElementById("stats").style.display='block';
          safeText("status", isMaster?"ğŸ‘‘ MASTER":isUltra?"ğŸ’ ULTRA":"ğŸŒŸ PRO");
          loadStats(user.uid);
      } else {
          safeText("status", "ğŸŒ± ë¬´ë£Œ íšŒì›");
      }

      updateLevelUI(user.uid);
      loadPlacedStickers(user.uid);

      const streak = await getConsecutiveStreak(user.uid);
      updateTierUI(streak);

      renderCalendar(user.uid, (isPro||isUltra||isMaster));

      // Heatmap
      const grid=document.getElementById("heatmapGrid"); grid.innerHTML="";
      for(let i=19; i>=0; i--) {
          const d = dateKeyFromOffset(i);
          const div=document.createElement("div"); div.className="grass"; div.title=d;
          if((await getDoc(doc(db,"users",user.uid,"habits",d))).exists()) div.classList.add("active");
          grid.appendChild(div);
      }

      // NEW FEATURE PACK - auto run
      injectFailBoxOnce();
      scheduleHabitReminderAt18();
      checkStreakDanger(user.uid);
      checkHiddenAchievement(user.uid);
  });

  // Buttons Logic
  document.getElementById("habitBtn").onclick = async () => {
      sfx.play('success');
      const user=auth.currentUser; if(!user) return;
      const name = document.getElementById("habitName").value;
      if(!name || name==="í…Œë§ˆë¥¼ ì„ íƒí•˜ì„¸ìš”") return alert("ìŠµê´€ ì…ë ¥");

      await setDoc(doc(db,"users",user.uid,"habits",dateKeyFromOffset(0)), {done:true, name, timestamp:new Date()}, {merge:true});
      await setDoc(doc(db,"users",user.uid), {updatedAt:new Date().toISOString(), lastActive: new Date()}, {merge:true});

      const ref = doc(db,"users",user.uid);
      const snap = await getDoc(ref);
      let { level=1, xp=0, coins=0, isUltra, isMaster } = snap.data() || {};

      xp+=20;
      coins += isMaster ? 3 : (isUltra ? 2 : 1);

      if(xp>=100) {
          level++; xp-=100;
          sfx.play('levelUp');
          document.getElementById('levelUpOverlay').style.display = 'flex';
          confetti({particleCount: 200, spread: 120});
      } else {
          confetti({particleCount: 100, origin:{y:0.7}});
      }

      await setDoc(ref, {level, xp, coins}, {merge:true});

      await addDoc(collection(db, "global_logs"), {
          msg: `${user.email.split('@')[0]}ë‹˜ì´ [${name}] ì™„ë£Œ!`,
          type: "success",
          timestamp: new Date()
      });

      updateLevelUI(user.uid);

      const btn = document.getElementById("habitBtn");
      btn.innerHTML = "ì™„ë£Œí•¨ âœ¨"; btn.disabled=true;
  };

  document.getElementById("gachaBtn").onclick = async () => {
      sfx.play('click');
      const user=auth.currentUser; if(!user) return;
      const ref = doc(db,"users",user.uid);
      const snap = await getDoc(ref);
      let coins = snap.data().coins||0;
      if(coins<1) return alert("ì½”ì¸ ë¶€ì¡±");

      coins--;
      const p = STICKERS[Math.floor(Math.random()*STICKERS.length)];
      await updateDoc(ref, { coins, inventory: arrayUnion(p) });

      alert(`ğŸ‰ [${p}] íšë“!`);
      updateLevelUI(user.uid); loadInventory(user.uid);
  };

  // Timer
  let timer=null, timeLeft=1500;
  document.getElementById("timerBtn").onclick = () => document.getElementById("timerModal").style.display='flex';
  document.getElementById("startTimerBtn").onclick = () => {
      if(timer) return;
      sfx.play('click');
      timer = setInterval(() => {
          if(timeLeft<=0) { clearInterval(timer); timer=null; timeLeft=1500; sfx.play('success'); alert("ì§‘ì¤‘ ë!"); return; }
          timeLeft--;
          const m = Math.floor(timeLeft/60), s = timeLeft%60;
          document.getElementById("timerDisplay").innerText = `${m}:${s<10?'0':''}${s}`;
      }, 1000);
  };
  document.getElementById("stopTimerBtn").onclick = () => { clearInterval(timer); timer=null; };

  // Helper UIs
  ['rank','shop'].forEach(k => {
      document.getElementById(k+'OpenBtn').onclick = () => {
          sfx.play('click');
          const panel = document.getElementById(k+'Panel');
          panel.style.display = panel.style.display==='none'?'block':'none';
          if(k==='rank') loadLeaderboard();
          if(k==='shop') loadInventory(auth.currentUser.uid);
      }
  });

  async function loadLeaderboard() {
      const list = document.getElementById("rankList"); list.innerHTML="ë¡œë”©...";
      const snap = await getDocs(collection(db,"users"));
      let u = []; snap.forEach(d=>u.push(d.data()));
      u.sort((a,b)=> (b.level||1) - (a.level||1));
      list.innerHTML = u.slice(0,10).map((x,i)=>`<div style="padding:5px; border-bottom:1px solid #eee;">${i+1}. ${x.email?.slice(0,3)}*** Lv.${x.level||1}</div>`).join('');
  }

  // BGM Logic
  const audio = document.getElementById("bgmAudio");
  document.getElementById("bgmOpenBtn").onclick = () => document.getElementById("bgm").style.display='block';
  document.getElementById("bgmToggle").onclick = () => { audio.paused ? audio.play() : audio.pause(); };
  document.getElementById("bgmSelect").onchange = (e) => { audio.src = e.target.value; audio.play(); };
  document.getElementById("bgmVol").oninput = (e) => { audio.volume = Number(e.target.value); };

  // Theme Toggle
  const toggle = document.getElementById("darkModeToggle");
  toggle.onclick = () => {
    sfx.play('click');
    document.body.classList.toggle("dark-mode");
    localStorage.setItem("darkMode", document.body.classList.contains("dark-mode") ? "on" : "off");
  };
  if (localStorage.getItem("darkMode") === "on") document.body.classList.add("dark-mode");

  // Zen Mode
  window.toggleZenMode = () => {
      const zen = document.getElementById("zenOverlay");
      if(zen.style.display === "flex") {
          zen.style.opacity = 0;
          setTimeout(()=>zen.style.display="none", 350);
      } else {
          zen.style.display = "flex";
          setTimeout(()=>zen.style.opacity = 1, 10);
      }
  };

  // Broadcast Listener (FIX: returns unsubscribe)
  function subscribeToBroadcast() {
      return onSnapshot(doc(db, "config", "broadcast"), (snap) => {
          if(snap.exists()) {
              const d = snap.data();
              let ts = null;
              if (d.timestamp?.toDate) ts = d.timestamp.toDate();
              else ts = new Date(d.timestamp || Date.now());

              const diff = (new Date() - ts) / 1000;
              if(diff < 60) {
                  sfx.play('success');
                  const el = document.getElementById("broadcastOverlay");
                  document.getElementById("broadcastMsg").innerText = d.message;
                  el.classList.add("active");
                  setTimeout(() => el.classList.remove("active"), 5000);
              }
          }
      });
  }

  // Ticker / Matrix Listener (FIX: tickerContent id + safe append)
  function subscribeToGlobalLogs(isPublic = false) {
      const q = query(collection(db, "global_logs"), orderBy("timestamp", "desc"), limit(20));
      return onSnapshot(q, (snap) => {
          snap.docChanges().forEach(change => {
              if (change.type === "added") {
                  const data = change.doc.data();

                  // Matrix Log (Admin Only)
                  if(!isPublic) {
                      const term = document.getElementById("matrixLog");
                      if(term) {
                          const div = document.createElement("div");
                          div.className = "log-line";
                          div.innerHTML = `<span>[${new Date().toLocaleTimeString()}]</span> ${data.msg || ""}`;
                          term.prepend(div);
                      }
                  }

                  // Ticker & Cheer
                  if (data.type === "cheer") {
                      triggerHearts();
                  } else {
                      const track = document.getElementById("tickerContent");
                      if(!track) return;
                      const item = document.createElement("div");
                      item.className = "ticker-item";
                      item.innerHTML = `âš¡ ${data.msg || ""}`;
                      track.appendChild(item);

                      // ë„ˆë¬´ ê¸¸ì–´ì§€ë©´ ì •ë¦¬
                      const items = track.querySelectorAll(".ticker-item");
                      if(items.length > 30) items[0].remove();
                  }
              }
          });
      });
  }

  // =========================================================
  // ğŸ‘‘ GOD MODE ADMIN LOGIC
  // =========================================================

  const adminPanel = document.getElementById("adminPanel");
  const adminNavBtns = document.querySelectorAll(".adminNavBtn");
  const panes = document.querySelectorAll(".admin-pane");
  const adminSubtitle = document.getElementById("adminSubtitle");
  const refreshAdminBtn = document.getElementById("refreshAdminBtn"); // FIX: correct id

  document.getElementById("adminOpenBtn").onclick = () => {
      sfx.play('adminOpen');
      adminPanel.style.display = "block";
      adminSubtitle.textContent = `SYSTEM ACCESS: ${auth.currentUser.email}`;
      window.refreshAdmin();
  };

  adminNavBtns.forEach(btn => {
      btn.addEventListener("click", () => {
          sfx.play('click');
          adminNavBtns.forEach(b => b.classList.remove("active"));
          btn.classList.add("active");
          panes.forEach(p => p.classList.remove("active"));
          document.getElementById(btn.dataset.pane).classList.add("active");
      });
  });

  if(refreshAdminBtn) refreshAdminBtn.onclick = () => window.refreshAdmin();

  window.refreshAdmin = async () => {
      sfx.play('click');
      const snap = await getDocs(collection(db, "users"));
      const users = [];
      snap.forEach(d => users.push({id: d.id, ...d.data()}));

      const total = users.length;
      const pro = users.filter(u=>u.isPro).length;
      const master = users.filter(u=>u.isMaster).length;
      const free = total - pro - master;

      document.getElementById("dashTotal").innerText = total;
      document.getElementById("dashPro").innerText = pro;
      const active7 = users.filter(u=> u.lastActive && (u.lastActive.toDate ? u.lastActive.toDate() : new Date(u.lastActive.seconds*1000)) > new Date(Date.now()-86400000*7)).length;
      document.getElementById("dashActive").innerText = active7;

      const chart = document.getElementById("tierChart");
      if(chart) {
          const pFree = total > 0 ? (free/total)*100 : 0;
          const pPro = total > 0 ? (pro/total)*100 : 0;
          const pMaster = total > 0 ? (master/total)*100 : 0;
          chart.innerHTML = `
            <div class="chart-bar" style="width:${pFree}%; background:#444"></div>
            <div class="chart-bar" style="width:${pPro}%; background:#6366f1"></div>
            <div class="chart-bar" style="width:${pMaster}%; background:#ffd700"></div>
          `;
      }

      const listDiv = document.getElementById("admUserList");
      listDiv.innerHTML = "";
      users.forEach(u => {
          const el = document.createElement("div");
          el.className = "admin-card";
          el.style.display = "flex"; el.style.justifyContent = "space-between";
          el.innerHTML = `
              <div>
                  <b>${u.email || "-"}</b> <span style="font-size:11px; color:#aaa;">${u.id.slice(0,5)}</span><br>
                  <span style="font-size:12px;">${u.isPro?"PRO":"FREE"} | ${u.isBanned?"BANNED":"ACTIVE"}</span>
              </div>
              <button class="btn" style="font-size:11px; height:30px; width:auto;" onclick="togglePro('${u.id}', ${!!u.isPro})">ë“±ê¸‰ë³€ê²½</button>
          `;
          listDiv.appendChild(el);
      });
  };

  window.togglePro = async (uid, current) => {
      await updateDoc(doc(db,"users",uid), {isPro: !current});
      window.refreshAdmin();
  };

  window.godModeGift = async () => {
      sfx.play('adminOpen');
      if(!confirm("ì „ì²´ ìœ ì €ì—ê²Œ 100 ì½”ì¸ì„ ì„ ë¬¼í•©ë‹ˆê¹Œ?")) return;
      const snap = await getDocs(collection(db, "users"));
      const tasks = [];
      snap.forEach(d => {
        tasks.push(updateDoc(doc(db,"users",d.id), { coins: (d.data().coins||0)+100 }));
      });
      await Promise.allSettled(tasks);
      alert("ì„ ë¬¼ ì™„ë£Œ!");
      window.refreshAdmin();
  };

  window.godModeBroadcast = async () => {
      const msg = document.getElementById("broadcastInput").value;
      if(!msg) return;
      sfx.play('adminOpen');
      await setDoc(doc(db, "config", "broadcast"), { message: msg, timestamp: new Date() });
      alert("ì „ì†¡ë¨");
  };

  window.exportCSV = () => {
      getDocs(collection(db,"users")).then(s => {
          let csvContent = "data:text/csv;charset=utf-8,UID,Email,Level,Coins,IsPro\n";
          s.forEach(d => {
              const u = d.data();
              csvContent += `${d.id},${u.email},${u.level||1},${u.coins||0},${u.isPro||false}\n`;
          });
          const encodedUri = encodeURI(csvContent);
          const link = document.createElement("a");
          link.setAttribute("href", encodedUri);
          link.setAttribute("download", "habitflow_users.csv");
          document.body.appendChild(link);
          link.click();
          link.remove();
      });
  };

  // =========================================================
  // Auth Buttons (íšŒì›ê°€ì…/ë¡œê·¸ì¸/ë¦¬ì…‹) - ëˆ„ë½ë˜ì–´ ìˆë˜ ë¶€ë¶„ ë³µêµ¬
  // =========================================================
  document.getElementById("signupBtn").onclick = async () => {
    try{
      sfx.play('click');
      const email = document.getElementById("email").value.trim();
      const password = document.getElementById("password").value.trim();
      if(!email || !password) return alert("ì´ë©”ì¼/ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
      const cred = await createUserWithEmailAndPassword(auth, email, password);
      await sendEmailVerification(cred.user);
      alert("âœ… íšŒì›ê°€ì… ì™„ë£Œ! ì´ë©”ì¼ ì¸ì¦ í›„ ë¡œê·¸ì¸í•˜ì„¸ìš”.");
      await signOut(auth);
    } catch(e){
      alert(e?.message || "íšŒì›ê°€ì… ì‹¤íŒ¨");
    }
  };

  document.getElementById("signinBtn").onclick = async () => {
    try{
      sfx.play('click');
      const email = document.getElementById("email").value.trim();
      const password = document.getElementById("password").value.trim();
      if(!email || !password) return alert("ì´ë©”ì¼/ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
      await signInWithEmailAndPassword(auth, email, password);
    } catch(e){
      alert(e?.message || "ë¡œê·¸ì¸ ì‹¤íŒ¨");
    }
  };

  document.getElementById("logoutBtn").onclick = async () => {
    sfx.play('click');
    await signOut(auth);
  };

  document.getElementById("resetPwBtn").onclick = async () => {
    try{
      sfx.play('click');
      const email = document.getElementById("email").value.trim();
      if(!email) return alert("ì´ë©”ì¼ì„ ë¨¼ì € ì…ë ¥í•˜ì„¸ìš”.");
      await sendPasswordResetEmail(auth, email);
      alert("ğŸ“© ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì • ë©”ì¼ì„ ë³´ëƒˆì–´ìš”.");
    } catch(e){
      alert(e?.message || "ìš”ì²­ ì‹¤íŒ¨");
    }
  };

</script>
</body>
</html>
